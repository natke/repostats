[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1576309353",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1576309353",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1576309353,
        "node_id": "IC_kwDOCVq1mM5d9JJp",
        "user": {
            "login": "cmelody999",
            "id": 5425469,
            "node_id": "MDQ6VXNlcjU0MjU0Njk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5425469?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cmelody999",
            "html_url": "https://github.com/cmelody999",
            "followers_url": "https://api.github.com/users/cmelody999/followers",
            "following_url": "https://api.github.com/users/cmelody999/following{/other_user}",
            "gists_url": "https://api.github.com/users/cmelody999/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/cmelody999/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/cmelody999/subscriptions",
            "organizations_url": "https://api.github.com/users/cmelody999/orgs",
            "repos_url": "https://api.github.com/users/cmelody999/repos",
            "events_url": "https://api.github.com/users/cmelody999/events{/privacy}",
            "received_events_url": "https://api.github.com/users/cmelody999/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-05T08:12:05Z",
        "updated_at": "2023-06-05T08:14:12Z",
        "author_association": "NONE",
        "body": "We removed the ReduceMean operator and replaced it with an operator that randomly initializes a Gaussian normal distribution vector. The similarity score got worse, and turning on NNAPI still crashes the same. \r\nThe result of running check_onnx_model_mobile_usability is that the model should perform well with NNAPI as is: YES (1 partitions with a total of 163/163 nodes can be handled by the NNAPI EP).",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1576309353/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1576793769",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1576793769",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1576793769,
        "node_id": "IC_kwDOCVq1mM5d-_ap",
        "user": {
            "login": "wejoncy",
            "id": 9417365,
            "node_id": "MDQ6VXNlcjk0MTczNjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9417365?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/wejoncy",
            "html_url": "https://github.com/wejoncy",
            "followers_url": "https://api.github.com/users/wejoncy/followers",
            "following_url": "https://api.github.com/users/wejoncy/following{/other_user}",
            "gists_url": "https://api.github.com/users/wejoncy/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/wejoncy/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/wejoncy/subscriptions",
            "organizations_url": "https://api.github.com/users/wejoncy/orgs",
            "repos_url": "https://api.github.com/users/wejoncy/repos",
            "events_url": "https://api.github.com/users/wejoncy/events{/privacy}",
            "received_events_url": "https://api.github.com/users/wejoncy/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-05T13:20:58Z",
        "updated_at": "2023-06-05T13:20:58Z",
        "author_association": "MEMBER",
        "body": "![image](https://github.com/microsoft/onnxruntime/assets/9417365/4b0eb10e-1313-4eaa-9def-c29dd951790b)\r\n![image](https://github.com/microsoft/onnxruntime/assets/9417365/ea449b22-620a-42d4-ac30-168f19f241a3)\r\n\r\nThe last Gather Op, indice shouldn't be a constant scalar.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1576793769/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578036185",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1578036185",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1578036185,
        "node_id": "IC_kwDOCVq1mM5eDuvZ",
        "user": {
            "login": "cmelody999",
            "id": 5425469,
            "node_id": "MDQ6VXNlcjU0MjU0Njk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5425469?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cmelody999",
            "html_url": "https://github.com/cmelody999",
            "followers_url": "https://api.github.com/users/cmelody999/followers",
            "following_url": "https://api.github.com/users/cmelody999/following{/other_user}",
            "gists_url": "https://api.github.com/users/cmelody999/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/cmelody999/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/cmelody999/subscriptions",
            "organizations_url": "https://api.github.com/users/cmelody999/orgs",
            "repos_url": "https://api.github.com/users/cmelody999/repos",
            "events_url": "https://api.github.com/users/cmelody999/events{/privacy}",
            "received_events_url": "https://api.github.com/users/cmelody999/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-06T07:00:25Z",
        "updated_at": "2023-06-06T07:00:25Z",
        "author_association": "NONE",
        "body": "How should we modify the model to solve this crashï¼ŸThank you very much.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578036185/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578135036",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1578135036",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1578135036,
        "node_id": "IC_kwDOCVq1mM5eEG38",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-06T08:02:44Z",
        "updated_at": "2023-06-06T08:02:44Z",
        "author_association": "MEMBER",
        "body": "Whatever is responsible for the last Gather in the ONNX model is most likely using a scalar with value 0 for the indices instead of an array with a single entry of value 0. That Gather node is selecting the output for unnorm_image_features.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578135036/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578180108",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1578180108",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1578180108,
        "node_id": "IC_kwDOCVq1mM5eER4M",
        "user": {
            "login": "wejoncy",
            "id": 9417365,
            "node_id": "MDQ6VXNlcjk0MTczNjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9417365?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/wejoncy",
            "html_url": "https://github.com/wejoncy",
            "followers_url": "https://api.github.com/users/wejoncy/followers",
            "following_url": "https://api.github.com/users/wejoncy/following{/other_user}",
            "gists_url": "https://api.github.com/users/wejoncy/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/wejoncy/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/wejoncy/subscriptions",
            "organizations_url": "https://api.github.com/users/wejoncy/orgs",
            "repos_url": "https://api.github.com/users/wejoncy/repos",
            "events_url": "https://api.github.com/users/wejoncy/events{/privacy}",
            "received_events_url": "https://api.github.com/users/wejoncy/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-06T08:29:53Z",
        "updated_at": "2023-06-06T08:29:53Z",
        "author_association": "MEMBER",
        "body": "> Whatever is responsible for the last Gather in the ONNX model is most likely using a scalar with value 0 for the indices instead of an array with a single entry of value 0. That Gather node is selecting the output for unnorm_image_features.\r\n\r\nNNAPI EP doesnt't handle scalar `indices`",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578180108/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578184021",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1578184021",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1578184021,
        "node_id": "IC_kwDOCVq1mM5eES1V",
        "user": {
            "login": "wejoncy",
            "id": 9417365,
            "node_id": "MDQ6VXNlcjk0MTczNjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9417365?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/wejoncy",
            "html_url": "https://github.com/wejoncy",
            "followers_url": "https://api.github.com/users/wejoncy/followers",
            "following_url": "https://api.github.com/users/wejoncy/following{/other_user}",
            "gists_url": "https://api.github.com/users/wejoncy/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/wejoncy/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/wejoncy/subscriptions",
            "organizations_url": "https://api.github.com/users/wejoncy/orgs",
            "repos_url": "https://api.github.com/users/wejoncy/repos",
            "events_url": "https://api.github.com/users/wejoncy/events{/privacy}",
            "received_events_url": "https://api.github.com/users/wejoncy/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-06T08:31:27Z",
        "updated_at": "2023-06-06T08:31:27Z",
        "author_association": "MEMBER",
        "body": "> How should we modify the model to solve this crashï¼ŸThank you very much.\r\n\r\n```\r\nmodel=onnx.load('xxx/image.onnx')\r\n\r\n\r\nfor node in model.graph.node:\r\n    if node.output[0] == 'onnx::Gather_703':\r\n        del node.attribute[0]\r\n        node.attribute.append(good_attr)\r\n        onnx.save(model, 'xxx/image1.onnx')\r\n    if node.output[0] == 'onnx::Gather_623':\r\n        good_attr = node.attribute[0]\r\n```",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578184021/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578312924",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1578312924",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1578312924,
        "node_id": "IC_kwDOCVq1mM5eEyTc",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-06T09:47:47Z",
        "updated_at": "2023-06-06T09:47:47Z",
        "author_association": "MEMBER",
        "body": "> NNAPI EP doesn't handle scalar `indices`\r\n\r\nI was mainly suggesting it would be better to fix the pytorch model rather than hacking the exported onnx model. As it's only the very last Gather it should be relatively easy to narrow down where in the original model that is coming from. ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1578312924/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1579832921",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1579832921",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1579832921,
        "node_id": "IC_kwDOCVq1mM5eKlZZ",
        "user": {
            "login": "wejoncy",
            "id": 9417365,
            "node_id": "MDQ6VXNlcjk0MTczNjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9417365?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/wejoncy",
            "html_url": "https://github.com/wejoncy",
            "followers_url": "https://api.github.com/users/wejoncy/followers",
            "following_url": "https://api.github.com/users/wejoncy/following{/other_user}",
            "gists_url": "https://api.github.com/users/wejoncy/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/wejoncy/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/wejoncy/subscriptions",
            "organizations_url": "https://api.github.com/users/wejoncy/orgs",
            "repos_url": "https://api.github.com/users/wejoncy/repos",
            "events_url": "https://api.github.com/users/wejoncy/events{/privacy}",
            "received_events_url": "https://api.github.com/users/wejoncy/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-07T03:45:39Z",
        "updated_at": "2023-06-07T03:45:39Z",
        "author_association": "MEMBER",
        "body": "> > NNAPI EP doesn't handle scalar `indices`\r\n> \r\n> I was mainly suggesting it would be better to fix the pytorch model rather than hacking the exported onnx model. As it's only the very last Gather it should be relatively easy to narrow down where in the original model that is coming from.\r\n\r\nAccording to the ONNX spec, Gather `indices` is an array instead of scalar, it looks like a bug of exporter?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1579832921/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1580199051",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1580199051",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1580199051,
        "node_id": "IC_kwDOCVq1mM5eL-yL",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-07T08:33:30Z",
        "updated_at": "2023-06-07T08:33:30Z",
        "author_association": "MEMBER",
        "body": "Yeah - I don't think the exporter should emit `indices` as a scalar. That said, the ONNX spec has always been a little unclear about how/when a scalar (rank 0 with shape {}) and a single 1D value (rank 1 with shape {1}) are considered equivalent or interchangable.\r\n\r\nAdditionally the Reshape looks wrong based on symbolic_shape_infer output, but ironically that makes the ONNX shape inferencing pass. There's a Reshape to 50 x 1 x 1024 followed by the Gather with scalar indices and an output shape specified in the model of 1 x 1024 (i.e. the output shape is not inferred as it's a model output). Technically that is the correct shape as q==0 according to the [Gather spec](https://github.com/onnx/onnx/blob/main/docs/Operators.md#Gather) with the scalar indices, so a 3D input with 2D output is 'correct'. AFAIK that wouldn't be an expected usage of Gather though as it's really a Gather + Squeeze.\r\n\r\nI would think the more correct converter output would be a Reshape to 50 x 1024 and a Gather with 1D indices, but I don't know what the pytorch model code for that part of the conversion looked like to say how much that contributed to the issue.\r\n\r\n\r\n<img width=\"213\" alt=\"image\" src=\"https://github.com/microsoft/onnxruntime/assets/979079/b30ea766-e068-4575-9e70-055304496fcd\">\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1580199051/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1580276557",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1580276557",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1580276557,
        "node_id": "IC_kwDOCVq1mM5eMRtN",
        "user": {
            "login": "cmelody999",
            "id": 5425469,
            "node_id": "MDQ6VXNlcjU0MjU0Njk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5425469?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cmelody999",
            "html_url": "https://github.com/cmelody999",
            "followers_url": "https://api.github.com/users/cmelody999/followers",
            "following_url": "https://api.github.com/users/cmelody999/following{/other_user}",
            "gists_url": "https://api.github.com/users/cmelody999/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/cmelody999/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/cmelody999/subscriptions",
            "organizations_url": "https://api.github.com/users/cmelody999/orgs",
            "repos_url": "https://api.github.com/users/cmelody999/repos",
            "events_url": "https://api.github.com/users/cmelody999/events{/privacy}",
            "received_events_url": "https://api.github.com/users/cmelody999/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-07T09:17:23Z",
        "updated_at": "2023-06-07T09:17:23Z",
        "author_association": "NONE",
        "body": "![img_v2_18b7e9d9-ac77-4825-b1be-3c8bf4a0a23g](https://github.com/microsoft/onnxruntime/assets/5425469/ef7676f1-0e28-405f-a08e-81b36bb1b82f)\r\nThere is no problem with the onnx model on pc, and in the screenshot is the definition of the indices of the gather operator.\r\nHow to modify this constant_252 operator?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1580276557/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1580627953",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1580627953",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1580627953,
        "node_id": "IC_kwDOCVq1mM5eNnfx",
        "user": {
            "login": "wejoncy",
            "id": 9417365,
            "node_id": "MDQ6VXNlcjk0MTczNjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9417365?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/wejoncy",
            "html_url": "https://github.com/wejoncy",
            "followers_url": "https://api.github.com/users/wejoncy/followers",
            "following_url": "https://api.github.com/users/wejoncy/following{/other_user}",
            "gists_url": "https://api.github.com/users/wejoncy/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/wejoncy/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/wejoncy/subscriptions",
            "organizations_url": "https://api.github.com/users/wejoncy/orgs",
            "repos_url": "https://api.github.com/users/wejoncy/repos",
            "events_url": "https://api.github.com/users/wejoncy/events{/privacy}",
            "received_events_url": "https://api.github.com/users/wejoncy/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-07T11:46:05Z",
        "updated_at": "2023-06-07T11:46:40Z",
        "author_association": "MEMBER",
        "body": "> ![img_v2_18b7e9d9-ac77-4825-b1be-3c8bf4a0a23g](https://user-images.githubusercontent.com/5425469/243996460-ef7676f1-0e28-405f-a08e-81b36bb1b82f.jpg) There is no problem with the onnx model on pc, and in the screenshot is the definition of the indices of the gather operator. How to modify this constant_252 operator?\r\n\r\nMy code pasted above should workaround this issue temprorary.  To replace this scalar Indices with a correct one.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1580627953/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1580641002",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1580641002",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1580641002,
        "node_id": "IC_kwDOCVq1mM5eNqrq",
        "user": {
            "login": "wejoncy",
            "id": 9417365,
            "node_id": "MDQ6VXNlcjk0MTczNjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9417365?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/wejoncy",
            "html_url": "https://github.com/wejoncy",
            "followers_url": "https://api.github.com/users/wejoncy/followers",
            "following_url": "https://api.github.com/users/wejoncy/following{/other_user}",
            "gists_url": "https://api.github.com/users/wejoncy/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/wejoncy/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/wejoncy/subscriptions",
            "organizations_url": "https://api.github.com/users/wejoncy/orgs",
            "repos_url": "https://api.github.com/users/wejoncy/repos",
            "events_url": "https://api.github.com/users/wejoncy/events{/privacy}",
            "received_events_url": "https://api.github.com/users/wejoncy/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-07T11:51:08Z",
        "updated_at": "2023-06-07T11:51:08Z",
        "author_association": "MEMBER",
        "body": "> Yeah - I don't think the exporter should emit `indices` as a scalar. That said, the ONNX spec has always been a little unclear about how/when a scalar (rank 0 with shape {}) and a single 1D value (rank 1 with shape {1}) are considered equivalent or interchangable.\r\n> \r\n> Additionally the Reshape looks wrong based on symbolic_shape_infer output, but ironically that makes the ONNX shape inferencing pass. There's a Reshape to 50 x 1 x 1024 followed by the Gather with scalar indices and an output shape specified in the model of 1 x 1024 (i.e. the output shape is not inferred as it's a model output). Technically that is the correct shape as q==0 according to the [Gather spec](https://github.com/onnx/onnx/blob/main/docs/Operators.md#Gather) with the scalar indices, so a 3D input with 2D output is 'correct'. AFAIK that wouldn't be an expected usage of Gather though as it's really a Gather + Squeeze.\r\n> \r\n> I would think the more correct converter output would be a Reshape to 50 x 1024 and a Gather with 1D indices, but I don't know what the pytorch model code for that part of the conversion looked like to say how much that contributed to the issue.\r\n> \r\n> <img alt=\"image\" width=\"213\" src=\"https://user-images.githubusercontent.com/979079/243976898-b30ea766-e068-4575-9e70-055304496fcd.png\">\r\n\r\nIt seems quite reasonable in the code for the last `Gather`.\r\n\r\nhttps://github.com/OFA-Sys/Chinese-CLIP/blob/2c38d03557e50eadc72972b272cebf840dbc34ea/cn_clip/clip/model.py#LL103C16-L104C1",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1580641002/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1581761015",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1581761015",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1581761015,
        "node_id": "IC_kwDOCVq1mM5eR8H3",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-08T01:38:13Z",
        "updated_at": "2023-06-08T01:38:13Z",
        "author_association": "MEMBER",
        "body": "If the `x[0]` is a resulting in the Reshape + Gather it doesn't seem like the best option as the alternative would be to not add the Reshape from 50 x 1024 to 50 x 1 x 1024 and to instead do the Gather with indices shape {1} on the output from the GEMM.\r\n\r\nIf we think this usage of Gather is a valid pattern we could try and support it in NNAPI by converting the scalar indices value to a 1D input and add a Squeeze of `axis` to remove that dim from the output. ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1581761015/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1581847249",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1581847249",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1581847249,
        "node_id": "IC_kwDOCVq1mM5eSRLR",
        "user": {
            "login": "wejoncy",
            "id": 9417365,
            "node_id": "MDQ6VXNlcjk0MTczNjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9417365?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/wejoncy",
            "html_url": "https://github.com/wejoncy",
            "followers_url": "https://api.github.com/users/wejoncy/followers",
            "following_url": "https://api.github.com/users/wejoncy/following{/other_user}",
            "gists_url": "https://api.github.com/users/wejoncy/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/wejoncy/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/wejoncy/subscriptions",
            "organizations_url": "https://api.github.com/users/wejoncy/orgs",
            "repos_url": "https://api.github.com/users/wejoncy/repos",
            "events_url": "https://api.github.com/users/wejoncy/events{/privacy}",
            "received_events_url": "https://api.github.com/users/wejoncy/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-08T03:48:20Z",
        "updated_at": "2023-06-08T03:48:20Z",
        "author_association": "MEMBER",
        "body": "> If the `x[0]` is a resulting in the Reshape + Gather it doesn't seem like the best option as the alternative would be to not add the Reshape from 50 x 1024 to 50 x 1 x 1024 and to instead do the Gather with indices shape {1} on the output from the GEMM.\r\n> \r\n> If we think this usage of Gather is a valid pattern we could try and support it in NNAPI by converting the scalar indices value to a 1D input and add a Squeeze of `axis` to remove that dim from the output.\r\n\r\n\r\n`x[0]` is equivant of  Gather with scalar indices.\r\n`x[[0]]` is resulting Gather + tensor indices.\r\n`Reshape` is the result of `multi_head_attention_forward`. \r\nIt's easy to be reproduced by \r\n```\r\nfrom torch import nn\r\n\r\nclass AttentionPool2d(nn.Module):\r\n    def __init__(self):\r\n        super().__init__()\r\n\r\n    def forward(self, x):\r\n        return x[[0]]\r\n\r\nmodel = AttentionPool2d().cuda()\r\ninput_names = [ \"x\" ]\r\noutput_names = [ \"output1\" ]\r\ndummy_input = torch.randn(1, 3, 8, 8, device=\"cuda\")\r\ntorch.onnx.export(model, dummy_input, \"att.onnx\", verbose=True, opset_version=14, input_names=input_names, output_names=output_names)\r\n```\r\n\r\nNot sure if it's expected in onnx exporter.\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1581847249/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1584088795",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1584088795",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1584088795,
        "node_id": "IC_kwDOCVq1mM5ea0bb",
        "user": {
            "login": "cmelody999",
            "id": 5425469,
            "node_id": "MDQ6VXNlcjU0MjU0Njk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5425469?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cmelody999",
            "html_url": "https://github.com/cmelody999",
            "followers_url": "https://api.github.com/users/cmelody999/followers",
            "following_url": "https://api.github.com/users/cmelody999/following{/other_user}",
            "gists_url": "https://api.github.com/users/cmelody999/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/cmelody999/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/cmelody999/subscriptions",
            "organizations_url": "https://api.github.com/users/cmelody999/orgs",
            "repos_url": "https://api.github.com/users/cmelody999/repos",
            "events_url": "https://api.github.com/users/cmelody999/events{/privacy}",
            "received_events_url": "https://api.github.com/users/cmelody999/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-09T07:13:29Z",
        "updated_at": "2023-06-09T08:00:54Z",
        "author_association": "NONE",
        "body": "We modified the last gather Op as suggested and turned on NNAPI without crashing. But the model inference time has become longer after NNAPI is turned on, and it has increased several times.\r\n\r\nModel inference time spent with NNAPI off:\r\n![img_v2_56af2ba3-a6b9-4509-9aad-b63d943b5afg](https://github.com/microsoft/onnxruntime/assets/5425469/c9fcb5ec-411a-47a4-ba6d-b49dd1c2c855)\r\n\r\nModel inference time spent with NNAPI on:\r\n![img_v2_7a80f6ad-36fa-4e09-8716-39bda7d1a32g](https://github.com/microsoft/onnxruntime/assets/5425469/9367c046-3d1a-4437-8569-d2ceba83a9b6)\r\n\r\nWe submitted the modified model of the last gather Op and the CreateSession log before and after turning on NNAPI:\r\nhttps://github.com/cmelody999/model\r\n![image](https://github.com/microsoft/onnxruntime/assets/5425469/7bd146a3-8555-44b0-b277-9b870ac673ee)\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1584088795/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1584193851",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/16224#issuecomment-1584193851",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/16224",
        "id": 1584193851,
        "node_id": "IC_kwDOCVq1mM5ebOE7",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-09T08:39:59Z",
        "updated_at": "2023-06-09T08:39:59Z",
        "author_association": "MEMBER",
        "body": "This is expected. Without the ReduceMean you have the cost of transferring from NPU back to CPU back to NPU in the middle of the model.\r\n\r\nAlso note that NNAPI performance is extremely device specific. The low-level implementation of the internal NNAPI API is done by the hardware vendors. If they have a poor implementation performance can be worse than CPU. If the hardware vendor has not implemented a specific operator NNAPI will fall back to a reference CPU implementation (i.e. the simplest implementation possible which is not optimized in any way). So even with the ReduceMean it's possible that on some devices NNAPI performance may be worse than CPU.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1584193851/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]