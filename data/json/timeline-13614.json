[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1313951408",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/13614#issuecomment-1313951408",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/13614",
        "id": 1313951408,
        "node_id": "IC_kwDOCVq1mM5OUU6w",
        "user": {
            "login": "umbertov",
            "id": 12353864,
            "node_id": "MDQ6VXNlcjEyMzUzODY0",
            "avatar_url": "https://avatars.githubusercontent.com/u/12353864?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/umbertov",
            "html_url": "https://github.com/umbertov",
            "followers_url": "https://api.github.com/users/umbertov/followers",
            "following_url": "https://api.github.com/users/umbertov/following{/other_user}",
            "gists_url": "https://api.github.com/users/umbertov/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/umbertov/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/umbertov/subscriptions",
            "organizations_url": "https://api.github.com/users/umbertov/orgs",
            "repos_url": "https://api.github.com/users/umbertov/repos",
            "events_url": "https://api.github.com/users/umbertov/events{/privacy}",
            "received_events_url": "https://api.github.com/users/umbertov/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-11-14T15:39:21Z",
        "updated_at": "2022-11-14T15:39:21Z",
        "author_association": "NONE",
        "body": "The relevant image loading code is here (`onnx_test.cpp` in the repo i posted):\r\n```cpp\r\n  cv::Mat input_image = cv::imread(input_file_p, cv::IMREAD_COLOR);\r\n  input_height = input_image.rows;\r\n  input_width = input_image.cols;\r\n  // Normalize image from uint8 in [0-255] to float in [0-1]: \r\n  int64_t input_size = 3*input_height*input_width;\r\n  float * model_input = (float*) calloc(input_size, sizeof(float));\r\n  assert(model_input != NULL);\r\n  mat_hwc2chw(input_image, model_input, input_size);\r\n```\r\nWhere the `mat_hwc2chw` is defined as follows:\r\n```cpp\r\n// Create expected ORT format (channel blocks by row): https://answers.opencv.org/question/64837\r\nvoid mat_hwc2chw(cv::Mat image_bgr, float *input_tensor_values, int64_t input_tensor_size) {\r\n    LOG(\"doing mat hwc2chw\")\r\n    std::vector<cv::Mat> channels;\r\n    cv::Mat image_by_channel;\r\n\r\n    LOG(\"split\")\r\n    cv::split(image_bgr, channels);\r\n\r\n    LOG(\"building image_by_channel\")\r\n    for (size_t i=0; i<channels.size(); i++) {\r\n        image_by_channel.push_back(channels[i]);\r\n    }\r\n    if (!image_by_channel.isContinuous()) {\r\n        LOG(\"making continuous\")\r\n        image_by_channel = image_by_channel.clone();\r\n    }\r\n    LOG(\"dividing values\")\r\n    for (size_t i = 0; i < input_tensor_size; i++) {\r\n        input_tensor_values[i] = image_by_channel.data[i] / 255.0;\r\n    }\r\n}\r\n```\r\n\r\nThe given buffer is then used as input for `CreateTensorWithDataAsOrtValue` which should not affect its contents.\r\n\r\nAfter inference, image saving is done as follows:\r\n```cpp\r\n\r\n/**\r\n * \\param tensor should be a float tensor in [N,C,H,W] format\r\n */\r\nstatic int write_tensor_to_img_file(OrtValue *tensor, const char *output_file) {\r\n  struct OrtTensorTypeAndShapeInfo *shape_info;\r\n  ORT_ABORT_ON_ERROR(g_ort->GetTensorTypeAndShape(tensor, &shape_info));\r\n  size_t dim_count;\r\n  ORT_ABORT_ON_ERROR(g_ort->GetDimensionsCount(shape_info, &dim_count));\r\n  if (dim_count != 4) {\r\n    printf(\"output tensor must have 4 dimensions\");\r\n    return -1;\r\n  }\r\n  int64_t dims[4];\r\n  ORT_ABORT_ON_ERROR(\r\n      g_ort->GetDimensions(shape_info, dims, sizeof(dims) / sizeof(dims[0])));\r\n  if (dims[0] != 1 || dims[1] != 3) {\r\n    printf(\"output tensor shape error\");\r\n    return -1;\r\n  }\r\n  float *tensor_ptr;\r\n  ORT_ABORT_ON_ERROR(g_ort->GetTensorMutableData(tensor, (void **)&tensor_ptr));\r\n  tensor_ptr = chw_to_hwc(tensor_ptr, dims[2], dims[3]);\r\n  cv::Mat out_img = mat_from_buffer<float>(tensor_ptr, dims[2], dims[3]);\r\n  cv::Mat out_img_uint;\r\n  out_img.convertTo(out_img_uint, CV_8UC3, 255.0);\r\n\r\n  cv::imwrite(output_file, out_img_uint);\r\n\r\n  return 0;\r\n}\r\n\r\n```\r\n\r\nWhere the `OrtValue` comes from the output tensor which is written during inference.\r\n\r\nJust leaving this info here so its more handy than having to peek into the repo.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1313951408/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "umbertov",
            "id": 12353864,
            "node_id": "MDQ6VXNlcjEyMzUzODY0",
            "avatar_url": "https://avatars.githubusercontent.com/u/12353864?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/umbertov",
            "html_url": "https://github.com/umbertov",
            "followers_url": "https://api.github.com/users/umbertov/followers",
            "following_url": "https://api.github.com/users/umbertov/following{/other_user}",
            "gists_url": "https://api.github.com/users/umbertov/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/umbertov/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/umbertov/subscriptions",
            "organizations_url": "https://api.github.com/users/umbertov/orgs",
            "repos_url": "https://api.github.com/users/umbertov/repos",
            "events_url": "https://api.github.com/users/umbertov/events{/privacy}",
            "received_events_url": "https://api.github.com/users/umbertov/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1317440527",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/13614#issuecomment-1317440527",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/13614",
        "id": 1317440527,
        "node_id": "IC_kwDOCVq1mM5OhowP",
        "user": {
            "login": "yuslepukhin",
            "id": 11303988,
            "node_id": "MDQ6VXNlcjExMzAzOTg4",
            "avatar_url": "https://avatars.githubusercontent.com/u/11303988?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yuslepukhin",
            "html_url": "https://github.com/yuslepukhin",
            "followers_url": "https://api.github.com/users/yuslepukhin/followers",
            "following_url": "https://api.github.com/users/yuslepukhin/following{/other_user}",
            "gists_url": "https://api.github.com/users/yuslepukhin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yuslepukhin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yuslepukhin/subscriptions",
            "organizations_url": "https://api.github.com/users/yuslepukhin/orgs",
            "repos_url": "https://api.github.com/users/yuslepukhin/repos",
            "events_url": "https://api.github.com/users/yuslepukhin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yuslepukhin/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-11-16T18:07:08Z",
        "updated_at": "2022-11-17T19:11:39Z",
        "author_association": "MEMBER",
        "body": "Thank you for reporting the issue. Visually, it is hard to quantify the differences.  Would it be possible for you to outline the numerical differences on the outputs, and what are your targets for absolute and/or relative discrepancies?\r\n\r\nOnnxruntime Python API does *not* have its own implementation, it calls into the same C++ code as the C++ API.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1317440527/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "yuslepukhin",
            "id": 11303988,
            "node_id": "MDQ6VXNlcjExMzAzOTg4",
            "avatar_url": "https://avatars.githubusercontent.com/u/11303988?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yuslepukhin",
            "html_url": "https://github.com/yuslepukhin",
            "followers_url": "https://api.github.com/users/yuslepukhin/followers",
            "following_url": "https://api.github.com/users/yuslepukhin/following{/other_user}",
            "gists_url": "https://api.github.com/users/yuslepukhin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yuslepukhin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yuslepukhin/subscriptions",
            "organizations_url": "https://api.github.com/users/yuslepukhin/orgs",
            "repos_url": "https://api.github.com/users/yuslepukhin/repos",
            "events_url": "https://api.github.com/users/yuslepukhin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yuslepukhin/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1320064239",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/13614#issuecomment-1320064239",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/13614",
        "id": 1320064239,
        "node_id": "IC_kwDOCVq1mM5OrpTv",
        "user": {
            "login": "umbertov",
            "id": 12353864,
            "node_id": "MDQ6VXNlcjEyMzUzODY0",
            "avatar_url": "https://avatars.githubusercontent.com/u/12353864?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/umbertov",
            "html_url": "https://github.com/umbertov",
            "followers_url": "https://api.github.com/users/umbertov/followers",
            "following_url": "https://api.github.com/users/umbertov/following{/other_user}",
            "gists_url": "https://api.github.com/users/umbertov/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/umbertov/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/umbertov/subscriptions",
            "organizations_url": "https://api.github.com/users/umbertov/orgs",
            "repos_url": "https://api.github.com/users/umbertov/repos",
            "events_url": "https://api.github.com/users/umbertov/events{/privacy}",
            "received_events_url": "https://api.github.com/users/umbertov/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-11-18T14:25:27Z",
        "updated_at": "2022-11-18T14:26:08Z",
        "author_association": "NONE",
        "body": "@yuslepukhin Hi, thanks for the answer. I'll first show the difference visually, then i'll provide some numbers at the end of the post.\r\n\r\nI'm posting here an image which represent the absolute value of the difference between the two images:\r\n![image](https://user-images.githubusercontent.com/12353864/202720380-73ae0214-2544-4ab5-bcc8-9bb776940279.png)\r\n\r\nIt was obtained using the following very simple python script which loads both images, computes their absolute difference (after casting them to floats because using uint8 would result in integer overflows), and saves the result:\r\n```python\r\nfrom PIL import Image\r\nimport numpy as np\r\n\r\ndef pil_loader(path: str) -> Image.Image:\r\n    # from torchvision/datasets/folder.py\r\n    with open(path, \"rb\") as f:\r\n        img = Image.open(f)\r\n        return img.convert(\"RGB\")\r\n\r\n# load images as uint8 in 0-255\r\ncat1 = pil_loader(\"/tmp/issue/cat1.png\")\r\ncat2 = pil_loader(\"/tmp/issue/cat2.png\")\r\n# cast to float in 0-255\r\nimg1 = np.asarray(cat1, dtype=float)\r\nimg2 = np.asarray(cat2, dtype=float)\r\n\r\n# absolute difference\r\nabsdiff = abs(img1 - img2)\r\nImage.fromarray(absdiff.astype(np.uint8)).save(\"~/Pictures/absdiff.png\")\r\n\r\n# minmax-scaled version\r\nabsdiff_scaled = 255*(absdiff / (absdiff.max() - absdiff.min()))\r\nImage.fromarray(absdiff_scaled.astype(np.uint8)).save(\"/home/umberto/Pictures/absdiff_scaled.png\")\r\n```\r\n\r\nSince it might be difficult to look at the absolute difference, i also attach a minmax-scaled version of it:\r\n\r\n![image](https://user-images.githubusercontent.com/12353864/202721571-e570aa9d-bbb2-4454-a063-7114d46c5caa.png)\r\n\r\nAs you can see, the difference is there; it's not overwhelming, but it's present and even quite large in some cases.\r\n\r\n\r\n>  Would it be possible for you to outline the numerical differences on the outputs [...]\r\n\r\nYes, using the code above, i report to you the mean absolute difference (`absdiff.mean()`) which is about `2.56`, with a standard deviation (`absdiff.std()`) of about `2.71`. (all values are calculated using images in the 0-255 range)\r\n\r\nThe maximum difference is `49` in this example; many pixels (more than 300 of them) have a difference larger than 30 (!) between C++ and Python code, which is quite a lot. So i'm quite sure something is going on.\r\n\r\n\r\n> what are your targets for absolute and/or relative discrepancies?\r\n\r\nIdeally, the same exact result can be reproduced using C++ or Python code; since all Python does is call into the C++ ONNX API, the difference must lie in how the images are loaded and/or saved? However my pre/post-processing seems pretty standard, do you see any obvious issue with that? I don't seem to: i tried skipping the ONNX inference, and just load the image, write it to a ONNX tensor, copy into another one, and write it back to disk; the resulting image was identical to the source one, which baffles me.\r\n\r\nPost-scriptum: in Python, loading images with PIL or with OpenCV yields NO difference; that's something i thought might be the problem, but it turns out it is not.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1320064239/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "umbertov",
            "id": 12353864,
            "node_id": "MDQ6VXNlcjEyMzUzODY0",
            "avatar_url": "https://avatars.githubusercontent.com/u/12353864?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/umbertov",
            "html_url": "https://github.com/umbertov",
            "followers_url": "https://api.github.com/users/umbertov/followers",
            "following_url": "https://api.github.com/users/umbertov/following{/other_user}",
            "gists_url": "https://api.github.com/users/umbertov/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/umbertov/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/umbertov/subscriptions",
            "organizations_url": "https://api.github.com/users/umbertov/orgs",
            "repos_url": "https://api.github.com/users/umbertov/repos",
            "events_url": "https://api.github.com/users/umbertov/events{/privacy}",
            "received_events_url": "https://api.github.com/users/umbertov/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "id": 7844298219,
        "node_id": "MEE_lADOCVq1mM5WDqQKzwAAAAHTjn3r",
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/events/7844298219",
        "actor": {
            "login": "yuslepukhin",
            "id": 11303988,
            "node_id": "MDQ6VXNlcjExMzAzOTg4",
            "avatar_url": "https://avatars.githubusercontent.com/u/11303988?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yuslepukhin",
            "html_url": "https://github.com/yuslepukhin",
            "followers_url": "https://api.github.com/users/yuslepukhin/followers",
            "following_url": "https://api.github.com/users/yuslepukhin/following{/other_user}",
            "gists_url": "https://api.github.com/users/yuslepukhin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yuslepukhin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yuslepukhin/subscriptions",
            "organizations_url": "https://api.github.com/users/yuslepukhin/orgs",
            "repos_url": "https://api.github.com/users/yuslepukhin/repos",
            "events_url": "https://api.github.com/users/yuslepukhin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yuslepukhin/received_events",
            "type": "User",
            "site_admin": false
        },
        "event": "mentioned",
        "commit_id": null,
        "commit_url": null,
        "created_at": "2022-11-18T14:25:28Z",
        "performed_via_github_app": null
    },
    {
        "id": 7844298232,
        "node_id": "SE_lADOCVq1mM5WDqQKzwAAAAHTjn34",
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/events/7844298232",
        "actor": {
            "login": "yuslepukhin",
            "id": 11303988,
            "node_id": "MDQ6VXNlcjExMzAzOTg4",
            "avatar_url": "https://avatars.githubusercontent.com/u/11303988?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yuslepukhin",
            "html_url": "https://github.com/yuslepukhin",
            "followers_url": "https://api.github.com/users/yuslepukhin/followers",
            "following_url": "https://api.github.com/users/yuslepukhin/following{/other_user}",
            "gists_url": "https://api.github.com/users/yuslepukhin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yuslepukhin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yuslepukhin/subscriptions",
            "organizations_url": "https://api.github.com/users/yuslepukhin/orgs",
            "repos_url": "https://api.github.com/users/yuslepukhin/repos",
            "events_url": "https://api.github.com/users/yuslepukhin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yuslepukhin/received_events",
            "type": "User",
            "site_admin": false
        },
        "event": "subscribed",
        "commit_id": null,
        "commit_url": null,
        "created_at": "2022-11-18T14:25:28Z",
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1336927079",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/13614#issuecomment-1336927079",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/13614",
        "id": 1336927079,
        "node_id": "IC_kwDOCVq1mM5Pr-Nn",
        "user": {
            "login": "seungtaek94",
            "id": 56434476,
            "node_id": "MDQ6VXNlcjU2NDM0NDc2",
            "avatar_url": "https://avatars.githubusercontent.com/u/56434476?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/seungtaek94",
            "html_url": "https://github.com/seungtaek94",
            "followers_url": "https://api.github.com/users/seungtaek94/followers",
            "following_url": "https://api.github.com/users/seungtaek94/following{/other_user}",
            "gists_url": "https://api.github.com/users/seungtaek94/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/seungtaek94/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/seungtaek94/subscriptions",
            "organizations_url": "https://api.github.com/users/seungtaek94/orgs",
            "repos_url": "https://api.github.com/users/seungtaek94/repos",
            "events_url": "https://api.github.com/users/seungtaek94/events{/privacy}",
            "received_events_url": "https://api.github.com/users/seungtaek94/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-12-05T08:12:20Z",
        "updated_at": "2022-12-05T23:30:47Z",
        "author_association": "NONE",
        "body": "I thing your c++ code doesn't swap the `B` and `R` channel in preprocessing.\r\n\r\nhttps://github.com/umbertov/onnx-sr-example/blob/414a38ee4c9191869808802974a8b0eb327fbb88/onnx_test.cpp#L69\r\n\r\nYour c++ code split BGR channel and just stacked with same sequence in [here](https://github.com/umbertov/onnx-sr-example/blob/414a38ee4c9191869808802974a8b0eb327fbb88/onnx_test.cpp#L73).",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1336927079/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "seungtaek94",
            "id": 56434476,
            "node_id": "MDQ6VXNlcjU2NDM0NDc2",
            "avatar_url": "https://avatars.githubusercontent.com/u/56434476?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/seungtaek94",
            "html_url": "https://github.com/seungtaek94",
            "followers_url": "https://api.github.com/users/seungtaek94/followers",
            "following_url": "https://api.github.com/users/seungtaek94/following{/other_user}",
            "gists_url": "https://api.github.com/users/seungtaek94/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/seungtaek94/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/seungtaek94/subscriptions",
            "organizations_url": "https://api.github.com/users/seungtaek94/orgs",
            "repos_url": "https://api.github.com/users/seungtaek94/repos",
            "events_url": "https://api.github.com/users/seungtaek94/events{/privacy}",
            "received_events_url": "https://api.github.com/users/seungtaek94/received_events",
            "type": "User",
            "site_admin": false
        }
    }
]