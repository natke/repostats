[
    {
        "id": 4620389054,
        "node_id": "MDEyOkxhYmVsZWRFdmVudDQ2MjAzODkwNTQ=",
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/events/4620389054",
        "actor": {
            "login": "liqunfu",
            "id": 3318051,
            "node_id": "MDQ6VXNlcjMzMTgwNTE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3318051?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/liqunfu",
            "html_url": "https://github.com/liqunfu",
            "followers_url": "https://api.github.com/users/liqunfu/followers",
            "following_url": "https://api.github.com/users/liqunfu/following{/other_user}",
            "gists_url": "https://api.github.com/users/liqunfu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/liqunfu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/liqunfu/subscriptions",
            "organizations_url": "https://api.github.com/users/liqunfu/orgs",
            "repos_url": "https://api.github.com/users/liqunfu/repos",
            "events_url": "https://api.github.com/users/liqunfu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/liqunfu/received_events",
            "type": "User",
            "site_admin": false
        },
        "event": "labeled",
        "commit_id": null,
        "commit_url": null,
        "created_at": "2021-04-20T16:44:58Z",
        "label": {
            "name": "ep:OpenVINO",
            "color": "bfdadc"
        },
        "performed_via_github_app": null
    },
    {
        "id": 4620396648,
        "node_id": "MDEyOkxhYmVsZWRFdmVudDQ2MjAzOTY2NDg=",
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/events/4620396648",
        "actor": {
            "login": "liqunfu",
            "id": 3318051,
            "node_id": "MDQ6VXNlcjMzMTgwNTE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3318051?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/liqunfu",
            "html_url": "https://github.com/liqunfu",
            "followers_url": "https://api.github.com/users/liqunfu/followers",
            "following_url": "https://api.github.com/users/liqunfu/following{/other_user}",
            "gists_url": "https://api.github.com/users/liqunfu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/liqunfu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/liqunfu/subscriptions",
            "organizations_url": "https://api.github.com/users/liqunfu/orgs",
            "repos_url": "https://api.github.com/users/liqunfu/repos",
            "events_url": "https://api.github.com/users/liqunfu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/liqunfu/received_events",
            "type": "User",
            "site_admin": false
        },
        "event": "labeled",
        "commit_id": null,
        "commit_url": null,
        "created_at": "2021-04-20T16:46:29Z",
        "label": {
            "name": "component:coreruntime",
            "color": "303a93"
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823554987",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7381#issuecomment-823554987",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7381",
        "id": 823554987,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzU1NDk4Nw==",
        "user": {
            "login": "yuslepukhin",
            "id": 11303988,
            "node_id": "MDQ6VXNlcjExMzAzOTg4",
            "avatar_url": "https://avatars.githubusercontent.com/u/11303988?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yuslepukhin",
            "html_url": "https://github.com/yuslepukhin",
            "followers_url": "https://api.github.com/users/yuslepukhin/followers",
            "following_url": "https://api.github.com/users/yuslepukhin/following{/other_user}",
            "gists_url": "https://api.github.com/users/yuslepukhin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yuslepukhin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yuslepukhin/subscriptions",
            "organizations_url": "https://api.github.com/users/yuslepukhin/orgs",
            "repos_url": "https://api.github.com/users/yuslepukhin/repos",
            "events_url": "https://api.github.com/users/yuslepukhin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yuslepukhin/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-20T19:47:25Z",
        "updated_at": "2021-04-20T19:51:02Z",
        "author_association": "MEMBER",
        "body": "Your stack traces for the allocations would be appreciated. One thing to avoid fragmentation is not to allocate in a loop Ort objects such Ort::Session and alike. Those objects are extremely small, and their purpose to act as smart pointers to prevent leaks. So wrapping them again into smart pointers does not make sense. It is not Java.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823554987/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "yuslepukhin",
            "id": 11303988,
            "node_id": "MDQ6VXNlcjExMzAzOTg4",
            "avatar_url": "https://avatars.githubusercontent.com/u/11303988?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yuslepukhin",
            "html_url": "https://github.com/yuslepukhin",
            "followers_url": "https://api.github.com/users/yuslepukhin/followers",
            "following_url": "https://api.github.com/users/yuslepukhin/following{/other_user}",
            "gists_url": "https://api.github.com/users/yuslepukhin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yuslepukhin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yuslepukhin/subscriptions",
            "organizations_url": "https://api.github.com/users/yuslepukhin/orgs",
            "repos_url": "https://api.github.com/users/yuslepukhin/repos",
            "events_url": "https://api.github.com/users/yuslepukhin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yuslepukhin/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823774754",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7381#issuecomment-823774754",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7381",
        "id": 823774754,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzc3NDc1NA==",
        "user": {
            "login": "PhilippPaetzold",
            "id": 23527944,
            "node_id": "MDQ6VXNlcjIzNTI3OTQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/23527944?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/PhilippPaetzold",
            "html_url": "https://github.com/PhilippPaetzold",
            "followers_url": "https://api.github.com/users/PhilippPaetzold/followers",
            "following_url": "https://api.github.com/users/PhilippPaetzold/following{/other_user}",
            "gists_url": "https://api.github.com/users/PhilippPaetzold/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/PhilippPaetzold/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/PhilippPaetzold/subscriptions",
            "organizations_url": "https://api.github.com/users/PhilippPaetzold/orgs",
            "repos_url": "https://api.github.com/users/PhilippPaetzold/repos",
            "events_url": "https://api.github.com/users/PhilippPaetzold/events{/privacy}",
            "received_events_url": "https://api.github.com/users/PhilippPaetzold/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-21T04:52:56Z",
        "updated_at": "2021-04-21T04:52:56Z",
        "author_association": "NONE",
        "body": "Only run is called in the loop. Session is created during initialization, of course. Why does calling the run fuction allocate heap memory? Btw. I am a C++ and C# guy :)\n________________________________\nFrom: Dmitri Smirnov ***@***.***>\nSent: Tuesday, April 20, 2021 9:47:44 PM\nTo: microsoft/onnxruntime ***@***.***>\nCc: PhilippPaetzold ***@***.***>; Author ***@***.***>\nSubject: Re: [microsoft/onnxruntime] Avoid allocations and memory leak in performance critical loop (#7381)\n\n\nYou stack traces for the allocations would be appreciated. One thing to avoid fragmentation is not to allocate in a loop Ort objects such Ort::Session and alike. Those objects are extremely small, and their purpose to act as smart pointers to prevent leaks. So wrapping them again into smart pointers does not make sense. It is not Java.\n\nâ€”\nYou are receiving this because you authored the thread.\nReply to this email directly, view it on GitHub<https://github.com/microsoft/onnxruntime/issues/7381#issuecomment-823554987>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/AFTQECH7LLG3D2I3MNVWC5LTJXK6BANCNFSM43IPGGHQ>.\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823774754/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "PhilippPaetzold",
            "id": 23527944,
            "node_id": "MDQ6VXNlcjIzNTI3OTQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/23527944?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/PhilippPaetzold",
            "html_url": "https://github.com/PhilippPaetzold",
            "followers_url": "https://api.github.com/users/PhilippPaetzold/followers",
            "following_url": "https://api.github.com/users/PhilippPaetzold/following{/other_user}",
            "gists_url": "https://api.github.com/users/PhilippPaetzold/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/PhilippPaetzold/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/PhilippPaetzold/subscriptions",
            "organizations_url": "https://api.github.com/users/PhilippPaetzold/orgs",
            "repos_url": "https://api.github.com/users/PhilippPaetzold/repos",
            "events_url": "https://api.github.com/users/PhilippPaetzold/events{/privacy}",
            "received_events_url": "https://api.github.com/users/PhilippPaetzold/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823780973",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7381#issuecomment-823780973",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7381",
        "id": 823780973,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzc4MDk3Mw==",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-21T05:11:22Z",
        "updated_at": "2021-04-21T05:11:22Z",
        "author_association": "MEMBER",
        "body": "How many allocations do you see if you use the CPU execution provided (EP)  instead of the OpenVINO EP? The ORT EPs generally use arenas to minimize system calls. Not sure what OpenVINO does internally though. \r\n\r\nLooking at a sample of the stack traces for some of the new/delete allocations you're intercepting would also be helpful to see which library they're coming from.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823780973/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823803743",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7381#issuecomment-823803743",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7381",
        "id": 823803743,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzgwMzc0Mw==",
        "user": {
            "login": "PhilippPaetzold",
            "id": 23527944,
            "node_id": "MDQ6VXNlcjIzNTI3OTQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/23527944?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/PhilippPaetzold",
            "html_url": "https://github.com/PhilippPaetzold",
            "followers_url": "https://api.github.com/users/PhilippPaetzold/followers",
            "following_url": "https://api.github.com/users/PhilippPaetzold/following{/other_user}",
            "gists_url": "https://api.github.com/users/PhilippPaetzold/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/PhilippPaetzold/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/PhilippPaetzold/subscriptions",
            "organizations_url": "https://api.github.com/users/PhilippPaetzold/orgs",
            "repos_url": "https://api.github.com/users/PhilippPaetzold/repos",
            "events_url": "https://api.github.com/users/PhilippPaetzold/events{/privacy}",
            "received_events_url": "https://api.github.com/users/PhilippPaetzold/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-21T06:09:37Z",
        "updated_at": "2021-04-21T06:09:37Z",
        "author_association": "NONE",
        "body": "@skottmckay Thanks for your reply. I will switch to CPU execution and get you the numbers and also provide some stack traces.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823803743/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "PhilippPaetzold",
            "id": 23527944,
            "node_id": "MDQ6VXNlcjIzNTI3OTQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/23527944?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/PhilippPaetzold",
            "html_url": "https://github.com/PhilippPaetzold",
            "followers_url": "https://api.github.com/users/PhilippPaetzold/followers",
            "following_url": "https://api.github.com/users/PhilippPaetzold/following{/other_user}",
            "gists_url": "https://api.github.com/users/PhilippPaetzold/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/PhilippPaetzold/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/PhilippPaetzold/subscriptions",
            "organizations_url": "https://api.github.com/users/PhilippPaetzold/orgs",
            "repos_url": "https://api.github.com/users/PhilippPaetzold/repos",
            "events_url": "https://api.github.com/users/PhilippPaetzold/events{/privacy}",
            "received_events_url": "https://api.github.com/users/PhilippPaetzold/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "id": 4622912302,
        "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50NDYyMjkxMjMwMg==",
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/events/4622912302",
        "actor": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "event": "mentioned",
        "commit_id": null,
        "commit_url": null,
        "created_at": "2021-04-21T06:09:37Z",
        "performed_via_github_app": null
    },
    {
        "id": 4622912303,
        "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDQ2MjI5MTIzMDM=",
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/events/4622912303",
        "actor": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "event": "subscribed",
        "commit_id": null,
        "commit_url": null,
        "created_at": "2021-04-21T06:09:37Z",
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823965558",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7381#issuecomment-823965558",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7381",
        "id": 823965558,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzk2NTU1OA==",
        "user": {
            "login": "PhilippPaetzold",
            "id": 23527944,
            "node_id": "MDQ6VXNlcjIzNTI3OTQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/23527944?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/PhilippPaetzold",
            "html_url": "https://github.com/PhilippPaetzold",
            "followers_url": "https://api.github.com/users/PhilippPaetzold/followers",
            "following_url": "https://api.github.com/users/PhilippPaetzold/following{/other_user}",
            "gists_url": "https://api.github.com/users/PhilippPaetzold/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/PhilippPaetzold/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/PhilippPaetzold/subscriptions",
            "organizations_url": "https://api.github.com/users/PhilippPaetzold/orgs",
            "repos_url": "https://api.github.com/users/PhilippPaetzold/repos",
            "events_url": "https://api.github.com/users/PhilippPaetzold/events{/privacy}",
            "received_events_url": "https://api.github.com/users/PhilippPaetzold/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-21T10:46:04Z",
        "updated_at": "2021-04-21T10:50:47Z",
        "author_association": "NONE",
        "body": "I did some tests with CPU execution and a simple network: [testModel_1_10_c4_w1_0.9.onnx.zip](https://github.com/microsoft/onnxruntime/files/6350161/testModel_1_10_c4_w1_0.9.onnx.zip)\r\n\r\n```cpp\r\n#include <iostream>\r\n#include <string>\r\n#include <thread>\r\n#include <onnxruntime/core/session/onnxruntime_cxx_api.h>\r\n\r\nbool IsHeapAllocationRecordEnabled      = false;\r\nint NumberOfHeapAllocationsAfterStart   = 0;\r\nint NumberOfHeapDeallocationsAfterStart = 0;\r\n\r\n void* operator new (size_t size)\r\n{\r\n    if (IsHeapAllocationRecordEnabled)\r\n    {\r\n        NumberOfHeapAllocationsAfterStart++;\r\n    }\r\n\r\n    void* p = malloc (size);\r\n    return p;\r\n}\r\n\r\n void operator delete (void* p)\r\n{\r\n    if (IsHeapAllocationRecordEnabled)\r\n    {\r\n        NumberOfHeapDeallocationsAfterStart++;\r\n    }\r\n\r\n    free (p);\r\n}\r\n\r\nint main(int argc, char** argv) {\r\n    const int numberOfRuns{1};\r\n\r\n    auto env = Ort::Env();\r\n\r\n    auto sessionOptions = Ort::SessionOptions();\r\n\r\n    sessionOptions.SetInterOpNumThreads(1);\r\n    sessionOptions.SetIntraOpNumThreads(3);\r\n\r\n\r\n    auto session = Ort::Session(env, \"./testModel_1_10_c4_w1_0.9.onnx\", sessionOptions);\r\n\r\n    std::array<char *, 4> inputLayerNames{};\r\n    std::array<char *, 4> outputLayerNames{};\r\n\r\n    auto allocator = Ort::AllocatorWithDefaultOptions();\r\n    auto inputLayerName = session.GetInputName(0, allocator);\r\n    auto outputLayerName = session.GetOutputName(0, allocator);\r\n    inputLayerNames[0] = inputLayerName;\r\n    outputLayerNames[0] = outputLayerName;\r\n\r\n    const int outputSize{4};\r\n    auto output = std::make_unique<float[]>(outputSize);\r\n    std::fill_n(output.get(), outputSize, 0);\r\n\r\n    const int inputSize{10};\r\n    auto input = std::make_unique<float[]>(inputSize);\r\n    std::fill_n(input.get(), inputSize, rand());\r\n\r\n    auto inputShape = session.GetInputTypeInfo(0).GetTensorTypeAndShapeInfo().GetShape();\r\n    auto outputShape = session.GetOutputTypeInfo(0).GetTensorTypeAndShapeInfo().GetShape();\r\n    auto memoryInfo = Ort::MemoryInfo::CreateCpu(OrtDeviceAllocator, OrtMemTypeCPU);\r\n\r\n    inputShape[0] = 1;\r\n    outputShape[0] = 1;\r\n    auto inputOnnxTensor = Ort::Value::CreateTensor<float>(memoryInfo,\r\n                                                           input.get(), inputSize,\r\n                                                           inputShape.data(), inputShape.size());\r\n    auto outputOnnxTensor = Ort::Value::CreateTensor<float>(memoryInfo,\r\n                                                            output.get(), outputSize,\r\n                                                            outputShape.data(), outputShape.size());\r\n\r\n\r\n    IsHeapAllocationRecordEnabled = true;\r\n    for (int i = 0; i < numberOfRuns; ++i) {\r\n        session.Run(Ort::RunOptions(nullptr),\r\n                    inputLayerNames.data(), &inputOnnxTensor, 1,\r\n                    outputLayerNames.data(), &outputOnnxTensor, 1);\r\n    }\r\n    IsHeapAllocationRecordEnabled = false;\r\n\r\n    std::cout << \"Number of allocations: \" << NumberOfHeapAllocationsAfterStart << std::endl;\r\n    std::cout << \"Number of deallocations: \" << NumberOfHeapDeallocationsAfterStart << std::endl;\r\n}\r\n```\r\nFor the first iteration of ```session.Run(...)``` alone, I have over hundred allocations. By setting a breakpoint in my overloaded new-operator, I can see a lot of allocations from std::vector:\r\n\r\n```\r\n// allocation 1\r\nstd::allocator<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > > >::vector stl_vector.h:508\r\nOrtApis::Run onnxruntime_c_api.cc:546\r\nOrt::Session::Run onnxruntime_cxx_inline.h:530\r\nmain main.cpp:77\r\n\r\n// allocation 2\r\n...\r\nstd::vector<OrtValue, std::allocator<OrtValue> >::vector stl_vector.h:508\r\nOrtApis::Run onnxruntime_c_api.cc:547\r\nOrt::Session::Run onnxruntime_cxx_inline.h:530\r\nmain main.cpp:77\r\n...\r\n\r\n// allocation 3\r\n...\r\nstd::allocator<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > > >::vector stl_vector.h:508\r\nOrtApis::Run onnxruntime_c_api.cc:561\r\nOrt::Session::Run onnxruntime_cxx_inline.h:530\r\nmain main.cpp:77\r\n...\r\n// allocation 4\r\n...\r\noperator new main.cpp:14\r\n...\r\nstd::vector<OrtValue, std::allocator<OrtValue> >::vector stl_vector.h:508\r\nOrtApis::Run onnxruntime_c_api.cc:569\r\nOrt::Session::Run onnxruntime_cxx_inline.h:530\r\nmain main.cpp:77\r\n...\r\n// allocation 5\r\n...\r\nstd::vector<onnxruntime::IExecutionProvider*, std::allocator<onnxruntime::IExecutionProvider*> >::reserve vector.tcc:78\r\nonnxruntime::InferenceSession::Run inference_session.cc:1526\r\nOrtApis::Run onnxruntime_c_api.cc:581\r\nOrt::Session::Run onnxruntime_cxx_inline.h:530\r\nmain main.cpp:77\r\n...\r\n\r\n... // 120 allocations\r\n```\r\n\r\nFor some of those allocations I can see that they use a special std::allocator. Does this mean they will be using memory pools in consecutive calls to ```session.Run(...)```?\r\n\r\nFor the next (second) iteration and call to ```session.Run(...)```, I get only 88 allocations, but also only 87 deallocations. So there seems to be one allocation leaking.\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/823965558/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "PhilippPaetzold",
            "id": 23527944,
            "node_id": "MDQ6VXNlcjIzNTI3OTQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/23527944?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/PhilippPaetzold",
            "html_url": "https://github.com/PhilippPaetzold",
            "followers_url": "https://api.github.com/users/PhilippPaetzold/followers",
            "following_url": "https://api.github.com/users/PhilippPaetzold/following{/other_user}",
            "gists_url": "https://api.github.com/users/PhilippPaetzold/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/PhilippPaetzold/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/PhilippPaetzold/subscriptions",
            "organizations_url": "https://api.github.com/users/PhilippPaetzold/orgs",
            "repos_url": "https://api.github.com/users/PhilippPaetzold/repos",
            "events_url": "https://api.github.com/users/PhilippPaetzold/events{/privacy}",
            "received_events_url": "https://api.github.com/users/PhilippPaetzold/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/824287716",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7381#issuecomment-824287716",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7381",
        "id": 824287716,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyNDI4NzcxNg==",
        "user": {
            "login": "yuslepukhin",
            "id": 11303988,
            "node_id": "MDQ6VXNlcjExMzAzOTg4",
            "avatar_url": "https://avatars.githubusercontent.com/u/11303988?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yuslepukhin",
            "html_url": "https://github.com/yuslepukhin",
            "followers_url": "https://api.github.com/users/yuslepukhin/followers",
            "following_url": "https://api.github.com/users/yuslepukhin/following{/other_user}",
            "gists_url": "https://api.github.com/users/yuslepukhin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yuslepukhin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yuslepukhin/subscriptions",
            "organizations_url": "https://api.github.com/users/yuslepukhin/orgs",
            "repos_url": "https://api.github.com/users/yuslepukhin/repos",
            "events_url": "https://api.github.com/users/yuslepukhin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yuslepukhin/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-21T19:00:48Z",
        "updated_at": "2021-04-21T19:00:48Z",
        "author_association": "MEMBER",
        "body": "`std::allocator` is not special, it is a standard default allocator.\r\n`inputLayer` and `outputLayer` names and output names are supposed to be freed by the caller using the same allocator provided.. Example code has a bug. [doc](https://github.com/microsoft/onnxruntime/blob/09313d9e1f2cb526330369eee88b489b23dd2c4f/include/onnxruntime/core/session/onnxruntime_c_api.h#L494)\r\n\r\nHowever, that it is just a part of the picture.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/824287716/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "yuslepukhin",
            "id": 11303988,
            "node_id": "MDQ6VXNlcjExMzAzOTg4",
            "avatar_url": "https://avatars.githubusercontent.com/u/11303988?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yuslepukhin",
            "html_url": "https://github.com/yuslepukhin",
            "followers_url": "https://api.github.com/users/yuslepukhin/followers",
            "following_url": "https://api.github.com/users/yuslepukhin/following{/other_user}",
            "gists_url": "https://api.github.com/users/yuslepukhin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yuslepukhin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yuslepukhin/subscriptions",
            "organizations_url": "https://api.github.com/users/yuslepukhin/orgs",
            "repos_url": "https://api.github.com/users/yuslepukhin/repos",
            "events_url": "https://api.github.com/users/yuslepukhin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yuslepukhin/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/826989980",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7381#issuecomment-826989980",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7381",
        "id": 826989980,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyNjk4OTk4MA==",
        "user": {
            "login": "PhilippPaetzold",
            "id": 23527944,
            "node_id": "MDQ6VXNlcjIzNTI3OTQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/23527944?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/PhilippPaetzold",
            "html_url": "https://github.com/PhilippPaetzold",
            "followers_url": "https://api.github.com/users/PhilippPaetzold/followers",
            "following_url": "https://api.github.com/users/PhilippPaetzold/following{/other_user}",
            "gists_url": "https://api.github.com/users/PhilippPaetzold/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/PhilippPaetzold/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/PhilippPaetzold/subscriptions",
            "organizations_url": "https://api.github.com/users/PhilippPaetzold/orgs",
            "repos_url": "https://api.github.com/users/PhilippPaetzold/repos",
            "events_url": "https://api.github.com/users/PhilippPaetzold/events{/privacy}",
            "received_events_url": "https://api.github.com/users/PhilippPaetzold/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-26T16:46:24Z",
        "updated_at": "2021-04-26T16:46:24Z",
        "author_association": "NONE",
        "body": "Ok, we will switch to a different framework then. Thank you for your support.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/826989980/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "PhilippPaetzold",
            "id": 23527944,
            "node_id": "MDQ6VXNlcjIzNTI3OTQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/23527944?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/PhilippPaetzold",
            "html_url": "https://github.com/PhilippPaetzold",
            "followers_url": "https://api.github.com/users/PhilippPaetzold/followers",
            "following_url": "https://api.github.com/users/PhilippPaetzold/following{/other_user}",
            "gists_url": "https://api.github.com/users/PhilippPaetzold/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/PhilippPaetzold/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/PhilippPaetzold/subscriptions",
            "organizations_url": "https://api.github.com/users/PhilippPaetzold/orgs",
            "repos_url": "https://api.github.com/users/PhilippPaetzold/repos",
            "events_url": "https://api.github.com/users/PhilippPaetzold/events{/privacy}",
            "received_events_url": "https://api.github.com/users/PhilippPaetzold/received_events",
            "type": "User",
            "site_admin": false
        }
    },
    {
        "id": 4646125768,
        "node_id": "MDExOkNsb3NlZEV2ZW50NDY0NjEyNTc2OA==",
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/events/4646125768",
        "actor": {
            "login": "PhilippPaetzold",
            "id": 23527944,
            "node_id": "MDQ6VXNlcjIzNTI3OTQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/23527944?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/PhilippPaetzold",
            "html_url": "https://github.com/PhilippPaetzold",
            "followers_url": "https://api.github.com/users/PhilippPaetzold/followers",
            "following_url": "https://api.github.com/users/PhilippPaetzold/following{/other_user}",
            "gists_url": "https://api.github.com/users/PhilippPaetzold/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/PhilippPaetzold/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/PhilippPaetzold/subscriptions",
            "organizations_url": "https://api.github.com/users/PhilippPaetzold/orgs",
            "repos_url": "https://api.github.com/users/PhilippPaetzold/repos",
            "events_url": "https://api.github.com/users/PhilippPaetzold/events{/privacy}",
            "received_events_url": "https://api.github.com/users/PhilippPaetzold/received_events",
            "type": "User",
            "site_admin": false
        },
        "event": "closed",
        "commit_id": null,
        "commit_url": null,
        "created_at": "2021-04-26T16:46:24Z",
        "state_reason": null,
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/827181507",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7381#issuecomment-827181507",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7381",
        "id": 827181507,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzE4MTUwNw==",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-26T22:23:23Z",
        "updated_at": "2021-04-26T22:23:23Z",
        "author_association": "MEMBER",
        "body": "We use memory pool for all the data allocations (i.e. all the tensors and weights used during model execution), but don't override the std::allocator for things like std::string and std::vector. \r\n\r\nOriginally you mentioned way over a million allocations when using the OpenVINO EP though, so given with the CPU EP the number of allocations seems to be much smaller there's a good chance OpenVINO is not using a memory pool (so a different framework that uses OpenVINO may have the same issue).\r\n\r\nThe 'leaking' allocator could be the allocation of a buffer for the memory pool. It will be freed when the session is freed.\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/827181507/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null,
        "event": "commented",
        "actor": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        }
    }
]