[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1145377940",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11717#issuecomment-1145377940",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11717",
        "id": 1145377940,
        "node_id": "IC_kwDOCVq1mM5ERRSU",
        "user": {
            "login": "titaiwangms",
            "id": 18010845,
            "node_id": "MDQ6VXNlcjE4MDEwODQ1",
            "avatar_url": "https://avatars.githubusercontent.com/u/18010845?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/titaiwangms",
            "html_url": "https://github.com/titaiwangms",
            "followers_url": "https://api.github.com/users/titaiwangms/followers",
            "following_url": "https://api.github.com/users/titaiwangms/following{/other_user}",
            "gists_url": "https://api.github.com/users/titaiwangms/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/titaiwangms/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/titaiwangms/subscriptions",
            "organizations_url": "https://api.github.com/users/titaiwangms/orgs",
            "repos_url": "https://api.github.com/users/titaiwangms/repos",
            "events_url": "https://api.github.com/users/titaiwangms/events{/privacy}",
            "received_events_url": "https://api.github.com/users/titaiwangms/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-06-02T21:50:26Z",
        "updated_at": "2022-06-02T21:50:26Z",
        "author_association": "MEMBER",
        "body": "@hariharans29 , \r\nanother 8 cases I have that you can try.\r\n\r\n```python\r\nfrom typing import Optional\r\nimport io\r\nimport torch\r\nimport copy\r\nimport onnxruntime\r\nimport onnx\r\nimport itertools\r\n\r\n_ORT_PROVIDERS = [\"CPUExecutionProvider\"]\r\n\r\ndef convert_to_onnx(\r\n    model,\r\n    input=None,\r\n    opset_version=9,\r\n    do_constant_folding=True,\r\n    keep_initializers_as_inputs=True,\r\n    dynamic_axes=None,\r\n    input_names=None,\r\n    output_names=None,\r\n    fixed_batch_size=False,\r\n    training=None,\r\n    verbose=False,\r\n):\r\n    f = io.BytesIO()\r\n    input_copy = copy.deepcopy(input)\r\n    torch.onnx._export(\r\n        model,\r\n        input_copy,\r\n        f,\r\n        opset_version=opset_version,\r\n        do_constant_folding=do_constant_folding,\r\n        keep_initializers_as_inputs=keep_initializers_as_inputs,\r\n        dynamic_axes=dynamic_axes,\r\n        input_names=input_names,\r\n        output_names=output_names,\r\n        fixed_batch_size=fixed_batch_size,\r\n        training=training,\r\n        verbose=verbose,\r\n    )\r\n\r\n    print(\" === Checking ONNX === \")\r\n    m = onnx.load(f)\r\n    a = onnx.shape_inference.infer_shapes(m, True, True)\r\n    #onnx.checker.check_model(m)\r\n    print(\" === Check Ended === \")\r\n\r\n    # compute onnxruntime output prediction\r\n    so = onnxruntime.SessionOptions()\r\n    # suppress ort warnings.\r\n    # 0:Verbose, 1:Info, 2:Warning. 3:Error, 4:Fatal. Default is 2.\r\n    so.log_severity_level = 0\r\n    ort_sess = onnxruntime.InferenceSession(f.getvalue(), so, providers=_ORT_PROVIDERS)\r\n    return ort_sess\r\n\r\nclass IfNoneInput(torch.nn.Module):\r\n    def forward(self, x) -> Optional[torch.Tensor]:\r\n        y: Optional[torch.Tensor] = None\r\n        if x.size(0) > 1:\r\n            y = x\r\n        return y\r\n\r\nclass IfNoneOutput(torch.nn.Module):\r\n    def forward(self, x) -> Optional[torch.Tensor]:\r\n        y: Optional[torch.Tensor] = x\r\n        if x.size(0) > 1:\r\n            y = None\r\n        return y\r\n\r\nclass LoopNoneInput(torch.nn.Module):\r\n    def forward(self, x) -> Optional[torch.Tensor]:\r\n        y: Optional[torch.Tensor] = None\r\n        for _ in range(x.size(0)):\r\n            y = x\r\n        return y\r\n\r\nclass LoopNoneOutput(torch.nn.Module):\r\n    def forward(self, x) -> Optional[torch.Tensor]:\r\n        y: Optional[torch.Tensor] = x\r\n        for _ in range(x.size(0)):\r\n            y = None\r\n        return y\r\n\r\nmodule_classes = [IfNoneInput, IfNoneOutput, LoopNoneInput, LoopNoneOutput]\r\nx_sizes = [0, 1]\r\n\r\n# Need scripting to preserve control flow for this test to be\r\n# meaningful.\r\nfor (module_class, x_size) in itertools.product(module_classes, x_sizes):\r\n    model = torch.jit.script(module_class())\r\n    f = io.BytesIO()\r\n    x = torch.ones(x_size)\r\n    dynamic_axis_name = \"condition\"\r\n\r\n    convert_to_onnx(\r\n        model,\r\n        x,\r\n        opset_version=16,\r\n        # Ensure condition is not constant\r\n        dynamic_axes={\"x\": {0: dynamic_axis_name}},\r\n        input_names=[\"x\"],\r\n    )\r\n```",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1145377940/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1145421028",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11717#issuecomment-1145421028",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11717",
        "id": 1145421028,
        "node_id": "IC_kwDOCVq1mM5ERbzk",
        "user": {
            "login": "hariharans29",
            "id": 9969784,
            "node_id": "MDQ6VXNlcjk5Njk3ODQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9969784?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/hariharans29",
            "html_url": "https://github.com/hariharans29",
            "followers_url": "https://api.github.com/users/hariharans29/followers",
            "following_url": "https://api.github.com/users/hariharans29/following{/other_user}",
            "gists_url": "https://api.github.com/users/hariharans29/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/hariharans29/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/hariharans29/subscriptions",
            "organizations_url": "https://api.github.com/users/hariharans29/orgs",
            "repos_url": "https://api.github.com/users/hariharans29/repos",
            "events_url": "https://api.github.com/users/hariharans29/events{/privacy}",
            "received_events_url": "https://api.github.com/users/hariharans29/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-06-02T22:59:54Z",
        "updated_at": "2022-06-02T22:59:54Z",
        "author_association": "MEMBER",
        "body": "Thanks but do you have something that calls ort_sess .run(....) with some numpy input and expects specific numpy outputs ? I have a fix for the session load crash itself.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1145421028/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1154496280",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11717#issuecomment-1154496280",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11717",
        "id": 1154496280,
        "node_id": "IC_kwDOCVq1mM5E0DcY",
        "user": {
            "login": "hariharans29",
            "id": 9969784,
            "node_id": "MDQ6VXNlcjk5Njk3ODQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9969784?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/hariharans29",
            "html_url": "https://github.com/hariharans29",
            "followers_url": "https://api.github.com/users/hariharans29/followers",
            "following_url": "https://api.github.com/users/hariharans29/following{/other_user}",
            "gists_url": "https://api.github.com/users/hariharans29/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/hariharans29/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/hariharans29/subscriptions",
            "organizations_url": "https://api.github.com/users/hariharans29/orgs",
            "repos_url": "https://api.github.com/users/hariharans29/repos",
            "events_url": "https://api.github.com/users/hariharans29/events{/privacy}",
            "received_events_url": "https://api.github.com/users/hariharans29/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-06-13T22:16:08Z",
        "updated_at": "2022-06-13T22:16:08Z",
        "author_association": "MEMBER",
        "body": "@AllenTiTaiWang : Can you please try building the fix branch hari/optional_fix_1 and ensure the tests pass (like we synced offline) ?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1154496280/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1154498111",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11717#issuecomment-1154498111",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11717",
        "id": 1154498111,
        "node_id": "IC_kwDOCVq1mM5E0D4_",
        "user": {
            "login": "titaiwangms",
            "id": 18010845,
            "node_id": "MDQ6VXNlcjE4MDEwODQ1",
            "avatar_url": "https://avatars.githubusercontent.com/u/18010845?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/titaiwangms",
            "html_url": "https://github.com/titaiwangms",
            "followers_url": "https://api.github.com/users/titaiwangms/followers",
            "following_url": "https://api.github.com/users/titaiwangms/following{/other_user}",
            "gists_url": "https://api.github.com/users/titaiwangms/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/titaiwangms/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/titaiwangms/subscriptions",
            "organizations_url": "https://api.github.com/users/titaiwangms/orgs",
            "repos_url": "https://api.github.com/users/titaiwangms/repos",
            "events_url": "https://api.github.com/users/titaiwangms/events{/privacy}",
            "received_events_url": "https://api.github.com/users/titaiwangms/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-06-13T22:18:46Z",
        "updated_at": "2022-06-13T22:18:46Z",
        "author_association": "MEMBER",
        "body": "OK, I will try it from my side!",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1154498111/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1165726945",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11717#issuecomment-1165726945",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11717",
        "id": 1165726945,
        "node_id": "IC_kwDOCVq1mM5Fe5Th",
        "user": {
            "login": "titaiwangms",
            "id": 18010845,
            "node_id": "MDQ6VXNlcjE4MDEwODQ1",
            "avatar_url": "https://avatars.githubusercontent.com/u/18010845?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/titaiwangms",
            "html_url": "https://github.com/titaiwangms",
            "followers_url": "https://api.github.com/users/titaiwangms/followers",
            "following_url": "https://api.github.com/users/titaiwangms/following{/other_user}",
            "gists_url": "https://api.github.com/users/titaiwangms/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/titaiwangms/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/titaiwangms/subscriptions",
            "organizations_url": "https://api.github.com/users/titaiwangms/orgs",
            "repos_url": "https://api.github.com/users/titaiwangms/repos",
            "events_url": "https://api.github.com/users/titaiwangms/events{/privacy}",
            "received_events_url": "https://api.github.com/users/titaiwangms/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-06-24T16:16:24Z",
        "updated_at": "2022-06-24T16:16:24Z",
        "author_association": "MEMBER",
        "body": "Hi Hari,\r\nMost of the test cases pass, but this one error out during inference with the message:\r\n```bash\r\nsess = C.InferenceSession(session_options, self._model_bytes, False, self._read_config_from_model)\r\nonnxruntime.capi.onnxruntime_pybind11_state.Fail: [ONNXRuntimeError] : 1 : FAIL : Node (Loop_5) Op (Loop) [TypeInferenceError] Output was expected to have tensor type. Got 9\r\n```\r\nIt can be exported though,\r\n```python\r\n\r\nclass LoopNoneInput(torch.nn.Module):\r\n    def forward(self, x) -> Optional[torch.Tensor]:\r\n        y: Optional[torch.Tensor] = None\r\n        for _ in range(x.size(0)):\r\n            y = x\r\n        return y\r\n\r\n# x_size = 0, 1 are both tested\r\n# x_size = 1\r\nx_size = 0\r\n\r\nmodel = torch.jit.script(LoopNoneInput())\r\nf = io.BytesIO()\r\nx = torch.ones(x_size)\r\ndynamic_axis_name = \"condition\"\r\n\r\ntorch.onnx.export(\r\n    torch.jit.script(model),\r\n    (x,),\r\n    f,\r\n    opset_version=16,\r\n    # Ensure condition is not constant\r\n    dynamic_axes={\"x\": {0: dynamic_axis_name}},\r\n    input_names=[\"x\"],\r\n)\r\n```\r\nLet me know if you need more information.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1165726945/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1165957282",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11717#issuecomment-1165957282",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11717",
        "id": 1165957282,
        "node_id": "IC_kwDOCVq1mM5Ffxii",
        "user": {
            "login": "hariharans29",
            "id": 9969784,
            "node_id": "MDQ6VXNlcjk5Njk3ODQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9969784?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/hariharans29",
            "html_url": "https://github.com/hariharans29",
            "followers_url": "https://api.github.com/users/hariharans29/followers",
            "following_url": "https://api.github.com/users/hariharans29/following{/other_user}",
            "gists_url": "https://api.github.com/users/hariharans29/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/hariharans29/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/hariharans29/subscriptions",
            "organizations_url": "https://api.github.com/users/hariharans29/orgs",
            "repos_url": "https://api.github.com/users/hariharans29/repos",
            "events_url": "https://api.github.com/users/hariharans29/events{/privacy}",
            "received_events_url": "https://api.github.com/users/hariharans29/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-06-24T21:33:42Z",
        "updated_at": "2022-06-24T21:38:34Z",
        "author_association": "MEMBER",
        "body": "This error message is coming from ONNX - specifically the Loop's type inference function - https://github.com/onnx/onnx/blob/a525f98d5ed31660b629bab90c680a39658a5c08/onnx/defs/controlflow/defs.cc#L250. \r\n\r\nOne would have to look into what is specifically wrong with the model but I am guessing that when this is invoked -  https://github.com/onnx/onnx/blob/a525f98d5ed31660b629bab90c680a39658a5c08/onnx/defs/controlflow/defs.cc#L337, it eventually runs into this - https://github.com/onnx/onnx/blob/a525f98d5ed31660b629bab90c680a39658a5c08/onnx/defs/shape_inference.cc#L343.\r\n\r\nI am thinking there is an issue with some type info in the model you are running into this issue with.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1165957282/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1168069292",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11717#issuecomment-1168069292",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11717",
        "id": 1168069292,
        "node_id": "IC_kwDOCVq1mM5Fn1Ks",
        "user": {
            "login": "titaiwangms",
            "id": 18010845,
            "node_id": "MDQ6VXNlcjE4MDEwODQ1",
            "avatar_url": "https://avatars.githubusercontent.com/u/18010845?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/titaiwangms",
            "html_url": "https://github.com/titaiwangms",
            "followers_url": "https://api.github.com/users/titaiwangms/followers",
            "following_url": "https://api.github.com/users/titaiwangms/following{/other_user}",
            "gists_url": "https://api.github.com/users/titaiwangms/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/titaiwangms/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/titaiwangms/subscriptions",
            "organizations_url": "https://api.github.com/users/titaiwangms/orgs",
            "repos_url": "https://api.github.com/users/titaiwangms/repos",
            "events_url": "https://api.github.com/users/titaiwangms/events{/privacy}",
            "received_events_url": "https://api.github.com/users/titaiwangms/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-06-28T00:18:32Z",
        "updated_at": "2022-06-28T00:22:40Z",
        "author_association": "MEMBER",
        "body": "The remaining issue seems to be from shape inference about loop node. I will reopen this issue if I find any issue later.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1168069292/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1170299578",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11717#issuecomment-1170299578",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11717",
        "id": 1170299578,
        "node_id": "IC_kwDOCVq1mM5FwVq6",
        "user": {
            "login": "garymm",
            "id": 421339,
            "node_id": "MDQ6VXNlcjQyMTMzOQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/421339?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/garymm",
            "html_url": "https://github.com/garymm",
            "followers_url": "https://api.github.com/users/garymm/followers",
            "following_url": "https://api.github.com/users/garymm/following{/other_user}",
            "gists_url": "https://api.github.com/users/garymm/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/garymm/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/garymm/subscriptions",
            "organizations_url": "https://api.github.com/users/garymm/orgs",
            "repos_url": "https://api.github.com/users/garymm/repos",
            "events_url": "https://api.github.com/users/garymm/events{/privacy}",
            "received_events_url": "https://api.github.com/users/garymm/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-06-29T17:50:01Z",
        "updated_at": "2022-06-29T17:50:01Z",
        "author_association": "CONTRIBUTOR",
        "body": "Re-opening since the fix hasn't been merged.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1170299578/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]