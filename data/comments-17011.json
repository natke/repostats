[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1666236440",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/17011#issuecomment-1666236440",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/17011",
        "id": 1666236440,
        "node_id": "IC_kwDOCVq1mM5jUMAY",
        "user": {
            "login": "cyrusbehr",
            "id": 17056751,
            "node_id": "MDQ6VXNlcjE3MDU2NzUx",
            "avatar_url": "https://avatars.githubusercontent.com/u/17056751?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cyrusbehr",
            "html_url": "https://github.com/cyrusbehr",
            "followers_url": "https://api.github.com/users/cyrusbehr/followers",
            "following_url": "https://api.github.com/users/cyrusbehr/following{/other_user}",
            "gists_url": "https://api.github.com/users/cyrusbehr/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/cyrusbehr/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/cyrusbehr/subscriptions",
            "organizations_url": "https://api.github.com/users/cyrusbehr/orgs",
            "repos_url": "https://api.github.com/users/cyrusbehr/repos",
            "events_url": "https://api.github.com/users/cyrusbehr/events{/privacy}",
            "received_events_url": "https://api.github.com/users/cyrusbehr/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-04T22:26:16Z",
        "updated_at": "2023-08-04T22:26:16Z",
        "author_association": "NONE",
        "body": "I set the following:\r\n\r\n```\r\n    m_sessionOptsPtr->AddConfigEntry(kOrtSessionOptionsConfigAllowInterOpSpinning, \"0\");\r\n    m_sessionOptsPtr->AddConfigEntry(kOrtSessionOptionsConfigAllowIntraOpSpinning, \"0\");\r\n```\r\n\r\nAnd it has reduced the total combined inference time from 160 ms to 101 ms \r\n\r\nIs setting these options the correct solution? Or is there something better I should be doing (ex. global thread pool). \r\n\r\nI tried reading the docs for these options, but am a little confused by what thread spinning is. ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1666236440/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1666302080",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/17011#issuecomment-1666302080",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/17011",
        "id": 1666302080,
        "node_id": "IC_kwDOCVq1mM5jUcCA",
        "user": {
            "login": "RyanUnderhill",
            "id": 38674843,
            "node_id": "MDQ6VXNlcjM4Njc0ODQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/38674843?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/RyanUnderhill",
            "html_url": "https://github.com/RyanUnderhill",
            "followers_url": "https://api.github.com/users/RyanUnderhill/followers",
            "following_url": "https://api.github.com/users/RyanUnderhill/following{/other_user}",
            "gists_url": "https://api.github.com/users/RyanUnderhill/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/RyanUnderhill/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/RyanUnderhill/subscriptions",
            "organizations_url": "https://api.github.com/users/RyanUnderhill/orgs",
            "repos_url": "https://api.github.com/users/RyanUnderhill/repos",
            "events_url": "https://api.github.com/users/RyanUnderhill/events{/privacy}",
            "received_events_url": "https://api.github.com/users/RyanUnderhill/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-05T00:31:04Z",
        "updated_at": "2023-08-05T00:31:04Z",
        "author_association": "MEMBER",
        "body": "Thread spinning is just using spinlocks to wait for work on the thread pool:: https://en.wikipedia.org/wiki/Spinlock they can reduce thread latency in some cases but if you're not keeping the threads busy with work then they will tie up resources instead.\r\n\r\nIt sounds like you have one thread per model? In that case the spinlocks are probably counter productive as each session is optimizing for a continuous stream of work and stealing CPU time from the other threads, though the difference you show is a bit excessive.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1666302080/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1666341863",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/17011#issuecomment-1666341863",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/17011",
        "id": 1666341863,
        "node_id": "IC_kwDOCVq1mM5jUlvn",
        "user": {
            "login": "cyrusbehr",
            "id": 17056751,
            "node_id": "MDQ6VXNlcjE3MDU2NzUx",
            "avatar_url": "https://avatars.githubusercontent.com/u/17056751?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cyrusbehr",
            "html_url": "https://github.com/cyrusbehr",
            "followers_url": "https://api.github.com/users/cyrusbehr/followers",
            "following_url": "https://api.github.com/users/cyrusbehr/following{/other_user}",
            "gists_url": "https://api.github.com/users/cyrusbehr/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/cyrusbehr/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/cyrusbehr/subscriptions",
            "organizations_url": "https://api.github.com/users/cyrusbehr/orgs",
            "repos_url": "https://api.github.com/users/cyrusbehr/repos",
            "events_url": "https://api.github.com/users/cyrusbehr/events{/privacy}",
            "received_events_url": "https://api.github.com/users/cyrusbehr/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-05T01:44:09Z",
        "updated_at": "2023-08-05T01:44:09Z",
        "author_association": "NONE",
        "body": "Ok, so from your description does sound like the spinlocks are the issues here.\r\n\r\nAs explained in my description, I allow each session to use 8 threads for inference. \r\nThe main application itself only uses a single thread to drive the inference (runs face orientation detection, face detection, face recognition, repeat...). ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1666341863/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1668427865",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/17011#issuecomment-1668427865",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/17011",
        "id": 1668427865,
        "node_id": "IC_kwDOCVq1mM5jcjBZ",
        "user": {
            "login": "cyrusbehr",
            "id": 17056751,
            "node_id": "MDQ6VXNlcjE3MDU2NzUx",
            "avatar_url": "https://avatars.githubusercontent.com/u/17056751?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cyrusbehr",
            "html_url": "https://github.com/cyrusbehr",
            "followers_url": "https://api.github.com/users/cyrusbehr/followers",
            "following_url": "https://api.github.com/users/cyrusbehr/following{/other_user}",
            "gists_url": "https://api.github.com/users/cyrusbehr/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/cyrusbehr/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/cyrusbehr/subscriptions",
            "organizations_url": "https://api.github.com/users/cyrusbehr/orgs",
            "repos_url": "https://api.github.com/users/cyrusbehr/repos",
            "events_url": "https://api.github.com/users/cyrusbehr/events{/privacy}",
            "received_events_url": "https://api.github.com/users/cyrusbehr/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-07T19:02:06Z",
        "updated_at": "2023-08-07T19:13:23Z",
        "author_association": "NONE",
        "body": "Performance seems to be variable, and not constant. \r\n@snnn what is the best configuration for running multiple sessions in serial, like described above? Our pipeline involves 8 models which need to be run in serial (face detection, face orientation, mask detection, glasses detection, etc...). ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1668427865/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1668571138",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/17011#issuecomment-1668571138",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/17011",
        "id": 1668571138,
        "node_id": "IC_kwDOCVq1mM5jdGAC",
        "user": {
            "login": "RyanUnderhill",
            "id": 38674843,
            "node_id": "MDQ6VXNlcjM4Njc0ODQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/38674843?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/RyanUnderhill",
            "html_url": "https://github.com/RyanUnderhill",
            "followers_url": "https://api.github.com/users/RyanUnderhill/followers",
            "following_url": "https://api.github.com/users/RyanUnderhill/following{/other_user}",
            "gists_url": "https://api.github.com/users/RyanUnderhill/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/RyanUnderhill/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/RyanUnderhill/subscriptions",
            "organizations_url": "https://api.github.com/users/RyanUnderhill/orgs",
            "repos_url": "https://api.github.com/users/RyanUnderhill/repos",
            "events_url": "https://api.github.com/users/RyanUnderhill/events{/privacy}",
            "received_events_url": "https://api.github.com/users/RyanUnderhill/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-07T21:00:26Z",
        "updated_at": "2023-08-07T21:00:26Z",
        "author_association": "MEMBER",
        "body": "Hopefully snnn will have more insights, but this could be a bug if the thread pool is spinning and starving the next run call from scheduling more work for that same thread pool. I'm curious if anything changes if you change the # of threads used. Is that CPU 16 physical cores, or 8 physical + 8 hyperthreaded?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1668571138/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1669806408",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/17011#issuecomment-1669806408",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/17011",
        "id": 1669806408,
        "node_id": "IC_kwDOCVq1mM5jhzlI",
        "user": {
            "login": "cyrusbehr",
            "id": 17056751,
            "node_id": "MDQ6VXNlcjE3MDU2NzUx",
            "avatar_url": "https://avatars.githubusercontent.com/u/17056751?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cyrusbehr",
            "html_url": "https://github.com/cyrusbehr",
            "followers_url": "https://api.github.com/users/cyrusbehr/followers",
            "following_url": "https://api.github.com/users/cyrusbehr/following{/other_user}",
            "gists_url": "https://api.github.com/users/cyrusbehr/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/cyrusbehr/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/cyrusbehr/subscriptions",
            "organizations_url": "https://api.github.com/users/cyrusbehr/orgs",
            "repos_url": "https://api.github.com/users/cyrusbehr/repos",
            "events_url": "https://api.github.com/users/cyrusbehr/events{/privacy}",
            "received_events_url": "https://api.github.com/users/cyrusbehr/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-08T15:09:25Z",
        "updated_at": "2023-08-08T15:09:25Z",
        "author_association": "NONE",
        "body": "@snnn do you have any advice? Single session inference is very fast (faster than NCNN for example), but serial inference using multiple sessions is slower than NCNN.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1669806408/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]