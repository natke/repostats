[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1407589266",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1407589266",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1407589266,
        "node_id": "IC_kwDOCVq1mM5T5huS",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-29T07:42:29Z",
        "updated_at": "2023-01-29T07:48:49Z",
        "author_association": "NONE",
        "body": "I have found a partial fix by making sure the onnx file is one single file. This fix only works for onnx files <2GB.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1407589266/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1407599579",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1407599579",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1407599579,
        "node_id": "IC_kwDOCVq1mM5T5kPb",
        "user": {
            "login": "uchuusen",
            "id": 84482737,
            "node_id": "MDQ6VXNlcjg0NDgyNzM3",
            "avatar_url": "https://avatars.githubusercontent.com/u/84482737?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/uchuusen",
            "html_url": "https://github.com/uchuusen",
            "followers_url": "https://api.github.com/users/uchuusen/followers",
            "following_url": "https://api.github.com/users/uchuusen/following{/other_user}",
            "gists_url": "https://api.github.com/users/uchuusen/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/uchuusen/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/uchuusen/subscriptions",
            "organizations_url": "https://api.github.com/users/uchuusen/orgs",
            "repos_url": "https://api.github.com/users/uchuusen/repos",
            "events_url": "https://api.github.com/users/uchuusen/events{/privacy}",
            "received_events_url": "https://api.github.com/users/uchuusen/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-29T08:38:03Z",
        "updated_at": "2023-01-29T08:38:03Z",
        "author_association": "NONE",
        "body": "I've noticed the same issue in Python as well. If I have an app that loads a stable diffusion onnx model and then unloads it repeatedly, for the purpose of switching models or clearing out vram, it will seem to lose track of a couple gigabytes of system ram every time it does so.\r\nIn my case, I'm using an integrated gpu, an AMD Vega 10 on a Ryzen 3700U chipset.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1407599579/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1409978960",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1409978960",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1409978960,
        "node_id": "IC_kwDOCVq1mM5UCpJQ",
        "user": {
            "login": "RyanUnderhill",
            "id": 38674843,
            "node_id": "MDQ6VXNlcjM4Njc0ODQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/38674843?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/RyanUnderhill",
            "html_url": "https://github.com/RyanUnderhill",
            "followers_url": "https://api.github.com/users/RyanUnderhill/followers",
            "following_url": "https://api.github.com/users/RyanUnderhill/following{/other_user}",
            "gists_url": "https://api.github.com/users/RyanUnderhill/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/RyanUnderhill/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/RyanUnderhill/subscriptions",
            "organizations_url": "https://api.github.com/users/RyanUnderhill/orgs",
            "repos_url": "https://api.github.com/users/RyanUnderhill/repos",
            "events_url": "https://api.github.com/users/RyanUnderhill/events{/privacy}",
            "received_events_url": "https://api.github.com/users/RyanUnderhill/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-31T08:50:42Z",
        "updated_at": "2023-01-31T08:50:42Z",
        "author_association": "MEMBER",
        "body": "@fdwr Is this a DirectML issue or is this C#?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1409978960/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1410380520",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1410380520",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1410380520,
        "node_id": "IC_kwDOCVq1mM5UELLo",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-31T13:42:10Z",
        "updated_at": "2023-01-31T13:42:10Z",
        "author_association": "NONE",
        "body": "> @fdwr Is this a DirectML issue or is this C#?\r\n\r\nI think it's a general issue of the weights.pb file not getting released from memory when the onnx file is in multiple parts. ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1410380520/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1411513286",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1411513286",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1411513286,
        "node_id": "IC_kwDOCVq1mM5UIfvG",
        "user": {
            "login": "RyanUnderhill",
            "id": 38674843,
            "node_id": "MDQ6VXNlcjM4Njc0ODQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/38674843?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/RyanUnderhill",
            "html_url": "https://github.com/RyanUnderhill",
            "followers_url": "https://api.github.com/users/RyanUnderhill/followers",
            "following_url": "https://api.github.com/users/RyanUnderhill/following{/other_user}",
            "gists_url": "https://api.github.com/users/RyanUnderhill/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/RyanUnderhill/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/RyanUnderhill/subscriptions",
            "organizations_url": "https://api.github.com/users/RyanUnderhill/orgs",
            "repos_url": "https://api.github.com/users/RyanUnderhill/repos",
            "events_url": "https://api.github.com/users/RyanUnderhill/events{/privacy}",
            "received_events_url": "https://api.github.com/users/RyanUnderhill/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-02-01T06:04:44Z",
        "updated_at": "2023-02-01T06:04:44Z",
        "author_association": "MEMBER",
        "body": "Is it possible to create a minimal repro scenario and paste it here? Just so we're sure we're doing the same thing you are.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1411513286/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1414056000",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1414056000",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1414056000,
        "node_id": "IC_kwDOCVq1mM5USMhA",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-02-02T16:52:47Z",
        "updated_at": "2023-02-02T17:00:07Z",
        "author_association": "NONE",
        "body": "The scenario is as follows:\r\n\r\n```\r\nSessionOptions so = new SessionOptions\r\n                {\r\n                    ExecutionMode = ExecutionMode.ORT_SEQUENTIAL,\r\n                    GraphOptimizationLevel = GraphOptimizationLevel.ORT_ENABLE_EXTENDED\r\n                };\r\n                so.AppendExecutionProvider_DML(); \r\n                    session = new InferenceSession(\"model.onnx\", so);\r\nsession.Dispose();\r\n```\r\n\r\nIf you try this with an onnx file that is in two parts model.onnx (100Mb) with separate weights.pb file (1.5GB). It seems to not release the weights.pb file from memory. Whereas if it is in a single file model.onnx (1.6GB) then it all gets cleared up from RAM.\r\n\r\nThis is not a problem for me anymore since I am now making sure that I only use single onnx files and not ones that are in multiple parts. Mind you, this may be a problem for people running bigger onnx files since they must be split if they are over 2GB.\r\n\r\nSeems like a simple bug in which auxillary files are not getting released.\r\n\r\nHere is a [conversion script](https://github.com/huggingface/diffusers/blob/main/scripts/convert_stable_diffusion_checkpoint_to_onnx.py) I used.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1414056000/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1416485706",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1416485706",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1416485706,
        "node_id": "IC_kwDOCVq1mM5UbdtK",
        "user": {
            "login": "fdwr",
            "id": 1809166,
            "node_id": "MDQ6VXNlcjE4MDkxNjY=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1809166?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/fdwr",
            "html_url": "https://github.com/fdwr",
            "followers_url": "https://api.github.com/users/fdwr/followers",
            "following_url": "https://api.github.com/users/fdwr/following{/other_user}",
            "gists_url": "https://api.github.com/users/fdwr/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/fdwr/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/fdwr/subscriptions",
            "organizations_url": "https://api.github.com/users/fdwr/orgs",
            "repos_url": "https://api.github.com/users/fdwr/repos",
            "events_url": "https://api.github.com/users/fdwr/events{/privacy}",
            "received_events_url": "https://api.github.com/users/fdwr/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-02-03T22:30:25Z",
        "updated_at": "2023-02-03T22:33:26Z",
        "author_association": "MEMBER",
        "body": "> @fdwr Is this a DirectML issue or is this C#?\r\n\r\n**Ryan**: ðŸ¤” My hunch is that it's a general GC resource lifetime issue (seeing both C# and Python repros in the comments), because the DML EP has no awareness of or differences in behavior for external vs internal weights - it just uses whatever was passed to it from ORT. AFAIK, we never did any work on the DML EP to support external weights, and so whoever added support must have done it in a way that it works with all the EP's generically.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1416485706/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1416549188",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1416549188",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1416549188,
        "node_id": "IC_kwDOCVq1mM5UbtNE",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-02-04T00:13:46Z",
        "updated_at": "2023-02-04T00:13:46Z",
        "author_association": "NONE",
        "body": "In general can I just say that it would be beneficial to release as much RAM as possible after having loaded in the values form the files including releasing file pointers and anything else.\r\n\r\nMany people are working with 1-2GB model files, on consumer PCs which in general have an average of 8GB VRAM and 8-12GB RAM if they're lucky. So every bit of memory counts.\r\n\r\nThanks!\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1416549188/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1444238019",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1444238019",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1444238019,
        "node_id": "IC_kwDOCVq1mM5WFVLD",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-02-24T18:42:13Z",
        "updated_at": "2023-02-24T18:44:15Z",
        "author_association": "NONE",
        "body": "> > @fdwr Is this a DirectML issue or is this C#?\r\n> \r\n> **Ryan**: ðŸ¤” My hunch is that it's a general GC resource lifetime issue (seeing both C# and Python repros in the comments), because the DML EP has no awareness of or differences in behavior for external vs internal weights - it just uses whatever was passed to it from ORT. AFAIK, we never did any work on the DML EP to support external weights, and so whoever added support must have done it in a way that it works with all the EP's generically.\r\n\r\nHello, is anyone working on this? It seems like lots of people have pointed out the same problem but nobody at Microsoft knows how to fix it? Seems like a 5 minute fix for the right person. Just unload the external weights files once they've been consumed.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1444238019/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1460960115",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1460960115",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1460960115,
        "node_id": "IC_kwDOCVq1mM5XFHtz",
        "user": {
            "login": "pranavsharma",
            "id": 2732907,
            "node_id": "MDQ6VXNlcjI3MzI5MDc=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2732907?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pranavsharma",
            "html_url": "https://github.com/pranavsharma",
            "followers_url": "https://api.github.com/users/pranavsharma/followers",
            "following_url": "https://api.github.com/users/pranavsharma/following{/other_user}",
            "gists_url": "https://api.github.com/users/pranavsharma/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pranavsharma/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pranavsharma/subscriptions",
            "organizations_url": "https://api.github.com/users/pranavsharma/orgs",
            "repos_url": "https://api.github.com/users/pranavsharma/repos",
            "events_url": "https://api.github.com/users/pranavsharma/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pranavsharma/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-08T22:24:04Z",
        "updated_at": "2023-03-08T22:24:04Z",
        "author_association": "MEMBER",
        "body": "The session should have released all memory on destruction. There's no known issue here. Have you tried using our C/C++ API (which has deterministic destruction)?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1460960115/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1461273972",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1461273972",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1461273972,
        "node_id": "IC_kwDOCVq1mM5XGUV0",
        "user": {
            "login": "fdwr",
            "id": 1809166,
            "node_id": "MDQ6VXNlcjE4MDkxNjY=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1809166?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/fdwr",
            "html_url": "https://github.com/fdwr",
            "followers_url": "https://api.github.com/users/fdwr/followers",
            "following_url": "https://api.github.com/users/fdwr/following{/other_user}",
            "gists_url": "https://api.github.com/users/fdwr/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/fdwr/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/fdwr/subscriptions",
            "organizations_url": "https://api.github.com/users/fdwr/orgs",
            "repos_url": "https://api.github.com/users/fdwr/repos",
            "events_url": "https://api.github.com/users/fdwr/events{/privacy}",
            "received_events_url": "https://api.github.com/users/fdwr/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-09T04:48:21Z",
        "updated_at": "2023-03-09T21:52:19Z",
        "author_association": "MEMBER",
        "body": "Sorry Mr @pauldog, but I haven't reproduced it :/. I tried with ORT 1.9 and ORT 1.14.1 using Stable Diffusion unet with a separate `weights.pb` file. The memory grows huge (gigabytes), but then falls back down after the `Dispose` (but *before* the last `WriteLine` statement). Here's my code in entirety:\r\n\r\n![image](https://user-images.githubusercontent.com/1809166/223918882-087d694b-2b69-4f01-993e-57680ad4d326.png)\r\n\r\n```\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.IO;\r\nusing Microsoft.ML.OnnxRuntime;\r\nusing Microsoft.ML.OnnxRuntime.Tensors;\r\n\r\nnamespace OrtTestApp\r\n{\r\n    class Program\r\n    {\r\n        static void Main(string[] args)\r\n        {\r\n            Console.WriteLine(\"Begin...\");\r\n\r\n            SessionOptions sessionOptions = new SessionOptions\r\n            {\r\n                ExecutionMode = ExecutionMode.ORT_SEQUENTIAL,\r\n                GraphOptimizationLevel = GraphOptimizationLevel.ORT_ENABLE_EXTENDED,\r\n                EnableMemoryPattern = false,\r\n            };\r\n            sessionOptions.AppendExecutionProvider_DML(0);\r\n            InferenceSession session = new InferenceSession(\"D:\\\\stable_diffusion_onnx\\\\unet\\\\model.onnx\", sessionOptions);\r\n            session.Dispose();\r\n\r\n            Console.WriteLine(\"End...\");\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nAnd to confirm, this does *not* happen with the CPU provider? (removing `AppendExecutionProvider_DML`)",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1461273972/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1461344010",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1461344010",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1461344010,
        "node_id": "IC_kwDOCVq1mM5XGlcK",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-09T06:09:25Z",
        "updated_at": "2023-03-09T06:23:26Z",
        "author_association": "NONE",
        "body": "Your program seems to be flawed because the program closes after it writes \"End\". Whereas the memory leak is for when the program **stays open**. Try adding a Console.ReadLine(); after the Console.WriteLine(\"End...\") and repeat the experiment.\r\n\r\nI am using C# in Unity. Using the same code:\r\n\r\n```\r\nusing System.Collections;\r\nusing System.Collections.Generic;\r\nusing UnityEngine;\r\nusing System;\r\nusing System.IO;\r\nusing Microsoft.ML.OnnxRuntime;\r\nusing Microsoft.ML.OnnxRuntime.Tensors;\r\n\r\nclass OrtTestApp : MonoBehaviour\r\n{\r\n    void Reload()\r\n    {\r\n        Debug.Log(\"Begin...\");\r\n\r\n        SessionOptions sessionOptions = new SessionOptions\r\n        {\r\n            ExecutionMode = ExecutionMode.ORT_SEQUENTIAL,\r\n            GraphOptimizationLevel = GraphOptimizationLevel.ORT_ENABLE_EXTENDED,\r\n            EnableMemoryPattern = false,\r\n        };\r\n        sessionOptions.AppendExecutionProvider_DML(0);\r\n        InferenceSession session = new InferenceSession(\"model.onnx\", sessionOptions);\r\n        session.Dispose();\r\n\r\n        Debug.Log(\"End...\");\r\n    }\r\n\r\n    private void Update()\r\n    {\r\n        if (Input.GetKeyDown(KeyCode.Space))\r\n        {\r\n            Reload();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n![screenshot_taskmanager](https://user-images.githubusercontent.com/33497043/223934485-655931e4-d468-42a1-b458-d15368f5094b.png)\r\n\r\nAs you can see about a memory leak of over 1GB.\r\n\r\nPerhaps its just a Unity thing, though I don't see how. I am using the latest dev build of onnxruntime directml and the onnxruntime managed library.\r\n\r\n\r\nSame experiment but without external weights file: (no memory leak here)\r\n![screenshot_taskmanager2](https://user-images.githubusercontent.com/33497043/223937665-f8d2e518-12fa-4f30-8adb-1310b58d65c7.png)\r\nTherefor my only conclusion can be is that the external weights files are not getting cleared by Dispose.\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1461344010/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1463001097",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1463001097",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1463001097,
        "node_id": "IC_kwDOCVq1mM5XM6AJ",
        "user": {
            "login": "fdwr",
            "id": 1809166,
            "node_id": "MDQ6VXNlcjE4MDkxNjY=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1809166?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/fdwr",
            "html_url": "https://github.com/fdwr",
            "followers_url": "https://api.github.com/users/fdwr/followers",
            "following_url": "https://api.github.com/users/fdwr/following{/other_user}",
            "gists_url": "https://api.github.com/users/fdwr/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/fdwr/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/fdwr/subscriptions",
            "organizations_url": "https://api.github.com/users/fdwr/orgs",
            "repos_url": "https://api.github.com/users/fdwr/repos",
            "events_url": "https://api.github.com/users/fdwr/events{/privacy}",
            "received_events_url": "https://api.github.com/users/fdwr/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-09T23:44:27Z",
        "updated_at": "2023-03-09T23:44:47Z",
        "author_association": "MEMBER",
        "body": "@pauldog I repro it when running a longer loop. It's definitely, like you say, related to these separate weight files.\r\n\r\nâœ… CPU EP + C#\r\nâœ… CPU EP + C++\r\nâœ… DML EP + C# + single model\r\nâœ… DML EP + C++ + single model\r\nâŒ DML EP + C# + separate weights\r\nâŒ DML EP + C++ + separate weights (e.g. [SD1.5](https://huggingface.co/runwayml/stable-diffusion-v1-5/tree/onnx/unet))\r\n\r\n![image](https://user-images.githubusercontent.com/1809166/224185319-fd0a2458-afba-4ee6-818a-cf93003d63e6.png)",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1463001097/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1466189416",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1466189416",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1466189416,
        "node_id": "IC_kwDOCVq1mM5XZEZo",
        "user": {
            "login": "ssube",
            "id": 451959,
            "node_id": "MDQ6VXNlcjQ1MTk1OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/451959?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ssube",
            "html_url": "https://github.com/ssube",
            "followers_url": "https://api.github.com/users/ssube/followers",
            "following_url": "https://api.github.com/users/ssube/following{/other_user}",
            "gists_url": "https://api.github.com/users/ssube/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/ssube/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ssube/subscriptions",
            "organizations_url": "https://api.github.com/users/ssube/orgs",
            "repos_url": "https://api.github.com/users/ssube/repos",
            "events_url": "https://api.github.com/users/ssube/events{/privacy}",
            "received_events_url": "https://api.github.com/users/ssube/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-13T13:55:05Z",
        "updated_at": "2023-03-13T13:58:18Z",
        "author_association": "NONE",
        "body": "fwiw, I don't think this behavior is specific to C# or DirectML: I have a Python program doing repeated inferences and it reliably runs out of memory after about 95 runs, with a very similar memory graph, on both CUDA and DirectML (attempting to test on ROCm as well). It does seem to be related to models with external weights, I have not seen it on smaller single-file models, but the SD v1.5 UNet hits about ~300GB of virtual memory on the CPU side within 100 runs, even if I close the sessions/options. Unloading and reloading the model after 10 runs frees up VRAM, but does not fix the CPU side. Restarting the worker process entirely after 10 runs does free up all of the memory, but requires multiprocessing and reloading everything.\r\n\r\n- https://github.com/microsoft/onnxruntime/issues/14641\r\n- https://github.com/ssube/onnx-web/issues/170",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1466189416/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1466337467",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1466337467",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1466337467,
        "node_id": "IC_kwDOCVq1mM5XZoi7",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-13T15:11:51Z",
        "updated_at": "2023-03-13T15:11:51Z",
        "author_association": "NONE",
        "body": "yes, it needs to be fixed to be able run model >2GB without leaking memory.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1466337467/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1466987146",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14466#issuecomment-1466987146",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14466",
        "id": 1466987146,
        "node_id": "IC_kwDOCVq1mM5XcHKK",
        "user": {
            "login": "pranavsharma",
            "id": 2732907,
            "node_id": "MDQ6VXNlcjI3MzI5MDc=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2732907?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pranavsharma",
            "html_url": "https://github.com/pranavsharma",
            "followers_url": "https://api.github.com/users/pranavsharma/followers",
            "following_url": "https://api.github.com/users/pranavsharma/following{/other_user}",
            "gists_url": "https://api.github.com/users/pranavsharma/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pranavsharma/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pranavsharma/subscriptions",
            "organizations_url": "https://api.github.com/users/pranavsharma/orgs",
            "repos_url": "https://api.github.com/users/pranavsharma/repos",
            "events_url": "https://api.github.com/users/pranavsharma/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pranavsharma/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-13T21:27:19Z",
        "updated_at": "2023-03-13T21:27:19Z",
        "author_association": "MEMBER",
        "body": "I can repo this on CUDA as well. Will try to take a look this week.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1466987146/reactions",
            "total_count": 2,
            "+1": 2,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]