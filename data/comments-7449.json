[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/826951191",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7449#issuecomment-826951191",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7449",
        "id": 826951191,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyNjk1MTE5MQ==",
        "user": {
            "login": "mrry",
            "id": 192142,
            "node_id": "MDQ6VXNlcjE5MjE0Mg==",
            "avatar_url": "https://avatars.githubusercontent.com/u/192142?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mrry",
            "html_url": "https://github.com/mrry",
            "followers_url": "https://api.github.com/users/mrry/followers",
            "following_url": "https://api.github.com/users/mrry/following{/other_user}",
            "gists_url": "https://api.github.com/users/mrry/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mrry/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mrry/subscriptions",
            "organizations_url": "https://api.github.com/users/mrry/orgs",
            "repos_url": "https://api.github.com/users/mrry/repos",
            "events_url": "https://api.github.com/users/mrry/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mrry/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-26T15:55:51Z",
        "updated_at": "2021-04-26T15:55:51Z",
        "author_association": "CONTRIBUTOR",
        "body": "In the past, on other projects, I've noticed that latency can be higher on an idle system because of heuristics that cause worker threads to block in the OS after some period of time. Then, when you perform a request, it takes longer because the cost of waking a blocked thread is much higher than passing a work item to an active thread.\r\n\r\nI'm not sure if this would explain the slowdown you are seeing here though.\r\n\r\n@tlh20 Could this be related to the spin-versus-sleep implementation in the threadpool? Is there a simple experiment with threadpool settings that @tomaszmi could try?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/826951191/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/826951916",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7449#issuecomment-826951916",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7449",
        "id": 826951916,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyNjk1MTkxNg==",
        "user": {
            "login": "mrry",
            "id": 192142,
            "node_id": "MDQ6VXNlcjE5MjE0Mg==",
            "avatar_url": "https://avatars.githubusercontent.com/u/192142?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mrry",
            "html_url": "https://github.com/mrry",
            "followers_url": "https://api.github.com/users/mrry/followers",
            "following_url": "https://api.github.com/users/mrry/following{/other_user}",
            "gists_url": "https://api.github.com/users/mrry/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mrry/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mrry/subscriptions",
            "organizations_url": "https://api.github.com/users/mrry/orgs",
            "repos_url": "https://api.github.com/users/mrry/repos",
            "events_url": "https://api.github.com/users/mrry/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mrry/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-26T15:56:54Z",
        "updated_at": "2021-04-26T15:56:54Z",
        "author_association": "CONTRIBUTOR",
        "body": "@tomaszmi In the meantime, if you could collect separate CPU profiles from the fast and slow regimes, that would probably help to diagnose the problem.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/826951916/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/826976100",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7449#issuecomment-826976100",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7449",
        "id": 826976100,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyNjk3NjEwMA==",
        "user": {
            "login": "tlh20",
            "id": 66783730,
            "node_id": "MDQ6VXNlcjY2NzgzNzMw",
            "avatar_url": "https://avatars.githubusercontent.com/u/66783730?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tlh20",
            "html_url": "https://github.com/tlh20",
            "followers_url": "https://api.github.com/users/tlh20/followers",
            "following_url": "https://api.github.com/users/tlh20/following{/other_user}",
            "gists_url": "https://api.github.com/users/tlh20/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tlh20/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tlh20/subscriptions",
            "organizations_url": "https://api.github.com/users/tlh20/orgs",
            "repos_url": "https://api.github.com/users/tlh20/repos",
            "events_url": "https://api.github.com/users/tlh20/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tlh20/received_events",
            "type": "User",
            "site_admin": true
        },
        "created_at": "2021-04-26T16:25:12Z",
        "updated_at": "2021-04-26T16:25:12Z",
        "author_association": "MEMBER",
        "body": "ORT provides control over whether to spin-then-block (default) or to block immediately via a session configuration option https://github.com/microsoft/onnxruntime/commit/679718b12f9f1afaae43f2f7f49d370abf1025b7.  I am not sure if that is exposed via WinML currently.  \r\n\r\nAt first glance the ~50ms degradation is longer than I would expect for having an extra pass through the OS scheduler, but it would be good to investigate further.  \r\n\r\nOne idea for exploring this is to take ORT's parallelism out of the picture by disabling multi-threading via https://docs.microsoft.com/en-us/windows/ai/windows-ml/native-apis/intraopnumthreads#:~:text=By%20default%2C%20WinML%20sets%20the%20value%20as%20the,in%20an%20inefficient%20threadpool%20and%20a%20slower%20evaluation.  If the effect is still seen with 1 thread then that suggests it is not related to the ORT thread pool's behavior -- there may well be spin-or-block or other heuristics in the system though.\r\n\r\nIf it is possible to collect a CPU scheduler trace that would be interesting.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/826976100/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/827862034",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7449#issuecomment-827862034",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7449",
        "id": 827862034,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzg2MjAzNA==",
        "user": {
            "login": "tomaszmi",
            "id": 4892955,
            "node_id": "MDQ6VXNlcjQ4OTI5NTU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4892955?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tomaszmi",
            "html_url": "https://github.com/tomaszmi",
            "followers_url": "https://api.github.com/users/tomaszmi/followers",
            "following_url": "https://api.github.com/users/tomaszmi/following{/other_user}",
            "gists_url": "https://api.github.com/users/tomaszmi/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tomaszmi/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tomaszmi/subscriptions",
            "organizations_url": "https://api.github.com/users/tomaszmi/orgs",
            "repos_url": "https://api.github.com/users/tomaszmi/repos",
            "events_url": "https://api.github.com/users/tomaszmi/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tomaszmi/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-04-27T19:30:30Z",
        "updated_at": "2021-04-27T19:30:30Z",
        "author_association": "NONE",
        "body": "Thank you for the responses and hints. I'm setting number of intra op threads to 1: https://github.com/tomaszmi/winml_inference_time/blob/24e052cddc5eb03be2f8ca834ea13e753a529fa4/main.cpp#L72 \r\n\r\nResults:\r\nInferences on CPU take much longer now however the trend is preserved, i.e. bigger delay makes longer inferences runs.\r\n\r\n![winml_cpu_1_thread_500_iterations](https://user-images.githubusercontent.com/4892955/116255795-df560900-a772-11eb-8e18-b5821b62247a.png)\r\n\r\n```\r\nnap_time\r\n0                  236  259  239.176   2.583481\r\n50                 235  274  242.128   7.411442\r\n100                235  291  248.838  12.268855\r\n150                237  283  256.486  11.041814\r\n200                235  280  247.884  11.404326\r\n```\r\n\r\nDuring that run I've profiled the CPU and GPU load (diagsession), the results are uploaded to my google drive (*.diagsession file ~250MB): https://drive.google.com/file/d/1IVZaXuAhaq55j5PDtv7yZE_O_oQZFnkT/view?usp=sharing\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/827862034/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/831750195",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7449#issuecomment-831750195",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7449",
        "id": 831750195,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgzMTc1MDE5NQ==",
        "user": {
            "login": "tomaszmi",
            "id": 4892955,
            "node_id": "MDQ6VXNlcjQ4OTI5NTU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4892955?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tomaszmi",
            "html_url": "https://github.com/tomaszmi",
            "followers_url": "https://api.github.com/users/tomaszmi/followers",
            "following_url": "https://api.github.com/users/tomaszmi/following{/other_user}",
            "gists_url": "https://api.github.com/users/tomaszmi/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tomaszmi/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tomaszmi/subscriptions",
            "organizations_url": "https://api.github.com/users/tomaszmi/orgs",
            "repos_url": "https://api.github.com/users/tomaszmi/repos",
            "events_url": "https://api.github.com/users/tomaszmi/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tomaszmi/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-05-04T07:51:55Z",
        "updated_at": "2021-05-04T07:51:55Z",
        "author_association": "NONE",
        "body": "Is there anything else I could do in order to help in solving this issue? Are you able to reproduce that behavior? Is there any solution coming soon? That issue prevents me in releasing winml-based functionality to production.\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/831750195/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/831922951",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7449#issuecomment-831922951",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7449",
        "id": 831922951,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgzMTkyMjk1MQ==",
        "user": {
            "login": "tlh20",
            "id": 66783730,
            "node_id": "MDQ6VXNlcjY2NzgzNzMw",
            "avatar_url": "https://avatars.githubusercontent.com/u/66783730?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tlh20",
            "html_url": "https://github.com/tlh20",
            "followers_url": "https://api.github.com/users/tlh20/followers",
            "following_url": "https://api.github.com/users/tlh20/following{/other_user}",
            "gists_url": "https://api.github.com/users/tlh20/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tlh20/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tlh20/subscriptions",
            "organizations_url": "https://api.github.com/users/tlh20/orgs",
            "repos_url": "https://api.github.com/users/tlh20/repos",
            "events_url": "https://api.github.com/users/tlh20/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tlh20/received_events",
            "type": "User",
            "site_admin": true
        },
        "created_at": "2021-05-04T13:01:01Z",
        "updated_at": "2021-05-04T13:01:01Z",
        "author_association": "MEMBER",
        "body": "@martinb35, @orilevari, do you have any thoughts on the issue here?  The investigation is showing longer latency serving requests if there is a ~100ms latency between requests rather than back-to-back.  Experiments showed the effect remains when setting intra-op threads to 1 (suggesting this is not coming from ORT thread pool sleep vs spin policies).  The effect remains when simplifying the workload to just use the CPU.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/831922951/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/847723573",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7449#issuecomment-847723573",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7449",
        "id": 847723573,
        "node_id": "MDEyOklzc3VlQ29tbWVudDg0NzcyMzU3Mw==",
        "user": {
            "login": "Fafa87",
            "id": 9865688,
            "node_id": "MDQ6VXNlcjk4NjU2ODg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9865688?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Fafa87",
            "html_url": "https://github.com/Fafa87",
            "followers_url": "https://api.github.com/users/Fafa87/followers",
            "following_url": "https://api.github.com/users/Fafa87/following{/other_user}",
            "gists_url": "https://api.github.com/users/Fafa87/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Fafa87/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Fafa87/subscriptions",
            "organizations_url": "https://api.github.com/users/Fafa87/orgs",
            "repos_url": "https://api.github.com/users/Fafa87/repos",
            "events_url": "https://api.github.com/users/Fafa87/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Fafa87/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-05-25T09:46:55Z",
        "updated_at": "2021-05-25T09:46:55Z",
        "author_association": "NONE",
        "body": "I also experience the similar problem. \r\nI need to tune the resource and battery usage of the application but it is not possible if this causes the runtime to go up. I think that it also makes the GPU usage go up which can cause a nasty feedback loop.\r\n\r\nIt would be great to be able to use WinML as it give a perfect abstraction to the wide range of Windows devices but it is kind of the blocker.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/847723573/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1008499600",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7449#issuecomment-1008499600",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7449",
        "id": 1008499600,
        "node_id": "IC_kwDOCVq1mM48HHuQ",
        "user": {
            "login": "feiyuhuahuo",
            "id": 32631344,
            "node_id": "MDQ6VXNlcjMyNjMxMzQ0",
            "avatar_url": "https://avatars.githubusercontent.com/u/32631344?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/feiyuhuahuo",
            "html_url": "https://github.com/feiyuhuahuo",
            "followers_url": "https://api.github.com/users/feiyuhuahuo/followers",
            "following_url": "https://api.github.com/users/feiyuhuahuo/following{/other_user}",
            "gists_url": "https://api.github.com/users/feiyuhuahuo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/feiyuhuahuo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/feiyuhuahuo/subscriptions",
            "organizations_url": "https://api.github.com/users/feiyuhuahuo/orgs",
            "repos_url": "https://api.github.com/users/feiyuhuahuo/repos",
            "events_url": "https://api.github.com/users/feiyuhuahuo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/feiyuhuahuo/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-01-10T02:43:28Z",
        "updated_at": "2022-01-10T02:45:24Z",
        "author_association": "NONE",
        "body": "The same problem for me on WIN10 with Python API. About my model, if I sleep from 20ms ~ 2000ms after each inference iteration, the inference time increases from 26ms~250ms. But there's no problem on UBUNTU20.04",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1008499600/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1054879550",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7449#issuecomment-1054879550",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7449",
        "id": 1054879550,
        "node_id": "IC_kwDOCVq1mM4-4C8-",
        "user": {
            "login": "fdwr",
            "id": 1809166,
            "node_id": "MDQ6VXNlcjE4MDkxNjY=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1809166?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/fdwr",
            "html_url": "https://github.com/fdwr",
            "followers_url": "https://api.github.com/users/fdwr/followers",
            "following_url": "https://api.github.com/users/fdwr/following{/other_user}",
            "gists_url": "https://api.github.com/users/fdwr/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/fdwr/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/fdwr/subscriptions",
            "organizations_url": "https://api.github.com/users/fdwr/orgs",
            "repos_url": "https://api.github.com/users/fdwr/repos",
            "events_url": "https://api.github.com/users/fdwr/events{/privacy}",
            "received_events_url": "https://api.github.com/users/fdwr/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-03-01T01:21:26Z",
        "updated_at": "2022-03-02T21:27:30Z",
        "author_association": "MEMBER",
        "body": "@tomaszmi: Laptop? This is common behavior on laptops for GPU battery saving where the video driver applies [dynamic frequency scaling](https://en.wikipedia.org/wiki/Dynamic_frequency_scaling), running in low power mode until enough frames have been submitted to increase performance. It occurs at the Nvidia graphics driver level, and I don't know that ORT can influence that :/. Ubuntu 20.04 uses a different graphics driver, and so that's why it's not seen on that OS, despite running the same ORT and same GPU. You might find some settings in the Nvidia control panel for that, but unfortunately it requires the user to configure it before running your application. e.g. This option looks promising (from adaptive to max/consistent):\r\n\r\n![image](https://user-images.githubusercontent.com/1809166/156086029-264b495c-38c9-414d-b77a-0012f9d5c43e.png)",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1054879550/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]