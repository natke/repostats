[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/955288994",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9627#issuecomment-955288994",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9627",
        "id": 955288994,
        "node_id": "IC_kwDOCVq1mM448I2i",
        "user": {
            "login": "krasznaa",
            "id": 30694331,
            "node_id": "MDQ6VXNlcjMwNjk0MzMx",
            "avatar_url": "https://avatars.githubusercontent.com/u/30694331?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/krasznaa",
            "html_url": "https://github.com/krasznaa",
            "followers_url": "https://api.github.com/users/krasznaa/followers",
            "following_url": "https://api.github.com/users/krasznaa/following{/other_user}",
            "gists_url": "https://api.github.com/users/krasznaa/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/krasznaa/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/krasznaa/subscriptions",
            "organizations_url": "https://api.github.com/users/krasznaa/orgs",
            "repos_url": "https://api.github.com/users/krasznaa/repos",
            "events_url": "https://api.github.com/users/krasznaa/events{/privacy}",
            "received_events_url": "https://api.github.com/users/krasznaa/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-10-30T15:06:14Z",
        "updated_at": "2021-10-30T15:06:14Z",
        "author_association": "NONE",
        "body": "To give some context: What we see is that the CUDA code compilation is happening in a very single-threaded/process way. I can only imagine that the compilation could be made more parallel by tweaking the CMake configuration of the project \"in the right way\".",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/955288994/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/955616454",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9627#issuecomment-955616454",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9627",
        "id": 955616454,
        "node_id": "IC_kwDOCVq1mM449YzG",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-10-31T01:00:17Z",
        "updated_at": "2021-10-31T01:00:17Z",
        "author_association": "MEMBER",
        "body": "What if you add the `--parallel` build flag? ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/955616454/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/956048720",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9627#issuecomment-956048720",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9627",
        "id": 956048720,
        "node_id": "IC_kwDOCVq1mM44_CVQ",
        "user": {
            "login": "Debottam",
            "id": 34949953,
            "node_id": "MDQ6VXNlcjM0OTQ5OTUz",
            "avatar_url": "https://avatars.githubusercontent.com/u/34949953?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Debottam",
            "html_url": "https://github.com/Debottam",
            "followers_url": "https://api.github.com/users/Debottam/followers",
            "following_url": "https://api.github.com/users/Debottam/following{/other_user}",
            "gists_url": "https://api.github.com/users/Debottam/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Debottam/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Debottam/subscriptions",
            "organizations_url": "https://api.github.com/users/Debottam/orgs",
            "repos_url": "https://api.github.com/users/Debottam/repos",
            "events_url": "https://api.github.com/users/Debottam/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Debottam/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-01T08:55:26Z",
        "updated_at": "2021-11-01T08:55:26Z",
        "author_association": "NONE",
        "body": "Hi @skottmckay ,\r\n\r\nThanks, but where is this flag `--parallel` defined ? I don't see it in https://github.com/microsoft/onnxruntime/blob/master/cmake/CMakeLists.txt. Don't we need it to be in CMakeLists.txt since we are building using CMake?\r\n\r\nThanks,\r\nDebo.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/956048720/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/956071671",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9627#issuecomment-956071671",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9627",
        "id": 956071671,
        "node_id": "IC_kwDOCVq1mM44_H73",
        "user": {
            "login": "krasznaa",
            "id": 30694331,
            "node_id": "MDQ6VXNlcjMwNjk0MzMx",
            "avatar_url": "https://avatars.githubusercontent.com/u/30694331?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/krasznaa",
            "html_url": "https://github.com/krasznaa",
            "followers_url": "https://api.github.com/users/krasznaa/followers",
            "following_url": "https://api.github.com/users/krasznaa/following{/other_user}",
            "gists_url": "https://api.github.com/users/krasznaa/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/krasznaa/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/krasznaa/subscriptions",
            "organizations_url": "https://api.github.com/users/krasznaa/orgs",
            "repos_url": "https://api.github.com/users/krasznaa/repos",
            "events_url": "https://api.github.com/users/krasznaa/events{/privacy}",
            "received_events_url": "https://api.github.com/users/krasznaa/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-01T09:27:01Z",
        "updated_at": "2021-11-01T09:27:01Z",
        "author_association": "NONE",
        "body": "Hi Scott,\r\n\r\nWe are not building the project through its build script(s). It's a long story why, but we rather configure the project's CMake build by hand. With this code:\r\n\r\nhttps://gitlab.cern.ch/atlas/atlasexternals/-/blob/master/External/onnxruntime/CMakeLists.txt\r\n\r\nHow much parallelism we get from the onnxruntime build depends on how much parallelism it can give us in the CMake-generated makefiles. And this is what prompted this ticket.\r\n  - In our current setup, which does not involve building the CUDA code of onnxruntime, the build goes as well as I'd imagine. The onnxruntime project is large, but it builds using all available cores of our build machine in a \"reasonable way\".\r\n  - When including the build of the CUDA sources with https://gitlab.cern.ch/atlas/atlasexternals/-/merge_requests/871, I see  the build on my system spending ~10 minutes compiling CUDA source files one-by-one. After having built all of the C\\+\\+ sources already as much as I can tell.\r\n\r\nI do not want to start debugging this project's CMake configuration. :frowning: But I'm absolutely sure that this serial build behaviour can not be intentional. It must be due to some mistake/typo in the build configuration somewhere.\r\n\r\nBest,\r\n         Attila",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/956071671/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/956121034",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9627#issuecomment-956121034",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9627",
        "id": 956121034,
        "node_id": "IC_kwDOCVq1mM44_T_K",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-01T10:37:43Z",
        "updated_at": "2021-11-01T10:37:43Z",
        "author_association": "MEMBER",
        "body": "The ORT build script will run cmake using the appropriate arguments for parallelization. e.g. https://github.com/microsoft/onnxruntime/blob/5247247b7fb5f45f589b8e8baf1b7c0011145dd0/tools/ci_build/build.py#L1178-L1189\r\n\r\nIf you are running cmake directly you most likely need to provide those yourself, either in the same way the ORT build script does, or potentially via the cmake `--parallel` argument.\r\nhttps://cmake.org/cmake/help/latest/release/3.12.html#command-line\r\n\r\nBased on the build script you may also want/need to set the onnxruntime_NVCC_THREADS cmake parameter. \r\nhttps://github.com/microsoft/onnxruntime/blob/5247247b7fb5f45f589b8e8baf1b7c0011145dd0/tools/ci_build/build.py#L813",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/956121034/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/956244895",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9627#issuecomment-956244895",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9627",
        "id": 956244895,
        "node_id": "IC_kwDOCVq1mM44_yOf",
        "user": {
            "login": "krasznaa",
            "id": 30694331,
            "node_id": "MDQ6VXNlcjMwNjk0MzMx",
            "avatar_url": "https://avatars.githubusercontent.com/u/30694331?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/krasznaa",
            "html_url": "https://github.com/krasznaa",
            "followers_url": "https://api.github.com/users/krasznaa/followers",
            "following_url": "https://api.github.com/users/krasznaa/following{/other_user}",
            "gists_url": "https://api.github.com/users/krasznaa/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/krasznaa/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/krasznaa/subscriptions",
            "organizations_url": "https://api.github.com/users/krasznaa/orgs",
            "repos_url": "https://api.github.com/users/krasznaa/repos",
            "events_url": "https://api.github.com/users/krasznaa/events{/privacy}",
            "received_events_url": "https://api.github.com/users/krasznaa/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-01T13:42:22Z",
        "updated_at": "2021-11-01T13:42:22Z",
        "author_association": "NONE",
        "body": ":confused: I did have a closer look. Though I was hoping that Debo and co would do this instead...\r\n\r\nSo I was wrong. It's not that building all the many `.cu` files one-by-one would take a long time. The problem is that building https://github.com/microsoft/onnxruntime/blob/v1.5.1/onnxruntime/core/providers/cuda/math/topk_impl.cu takes #@^&%@ forever. :confused:\r\n\r\nThe reason that I noticed this so clearly is that last week I was building onnxruntime on a fairly fast 64-thread machine. And the slowness of this one file ended up dominating the build as it seems. My educated guess was that it must be the build of multiple files one-by-one that would take minutes on that machine. But as it turns out, it was all just one file. (The confusing thing is that `nvcc` runs multiple downstream processes during the build, so in \"top\" I would never see any process with a particularly long lifetime.)\r\n\r\nI guess this is what you guys introduced `onnxruntime_NVCC_THREADS` for. :stuck_out_tongue: Unfortunately version 1.5.1, which we use, does not have this flag yet.\r\n\r\n@Debottam, as I asked in https://gitlab.cern.ch/atlas/atlasexternals/-/merge_requests/871, testing some newer versions of onnxruntime could help.\r\n\r\nBut for now I'd consider the case closed. Apparently in newer releases `onnxruntime_NVCC_THREADS` can be used to mitigate the issue somewhat. In 1.5.1 we'll just accept that this one source file takes forever to build...",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/956244895/reactions",
            "total_count": 1,
            "+1": 0,
            "-1": 0,
            "laugh": 1,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]