[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1501026557",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15429#issuecomment-1501026557",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15429",
        "id": 1501026557,
        "node_id": "IC_kwDOCVq1mM5Zd9j9",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-04-09T02:59:37Z",
        "updated_at": "2023-04-09T03:35:03Z",
        "author_association": "NONE",
        "body": "My experiment is not working so far because there appears to be a memory leak (DirectML c#). The code:\r\n\r\n```\r\n using (FixedBufferOnnxValue value = FixedBufferOnnxValue.CreateFromTensor(new DenseTensor<Float16>(float16s, dims)))\r\n  {\r\n      binding.BindInput(key, value); \r\n  }\r\n```\r\nPushes the float values onto the GPU but doesn't seem to release them from System Memory. So I can push the weights onto the GPU but can't clear up the RAM afterwards.\r\n\r\n![image](https://user-images.githubusercontent.com/33497043/230751892-b90790a6-f897-4459-aada-09540a766a0a.png)\r\n\r\n\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1501026557/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1501031771",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15429#issuecomment-1501031771",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15429",
        "id": 1501031771,
        "node_id": "IC_kwDOCVq1mM5Zd-1b",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-04-09T03:45:34Z",
        "updated_at": "2023-04-09T04:07:06Z",
        "author_association": "NONE",
        "body": "Update: I solved that memory \"leak\" with:\r\n\r\n```\r\n using (FixedBufferOnnxValue value = FixedBufferOnnxValue.CreateFromTensor(new DenseTensor<Float16>(float16s, dims)))\r\n  {\r\n      binding.BindInput(key, value);  binding.SynchronizeBoundInputs();\r\n  }\r\n```\r\n\r\n![image](https://user-images.githubusercontent.com/33497043/230753223-3ab654ab-cb21-4536-94c6-81882cf4a978.png)\r\n\r\nSo now my experiment can load in a 1.6GB onnx file with barely any RAM usage. Ideal for computers which are short on RAM.  ðŸ˜€ðŸš€ðŸŒ™\r\n\r\nThere is a tiny bit of RAM leakage but that might be other parts of my code.\r\n\r\nSo I solved the RAM issue now my speed issue is mainly how to get a load of ushorts from a file into a` Tensor<Float16>` array as fast as possible.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1501031771/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1501042451",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15429#issuecomment-1501042451",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15429",
        "id": 1501042451,
        "node_id": "IC_kwDOCVq1mM5ZeBcT",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-04-09T05:06:45Z",
        "updated_at": "2023-04-09T08:12:11Z",
        "author_association": "NONE",
        "body": "IHere are the results using the standard method. And the new RAM saving method:\r\n\r\n![image](https://user-images.githubusercontent.com/33497043/230755450-95967f0f-d285-44f0-92dd-1bffa684583f.png)\r\n\r\nMy next step might be to compress the weight files on the disk to also save on HD space.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1501042451/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1506276836",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15429#issuecomment-1506276836",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15429",
        "id": 1506276836,
        "node_id": "IC_kwDOCVq1mM5Zx_Xk",
        "user": {
            "login": "pranavsharma",
            "id": 2732907,
            "node_id": "MDQ6VXNlcjI3MzI5MDc=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2732907?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pranavsharma",
            "html_url": "https://github.com/pranavsharma",
            "followers_url": "https://api.github.com/users/pranavsharma/followers",
            "following_url": "https://api.github.com/users/pranavsharma/following{/other_user}",
            "gists_url": "https://api.github.com/users/pranavsharma/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pranavsharma/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pranavsharma/subscriptions",
            "organizations_url": "https://api.github.com/users/pranavsharma/orgs",
            "repos_url": "https://api.github.com/users/pranavsharma/repos",
            "events_url": "https://api.github.com/users/pranavsharma/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pranavsharma/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-04-13T03:21:07Z",
        "updated_at": "2023-04-13T03:21:07Z",
        "author_association": "MEMBER",
        "body": "@pauldog You've externalized the weights meaning you've arranged for the weights to be stored separately from the onnx model. ORT memory maps external weights. Not fully sure about Windows but on Linux this is definitely not counted as resident memory of the process. So, unless you intend to share these weights across many sessions or processes, this memory saving is a bit misleading.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1506276836/reactions",
            "total_count": 1,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 1,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1506373709",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15429#issuecomment-1506373709",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15429",
        "id": 1506373709,
        "node_id": "IC_kwDOCVq1mM5ZyXBN",
        "user": {
            "login": "pauldog",
            "id": 33497043,
            "node_id": "MDQ6VXNlcjMzNDk3MDQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/33497043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pauldog",
            "html_url": "https://github.com/pauldog",
            "followers_url": "https://api.github.com/users/pauldog/followers",
            "following_url": "https://api.github.com/users/pauldog/following{/other_user}",
            "gists_url": "https://api.github.com/users/pauldog/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pauldog/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pauldog/subscriptions",
            "organizations_url": "https://api.github.com/users/pauldog/orgs",
            "repos_url": "https://api.github.com/users/pauldog/repos",
            "events_url": "https://api.github.com/users/pauldog/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pauldog/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-04-13T05:37:25Z",
        "updated_at": "2023-04-13T05:59:54Z",
        "author_association": "NONE",
        "body": "> @pauldog You've externalized the weights meaning you've arranged for the weights to be stored separately from the onnx model. ORT memory maps external weights. Not fully sure about Windows but on Linux this is definitely not counted as resident memory of the process. So, unless you intend to share these weights across many sessions or processes, this memory saving is a bit misleading.\r\n\r\nSorry I think you misunderstood what I am doing. The point of all this is to load the model onto the GPU without a memory spike on RAM which can lead to out of memory exceptions. Once the model is loaded it is using exactly the same RAM and VRAM.\r\n\r\nThis means I can load a 12GB model into the VRAM without the RAM spiking by 24GB and causing a memory exception. Without externalising the weights this was not possible.\r\n\r\nTo reiterate, it is the **loader** that is using less RAM not the model itself. Which is very clear from my above memory reading which shows no spike when I load it this way.\r\n\r\nI tried to follow your instructions https://github.com/microsoft/onnxruntime/issues/15080 But I couldn't understand them as I am using C# so I did it this way.\r\n\r\nUnless I misunderstood and there's an easier way to avoid this memory spike? (Maybe there is no spike on Linux but there definitely is one on Windows even with external weights)\r\n\r\nI am using Windows because I am a game developer so these things need to run on Windows. I can't write software with memory spikes because it will crash people's computers.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1506373709/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]