[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1380363234",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14260#issuecomment-1380363234",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14260",
        "id": 1380363234,
        "node_id": "IC_kwDOCVq1mM5SRqvi",
        "user": {
            "login": "xadupre",
            "id": 22452781,
            "node_id": "MDQ6VXNlcjIyNDUyNzgx",
            "avatar_url": "https://avatars.githubusercontent.com/u/22452781?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/xadupre",
            "html_url": "https://github.com/xadupre",
            "followers_url": "https://api.github.com/users/xadupre/followers",
            "following_url": "https://api.github.com/users/xadupre/following{/other_user}",
            "gists_url": "https://api.github.com/users/xadupre/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/xadupre/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/xadupre/subscriptions",
            "organizations_url": "https://api.github.com/users/xadupre/orgs",
            "repos_url": "https://api.github.com/users/xadupre/repos",
            "events_url": "https://api.github.com/users/xadupre/events{/privacy}",
            "received_events_url": "https://api.github.com/users/xadupre/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-12T13:32:59Z",
        "updated_at": "2023-01-12T13:32:59Z",
        "author_association": "MEMBER",
        "body": "Every time a model is loaded, onnxruntime performs optimizations. You can disable them with `opts.graph_optimization_level = GraphOptimizationLevel.ORT_DISABLE_ALL`. You can also save the optimized model `opts.optimized_model_filepath = \"to_save_the_optimized_onnx_file.onnx\"` and use this one for the next InferenceSession.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1380363234/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1380369545",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14260#issuecomment-1380369545",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14260",
        "id": 1380369545,
        "node_id": "IC_kwDOCVq1mM5SRsSJ",
        "user": {
            "login": "Kobzol",
            "id": 4539057,
            "node_id": "MDQ6VXNlcjQ1MzkwNTc=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Kobzol",
            "html_url": "https://github.com/Kobzol",
            "followers_url": "https://api.github.com/users/Kobzol/followers",
            "following_url": "https://api.github.com/users/Kobzol/following{/other_user}",
            "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions",
            "organizations_url": "https://api.github.com/users/Kobzol/orgs",
            "repos_url": "https://api.github.com/users/Kobzol/repos",
            "events_url": "https://api.github.com/users/Kobzol/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Kobzol/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-12T13:38:00Z",
        "updated_at": "2023-01-12T13:38:00Z",
        "author_association": "NONE",
        "body": "The problem is not that it is slow to load/optimize any individual model, rather that there is probably some multithreading perf. issue when a large number of models is loaded and paralellism is used for model loading/optimization.\r\n\r\nThis problem persists even if I load an optimized model or if I disable optimizations.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1380369545/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1381070543",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14260#issuecomment-1381070543",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14260",
        "id": 1381070543,
        "node_id": "IC_kwDOCVq1mM5SUXbP",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-12T22:37:11Z",
        "updated_at": "2023-01-12T22:37:11Z",
        "author_association": "MEMBER",
        "body": "Why are you creating that many sessions? A session supports concurrent requests to run the model.\r\n\r\nEach session has its own threadpools and memory arena, so by creating a massive number of sessions you're really just increasing resource contention unnecessarily vs. the expected usage of making concurrent calls to InferenceSession::Run using a single session.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1381070543/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1381075025",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14260#issuecomment-1381075025",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14260",
        "id": 1381075025,
        "node_id": "IC_kwDOCVq1mM5SUYhR",
        "user": {
            "login": "Kobzol",
            "id": 4539057,
            "node_id": "MDQ6VXNlcjQ1MzkwNTc=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Kobzol",
            "html_url": "https://github.com/Kobzol",
            "followers_url": "https://api.github.com/users/Kobzol/followers",
            "following_url": "https://api.github.com/users/Kobzol/following{/other_user}",
            "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions",
            "organizations_url": "https://api.github.com/users/Kobzol/orgs",
            "repos_url": "https://api.github.com/users/Kobzol/repos",
            "events_url": "https://api.github.com/users/Kobzol/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Kobzol/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-12T22:44:03Z",
        "updated_at": "2023-01-12T22:44:03Z",
        "author_association": "NONE",
        "body": "I know that it's far from ideal. I just have 10k (different) models that I want to use in a single process (don't ask me why :D ). This is probably a niche use-case, but still it might be interesting to investigate.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1381075025/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1382267843",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14260#issuecomment-1382267843",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14260",
        "id": 1382267843,
        "node_id": "IC_kwDOCVq1mM5SY7vD",
        "user": {
            "login": "pranavsharma",
            "id": 2732907,
            "node_id": "MDQ6VXNlcjI3MzI5MDc=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2732907?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pranavsharma",
            "html_url": "https://github.com/pranavsharma",
            "followers_url": "https://api.github.com/users/pranavsharma/followers",
            "following_url": "https://api.github.com/users/pranavsharma/following{/other_user}",
            "gists_url": "https://api.github.com/users/pranavsharma/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/pranavsharma/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/pranavsharma/subscriptions",
            "organizations_url": "https://api.github.com/users/pranavsharma/orgs",
            "repos_url": "https://api.github.com/users/pranavsharma/repos",
            "events_url": "https://api.github.com/users/pranavsharma/events{/privacy}",
            "received_events_url": "https://api.github.com/users/pranavsharma/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-13T19:11:41Z",
        "updated_at": "2023-01-13T19:26:12Z",
        "author_association": "MEMBER",
        "body": "Each session creates its own allocator and threadpool. A couple of things to try:\r\n\r\n1. Limit the # of threads per session to 1 by configuring intra_op_num_threads. But with 10k models (sessions) you'll get 10k threads. Not surprisingly this will cause oversubscription.\r\n2. Instead of 1 you can use a global env with a global threadpool. This allows the sessions to share a common set of threads. However, now you'll have 10k models competing to run on N threads.\r\n3. Use and register a common allocator to be shared across sessions by using this API: CreateAndRegisterAllocator. This will help with reducing the memory usage due to the memory arena (created inside the allocator) significantly. However, it'll create contention when memory is requested due to the usage of a lock inside the Allocate function.\r\n4. If 3 is bad, turn off the arena altogether. However, this might cause a lot of memory fragmentation.\r\n\r\nI hope I've convinced you enough that no matter how you slide and dice it creating 10k sessions in a single process is a recipe for a lot of heartache. The simple solution is to just not do it. This might be a good opportunity to go back to the drawing board and examine your use case with a fine toothed comb.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1382267843/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1382305456",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14260#issuecomment-1382305456",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14260",
        "id": 1382305456,
        "node_id": "IC_kwDOCVq1mM5SZE6w",
        "user": {
            "login": "Kobzol",
            "id": 4539057,
            "node_id": "MDQ6VXNlcjQ1MzkwNTc=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Kobzol",
            "html_url": "https://github.com/Kobzol",
            "followers_url": "https://api.github.com/users/Kobzol/followers",
            "following_url": "https://api.github.com/users/Kobzol/following{/other_user}",
            "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions",
            "organizations_url": "https://api.github.com/users/Kobzol/orgs",
            "repos_url": "https://api.github.com/users/Kobzol/repos",
            "events_url": "https://api.github.com/users/Kobzol/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Kobzol/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-01-13T19:34:20Z",
        "updated_at": "2023-01-13T19:34:20Z",
        "author_association": "NONE",
        "body": "I know that the use case is bad (it's not my idea, I'm just supposed to make it run fast :) ).\r\n\r\nJust to be clear, I'm not worried about inference time, but rather about the loading time. It seems that there is some false sharing or similar bottleneck going on when so many models are loaded using multiple threads. I thought that maybe this could be interesting to examine, as possibly finding out and optimizing what causes it could also speed-up more common code.\r\n\r\nBut it's true that most users probably won't ever hit this. And if they do, this issue and your answer might help them find a potential solution. Thanks!",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1382305456/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]