[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1435283421",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14316#issuecomment-1435283421",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14316",
        "id": 1435283421,
        "node_id": "IC_kwDOCVq1mM5VjK_d",
        "user": {
            "login": "jstoecker",
            "id": 3835701,
            "node_id": "MDQ6VXNlcjM4MzU3MDE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3835701?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jstoecker",
            "html_url": "https://github.com/jstoecker",
            "followers_url": "https://api.github.com/users/jstoecker/followers",
            "following_url": "https://api.github.com/users/jstoecker/following{/other_user}",
            "gists_url": "https://api.github.com/users/jstoecker/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jstoecker/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jstoecker/subscriptions",
            "organizations_url": "https://api.github.com/users/jstoecker/orgs",
            "repos_url": "https://api.github.com/users/jstoecker/repos",
            "events_url": "https://api.github.com/users/jstoecker/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jstoecker/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-02-17T21:23:38Z",
        "updated_at": "2023-02-17T21:23:38Z",
        "author_association": "MEMBER",
        "body": "The [shape inference logic in the ONNX](https://github.com/onnx/onnx/blob/main/onnx/defs/math/defs.cc#L3471) definition looks a bit strange to me:\r\n\r\n```cpp\r\nbool is_onesided = static_cast<bool>(getAttribute(ctx, \"onesided\", 0));\r\nif (is_onesided) {\r\n  dft_size = is_onesided ? ((dft_size >> 1) + 1) : dft_size;\r\n}\r\n\r\nauto n_dfts = static_cast<int64_t>((signal_size - dft_size) / static_cast<float>(frame_step_value)) + 1;\r\n\r\n// The output has the following shape: [batch_size][frames][dft_unique_bins][2]\r\nONNX_NAMESPACE::TensorShapeProto result_shape_proto;\r\nresult_shape_proto.add_dim()->set_dim_value(input_shape.dim(0).dim_value()); // batch size\r\nresult_shape_proto.add_dim()->set_dim_value(n_dfts);\r\nresult_shape_proto.add_dim()->set_dim_value(dft_size);\r\nresult_shape_proto.add_dim()->set_dim_value(2);\r\n```\r\n\r\nIt looks like the author intended `dft_size` to represent the window/frame length, but then repurposed it to represent the `dft_unique_bins` mentioned in the description. That makes the math for computing `n_dfts` wrong. I would instead expect something like this:\r\n\r\n```diff\r\nbool is_onesided = static_cast<bool>(getAttribute(ctx, \"onesided\", 0));\r\n-if (is_onesided) {\r\n-  dft_size = is_onesided ? ((dft_size >> 1) + 1) : dft_size;\r\n-}\r\n+ int64_t dft_unique_bins = is_onesided ? ((dft_size >> 1) + 1) : dft_size;\r\n\r\nauto n_dfts = static_cast<int64_t>((signal_size - dft_size) / static_cast<float>(frame_step_value)) + 1;\r\n\r\n// The output has the following shape: [batch_size][frames][dft_unique_bins][2]\r\nONNX_NAMESPACE::TensorShapeProto result_shape_proto;\r\nresult_shape_proto.add_dim()->set_dim_value(input_shape.dim(0).dim_value()); // batch size\r\nresult_shape_proto.add_dim()->set_dim_value(n_dfts);\r\n-result_shape_proto.add_dim()->set_dim_value(dft_size);\r\n+result_shape_proto.add_dim()->set_dim_value(dft_unique_bins);\r\nresult_shape_proto.add_dim()->set_dim_value(2);\r\n```\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1435283421/reactions",
            "total_count": 3,
            "+1": 3,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]