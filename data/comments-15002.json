[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1464724071",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15002#issuecomment-1464724071",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15002",
        "id": 1464724071,
        "node_id": "IC_kwDOCVq1mM5XTepn",
        "user": {
            "login": "hariharans29",
            "id": 9969784,
            "node_id": "MDQ6VXNlcjk5Njk3ODQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9969784?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/hariharans29",
            "html_url": "https://github.com/hariharans29",
            "followers_url": "https://api.github.com/users/hariharans29/followers",
            "following_url": "https://api.github.com/users/hariharans29/following{/other_user}",
            "gists_url": "https://api.github.com/users/hariharans29/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/hariharans29/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/hariharans29/subscriptions",
            "organizations_url": "https://api.github.com/users/hariharans29/orgs",
            "repos_url": "https://api.github.com/users/hariharans29/repos",
            "events_url": "https://api.github.com/users/hariharans29/events{/privacy}",
            "received_events_url": "https://api.github.com/users/hariharans29/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-11T00:36:11Z",
        "updated_at": "2023-03-11T00:36:11Z",
        "author_association": "MEMBER",
        "body": "Hi @feihugis - I recall you saying that the model your team flighted also used CUDA Graph. Did you run into issues like the above while trying to capture the graph ? AFAIK - Cuda stream synchronize has always existed in the code. I wonder why we didn't see something like this while testing your model. ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1464724071/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1464728702",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15002#issuecomment-1464728702",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15002",
        "id": 1464728702,
        "node_id": "IC_kwDOCVq1mM5XTfx-",
        "user": {
            "login": "hariharans29",
            "id": 9969784,
            "node_id": "MDQ6VXNlcjk5Njk3ODQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9969784?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/hariharans29",
            "html_url": "https://github.com/hariharans29",
            "followers_url": "https://api.github.com/users/hariharans29/followers",
            "following_url": "https://api.github.com/users/hariharans29/following{/other_user}",
            "gists_url": "https://api.github.com/users/hariharans29/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/hariharans29/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/hariharans29/subscriptions",
            "organizations_url": "https://api.github.com/users/hariharans29/orgs",
            "repos_url": "https://api.github.com/users/hariharans29/repos",
            "events_url": "https://api.github.com/users/hariharans29/events{/privacy}",
            "received_events_url": "https://api.github.com/users/hariharans29/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-11T00:47:52Z",
        "updated_at": "2023-03-11T00:47:52Z",
        "author_association": "MEMBER",
        "body": "@tianleiwu - Could it be that in the \"large\" unet model, it is using a kernel that internally uses `cudaStreamSynchronize()` ? This may be one of the cases where we can't use CUDA Graphs unfortunately.\r\n\r\nFor the \"small\" model, it may be that the stream synchronize using op/kernel doesn't kick-in? If you look at the CUDA EP setup that captures the graph, we first finish capturing the graph in `OnRunEnd()` here - https://github.com/microsoft/onnxruntime/blob/a8ad0edbeb45a1733d5b062acc13c6b3ad08731b/onnxruntime/core/providers/cuda/cuda_execution_provider.cc#L387 and only then do the stream sync here - https://github.com/microsoft/onnxruntime/blob/a8ad0edbeb45a1733d5b062acc13c6b3ad08731b/onnxruntime/core/providers/cuda/cuda_execution_provider.cc#L397 before returning control back to the caller. \r\n\r\nUnfortunately, if one of the intermediate kernels it encounters between graph capture begin and graph capture end contains synchronization logic, it cannot be captured.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1464728702/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1505750151",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15002#issuecomment-1505750151",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15002",
        "id": 1505750151,
        "node_id": "IC_kwDOCVq1mM5Zv-yH",
        "user": {
            "login": "feihugis",
            "id": 5057740,
            "node_id": "MDQ6VXNlcjUwNTc3NDA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5057740?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/feihugis",
            "html_url": "https://github.com/feihugis",
            "followers_url": "https://api.github.com/users/feihugis/followers",
            "following_url": "https://api.github.com/users/feihugis/following{/other_user}",
            "gists_url": "https://api.github.com/users/feihugis/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/feihugis/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/feihugis/subscriptions",
            "organizations_url": "https://api.github.com/users/feihugis/orgs",
            "repos_url": "https://api.github.com/users/feihugis/repos",
            "events_url": "https://api.github.com/users/feihugis/events{/privacy}",
            "received_events_url": "https://api.github.com/users/feihugis/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-04-12T18:37:22Z",
        "updated_at": "2023-04-12T18:37:22Z",
        "author_association": "MEMBER",
        "body": "> Hi @feihugis - I recall you saying that the model your team flighted also used CUDA Graph. Did you run into issues like the above while trying to capture the graph ? AFAIK - Cuda stream synchronize has always existed in the code. I wonder why we didn't see something like this while testing your model.\r\n\r\nHi @hariharans29 and @tianleiwu sorry for the late response. I did not see this message and suddenly saw it when I search my email for something else.\r\n\r\nYes, the model we had mainstreamed around one year ago did not meet any issue when capturing the CUDA graph.\r\n\r\nRecently when I tried GPT2+Beam Search, I met similar issues. After making some codes changes (https://github.com/feihugis/onnxruntime/commit/de67b88bb775e7700f9a685511f0fab391c24cd6), CUDA Graph capturing can work, but as some of ops are not on GPU, the outputs are not correct. \r\n\r\nPlease feel free to ping me on Team if I missed your comments.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1505750151/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]