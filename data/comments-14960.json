[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1461538779",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14960#issuecomment-1461538779",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14960",
        "id": 1461538779,
        "node_id": "IC_kwDOCVq1mM5XHU_b",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-09T08:18:24Z",
        "updated_at": "2023-03-09T08:19:58Z",
        "author_association": "MEMBER",
        "body": "I did some debugging and found that memory pattern optimization has an [allocation](https://github.com/microsoft/onnxruntime/blob/d55ae490e19421a22ed17243bd2478a39ea72a56/onnxruntime/core/framework/execution_frame.cc#L431) that not happens in first run, but in the remaining runs. \r\n\r\nThat means sometime it need two runs to get enough memory allocated for fixed shape input. When arena memory in the first run has no enough free space left to cover the memory pattern buffer, there will be extra allocation in the second runs.\r\n\r\nIf input shape is dynamic, extra allocation might need when larger input is used (like larger batch_size or sequence_length).\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1461538779/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1462875143",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14960#issuecomment-1462875143",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14960",
        "id": 1462875143,
        "node_id": "IC_kwDOCVq1mM5XMbQH",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-09T21:52:37Z",
        "updated_at": "2023-03-09T21:53:28Z",
        "author_association": "MEMBER",
        "body": "@ardupros, you can try the following to see whether it is caused by memory pattern:\r\n```\r\n options = SessionOptions()\r\n options.enable_mem_pattern = False   # default is True\r\n session = InferenceSession(\"model.onnx\", options, providers=[\"CPUExecutionProvider\"])\r\n```",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1462875143/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1463403044",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/14960#issuecomment-1463403044",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/14960",
        "id": 1463403044,
        "node_id": "IC_kwDOCVq1mM5XOcIk",
        "user": {
            "login": "ardupros",
            "id": 6696798,
            "node_id": "MDQ6VXNlcjY2OTY3OTg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6696798?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ardupros",
            "html_url": "https://github.com/ardupros",
            "followers_url": "https://api.github.com/users/ardupros/followers",
            "following_url": "https://api.github.com/users/ardupros/following{/other_user}",
            "gists_url": "https://api.github.com/users/ardupros/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/ardupros/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ardupros/subscriptions",
            "organizations_url": "https://api.github.com/users/ardupros/orgs",
            "repos_url": "https://api.github.com/users/ardupros/repos",
            "events_url": "https://api.github.com/users/ardupros/events{/privacy}",
            "received_events_url": "https://api.github.com/users/ardupros/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-10T07:47:17Z",
        "updated_at": "2023-03-10T07:48:00Z",
        "author_association": "NONE",
        "body": "I did some experiments with different configurations. Here is an overview of the results whether an extra allocation is performed or not:\r\n| EP | batch size | mem_pattern | extra allocation |\r\n|---|---|---|---|\r\n| CPU | fixed | enabled  | yes |\r\n| CPU | fixed  | disabled | yes |\r\n| CPU | dynamic | enabled  | yes  |\r\n| CPU | dynamic | disabled  | yes  |\r\n| CUDA | fixed  | enabled  | yes  |\r\n| CUDA | fixed   | disabled  | no |\r\n| CUDA | dynamic  | enabled  | no |\r\n| CUDA | dynamic  | disabled  | no |\r\n\r\nInput size is always set to 1x3x640x640, regardless whether batch-dimension of the .onnx-model is fixed to 1 or dynamic.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1463403044/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]