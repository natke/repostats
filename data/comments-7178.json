[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/810036215",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7178#issuecomment-810036215",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7178",
        "id": 810036215,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgxMDAzNjIxNQ==",
        "user": {
            "login": "yongxin3344520",
            "id": 31799392,
            "node_id": "MDQ6VXNlcjMxNzk5Mzky",
            "avatar_url": "https://avatars.githubusercontent.com/u/31799392?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yongxin3344520",
            "html_url": "https://github.com/yongxin3344520",
            "followers_url": "https://api.github.com/users/yongxin3344520/followers",
            "following_url": "https://api.github.com/users/yongxin3344520/following{/other_user}",
            "gists_url": "https://api.github.com/users/yongxin3344520/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yongxin3344520/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yongxin3344520/subscriptions",
            "organizations_url": "https://api.github.com/users/yongxin3344520/orgs",
            "repos_url": "https://api.github.com/users/yongxin3344520/repos",
            "events_url": "https://api.github.com/users/yongxin3344520/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yongxin3344520/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-03-30T08:43:34Z",
        "updated_at": "2021-03-30T08:43:34Z",
        "author_association": "NONE",
        "body": "If on cpu, it is  the same problem . ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/810036215/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/810265823",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7178#issuecomment-810265823",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7178",
        "id": 810265823,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgxMDI2NTgyMw==",
        "user": {
            "login": "Craigacp",
            "id": 729696,
            "node_id": "MDQ6VXNlcjcyOTY5Ng==",
            "avatar_url": "https://avatars.githubusercontent.com/u/729696?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Craigacp",
            "html_url": "https://github.com/Craigacp",
            "followers_url": "https://api.github.com/users/Craigacp/followers",
            "following_url": "https://api.github.com/users/Craigacp/following{/other_user}",
            "gists_url": "https://api.github.com/users/Craigacp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Craigacp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Craigacp/subscriptions",
            "organizations_url": "https://api.github.com/users/Craigacp/orgs",
            "repos_url": "https://api.github.com/users/Craigacp/repos",
            "events_url": "https://api.github.com/users/Craigacp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Craigacp/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-03-30T13:49:12Z",
        "updated_at": "2021-03-30T13:49:12Z",
        "author_association": "CONTRIBUTOR",
        "body": "We'll need a bit more information to figure out what's going on.\r\n- What are you including in the measurement time (e.g. OnnxTensor creation, or just the OrtSession.run call)?\r\n- Is this after the JVM has warmed up by executing some number of iterations?\r\n- How are you creating the input tensor?\r\n- What kind of output is it, and how do you extract the output values from the output?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/810265823/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/810709618",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7178#issuecomment-810709618",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7178",
        "id": 810709618,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgxMDcwOTYxOA==",
        "user": {
            "login": "yongxin3344520",
            "id": 31799392,
            "node_id": "MDQ6VXNlcjMxNzk5Mzky",
            "avatar_url": "https://avatars.githubusercontent.com/u/31799392?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yongxin3344520",
            "html_url": "https://github.com/yongxin3344520",
            "followers_url": "https://api.github.com/users/yongxin3344520/followers",
            "following_url": "https://api.github.com/users/yongxin3344520/following{/other_user}",
            "gists_url": "https://api.github.com/users/yongxin3344520/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yongxin3344520/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yongxin3344520/subscriptions",
            "organizations_url": "https://api.github.com/users/yongxin3344520/orgs",
            "repos_url": "https://api.github.com/users/yongxin3344520/repos",
            "events_url": "https://api.github.com/users/yongxin3344520/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yongxin3344520/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-03-31T02:27:11Z",
        "updated_at": "2021-03-31T02:32:10Z",
        "author_association": "NONE",
        "body": "> We'll need a bit more information to figure out what's going on.\r\n> \r\n> * What are you including in the measurement time (e.g. OnnxTensor creation, or just the OrtSession.run call)?  \r\n> * Is this after the JVM has warmed up by executing some number of iterations?    \r\n> * How are you creating the input tensor?\r\n> * What kind of output is it, and how do you extract the output values from the output?\r\n\r\n1.  Run time and total time .\r\n2.  Yes.\r\n3.  OnnxTensor.createTensor(env, data)  // data = float[][][][] \r\n4.  Session.run(container).get(0).getValue();\r\n\r\nHere is test result,\r\non cuda:\r\n          shape:   -1, 3, -1, -1\r\n          Batch total cost:1921 session run cost:929\r\n          One by one total cost:1531 session run cost:530\r\non cpu:\r\n          shape:   -1, 3, -1, -1\r\n         Batch total cost:2962 session run cost:1967\r\n         One by one total cost:2057 session run cost:1039\r\n\r\nHere's my code：（Win10,  JDK 1.8.0_181 ， Onnxruntime version  1.7.0 gpu ），Please correct if there is anything wrong ， thank you very much ！\r\n\r\nMaven :\r\n       <dependency>\r\n            <groupId>com.microsoft.onnxruntime</groupId>\r\n            <artifactId>onnxruntime_gpu</artifactId>\r\n            <version>1.7.0</version>\r\n        </dependency>\r\n\r\nCode ：\r\n\r\n\r\nimport ai.onnxruntime.*;\r\nimport java.util.HashMap;\r\nimport java.util.Map;\r\n\r\npublic class BatchTest {\r\n\r\n    public static void main(String[] args) throws Exception{\r\n\r\n        //   Down from  https://github.com/yongxin3344520/play_test.git\r\n        String model = \"det.onnx\"; \r\n        String device = \"CUDA.11.2\" ;\r\n       // device = \"cpu\" ;\r\n\r\n        OrtEnvironment env =  OrtEnvironment.getEnvironment();\r\n        OrtSession.SessionOptions sessionOptions = new OrtSession.SessionOptions();\r\n        if (device.toUpperCase().startsWith(\"CUDA\")){\r\n            // ON GPU\r\n            sessionOptions.addCUDA();\r\n        }else {\r\n            // on cpu\r\n        }\r\n        OrtSession session  = env.createSession(model, sessionOptions);\r\n        //Get input info\r\n        Map<String, NodeInfo> inputMetaMap = session.getInputInfo();\r\n        NodeInfo inputMeta = inputMetaMap.values().iterator().next();\r\n        String inputName = inputMeta.getName();\r\n        long[] inputShape = ((TensorInfo) inputMeta.getInfo()).getShape();  //You can write [n, c, h, w] if you know\r\n        System.out.println(inputShape[0] + \", \" + inputShape[1] + \", \" + inputShape[2] + \", \" + inputShape[3]);\r\n\r\n        // warmed up twice batch\r\n        for (int i=0; i<2; i++){\r\n            float[][][][] input = new float[10][3][1248][1760];\r\n            run(env, session, inputName, input);\r\n        }\r\n        // warmed up twice one by one\r\n        for (int i=0; i<20; i++){\r\n            float[][][][] input = new float[1][3][1248][1760];\r\n            run(env, session, inputName, input);\r\n        }\r\n\r\n        // test\r\n        float[][][][] input = new float[20][3][640][640];\r\n        int n = input.length;\r\n        int c = input[0].length;\r\n        int h = input[0][0].length;\r\n        int w = input[0][0][0].length;\r\n        //1. batch\r\n        long[] tmp = run(env, session, inputName, input);\r\n        long run_cost1 = tmp[0];\r\n        long total_cost1 = tmp[1];\r\n\r\n        // 2. one by one\r\n        long run_cost2 = 0 ;\r\n        long total_cost2 = 0 ;\r\n        for (int i=0; i<n; i++){\r\n            float[][][][] inputOne = new float[1][c][h][w];\r\n            inputOne[0] = input[i];\r\n\r\n            tmp = run(env, session, inputName, inputOne);\r\n\r\n            run_cost2 += tmp[0];\r\n            total_cost2 += tmp[1];\r\n        }\r\n\r\n        System.out.println(\"Batch total cost:\"+total_cost1 +\" session run cost:\"+run_cost1);\r\n        System.out.println(\"One by one total cost:\"+total_cost2 +\" session run cost:\"+run_cost2);\r\n    }\r\n\r\n    // return [session.run , total] cost time\r\n    private static long[] run( OrtEnvironment env, OrtSession session, String inputName, float[][][][] data) throws Exception {\r\n        long t0 = System.currentTimeMillis();\r\n        OnnxTensor inputTensor = OnnxTensor.createTensor(env, data);\r\n        Map<String, OnnxTensor> container = new HashMap<>();\r\n        container.put(inputName, inputTensor);\r\n        long t1 = System.currentTimeMillis();\r\n        OrtSession.Result batchResults =  session.run(container);\r\n        long t2 = System.currentTimeMillis();\r\n        Object batchValue = batchResults.get(0).getValue();\r\n        batchResults.close();\r\n        inputTensor.close();\r\n        long t3 = System.currentTimeMillis();\r\n        return new long[]{t2-t1, t3-t0};\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/810709618/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/810731701",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/7178#issuecomment-810731701",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/7178",
        "id": 810731701,
        "node_id": "MDEyOklzc3VlQ29tbWVudDgxMDczMTcwMQ==",
        "user": {
            "login": "Craigacp",
            "id": 729696,
            "node_id": "MDQ6VXNlcjcyOTY5Ng==",
            "avatar_url": "https://avatars.githubusercontent.com/u/729696?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Craigacp",
            "html_url": "https://github.com/Craigacp",
            "followers_url": "https://api.github.com/users/Craigacp/followers",
            "following_url": "https://api.github.com/users/Craigacp/following{/other_user}",
            "gists_url": "https://api.github.com/users/Craigacp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Craigacp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Craigacp/subscriptions",
            "organizations_url": "https://api.github.com/users/Craigacp/orgs",
            "repos_url": "https://api.github.com/users/Craigacp/repos",
            "events_url": "https://api.github.com/users/Craigacp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Craigacp/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-03-31T03:30:34Z",
        "updated_at": "2021-03-31T03:30:51Z",
        "author_association": "CONTRIBUTOR",
        "body": "So one problem is that you're using Java's multidimensional arrays rather than `java.nio.Buffer` as inputs which incurs a massive nested pointer traversal and copying cost to build the `OnnxTensor`. You want the `OnnxTensor createTensor(OrtEnvironment env, FloatBuffer data, long[] shape)` method, supplying a `FloatBuffer` containing the values in row-major order and a long array [10,3,1248,1760] (or whatever the precise shape is) for the shape. Similarly you should use the `OnnxTensor.getFloatBuffer()` method to get the result back out as if it's a multidimensional array the copy back out from native land is also expensive.\r\n\r\nTo properly warm up the JVM usually requires executing something hundreds or thousands of times, it's designed for long running processes so 10 runs probably isn't enough to get the compilers to kick in and it's definitely not enough to get C2 or Graal to kick in. I don't think that's going to make much difference to your test program, but it's worth keeping in mind for other Java benchmarking.\r\n\r\nI admit I'm puzzled as to why the batch call to `session.run` is slower than executing each example one at a time on GPU. Is this model slower in batch inference using another API (or another framework)? I think to get better performance out of the batching on CPU you might need to bump up the number of threads in the session, as by default it's limited to 1 thread.\r\n\r\nThe session runner is also thread safe, so you could supply all 10 examples at the same time, and that might be an interesting comparison point.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/810731701/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]