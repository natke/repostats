[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1111625362",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11384#issuecomment-1111625362",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11384",
        "id": 1111625362,
        "node_id": "IC_kwDOCVq1mM5CQg6S",
        "user": {
            "login": "yetingqiaqia",
            "id": 6299908,
            "node_id": "MDQ6VXNlcjYyOTk5MDg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6299908?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yetingqiaqia",
            "html_url": "https://github.com/yetingqiaqia",
            "followers_url": "https://api.github.com/users/yetingqiaqia/followers",
            "following_url": "https://api.github.com/users/yetingqiaqia/following{/other_user}",
            "gists_url": "https://api.github.com/users/yetingqiaqia/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yetingqiaqia/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yetingqiaqia/subscriptions",
            "organizations_url": "https://api.github.com/users/yetingqiaqia/orgs",
            "repos_url": "https://api.github.com/users/yetingqiaqia/repos",
            "events_url": "https://api.github.com/users/yetingqiaqia/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yetingqiaqia/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-04-28T01:02:25Z",
        "updated_at": "2022-04-28T01:02:25Z",
        "author_association": "MEMBER",
        "body": "Sorry, I was using a wrong permission on the shared file. Now, it has been changed to the right permission. Please retry if you met permission issue on viewing the shared file. Thanks. ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1111625362/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112410783",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11384#issuecomment-1112410783",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11384",
        "id": 1112410783,
        "node_id": "IC_kwDOCVq1mM5CTgqf",
        "user": {
            "login": "garymm",
            "id": 421339,
            "node_id": "MDQ6VXNlcjQyMTMzOQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/421339?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/garymm",
            "html_url": "https://github.com/garymm",
            "followers_url": "https://api.github.com/users/garymm/followers",
            "following_url": "https://api.github.com/users/garymm/following{/other_user}",
            "gists_url": "https://api.github.com/users/garymm/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/garymm/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/garymm/subscriptions",
            "organizations_url": "https://api.github.com/users/garymm/orgs",
            "repos_url": "https://api.github.com/users/garymm/repos",
            "events_url": "https://api.github.com/users/garymm/events{/privacy}",
            "received_events_url": "https://api.github.com/users/garymm/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-04-28T16:26:16Z",
        "updated_at": "2022-04-28T16:26:16Z",
        "author_association": "CONTRIBUTOR",
        "body": "@yetingqiaqia it's somewhat suspicious that the `test` always uses float32 as the input type. Can you try using float16 data as the input to the float16 model? If that fixes it, then I guess just close this issue.\r\nCan you try using the CPU Execution Provider? If that fixes it, then the problem is with the CUDA Execution Provider.\r\n\r\nIf neither of those work, please file an issue in https://github.com/microsoft/onnxconverter-common and CC me and xiaowuhu.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112410783/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112473126",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11384#issuecomment-1112473126",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11384",
        "id": 1112473126,
        "node_id": "IC_kwDOCVq1mM5CTv4m",
        "user": {
            "login": "BowenBao",
            "id": 9376104,
            "node_id": "MDQ6VXNlcjkzNzYxMDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9376104?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/BowenBao",
            "html_url": "https://github.com/BowenBao",
            "followers_url": "https://api.github.com/users/BowenBao/followers",
            "following_url": "https://api.github.com/users/BowenBao/following{/other_user}",
            "gists_url": "https://api.github.com/users/BowenBao/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/BowenBao/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/BowenBao/subscriptions",
            "organizations_url": "https://api.github.com/users/BowenBao/orgs",
            "repos_url": "https://api.github.com/users/BowenBao/repos",
            "events_url": "https://api.github.com/users/BowenBao/events{/privacy}",
            "received_events_url": "https://api.github.com/users/BowenBao/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-04-28T17:29:06Z",
        "updated_at": "2022-04-28T17:29:06Z",
        "author_association": "MEMBER",
        "body": "Hi @yetingqiaqia, please resort to this tool https://github.com/microsoft/onnxconverter-common/blob/master/onnxconverter_common/auto_mixed_precision.py to properly convert fp32 model to fp16 model. ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112473126/reactions",
            "total_count": 3,
            "+1": 3,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112490871",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11384#issuecomment-1112490871",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11384",
        "id": 1112490871,
        "node_id": "IC_kwDOCVq1mM5CT0N3",
        "user": {
            "login": "garymm",
            "id": 421339,
            "node_id": "MDQ6VXNlcjQyMTMzOQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/421339?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/garymm",
            "html_url": "https://github.com/garymm",
            "followers_url": "https://api.github.com/users/garymm/followers",
            "following_url": "https://api.github.com/users/garymm/following{/other_user}",
            "gists_url": "https://api.github.com/users/garymm/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/garymm/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/garymm/subscriptions",
            "organizations_url": "https://api.github.com/users/garymm/orgs",
            "repos_url": "https://api.github.com/users/garymm/repos",
            "events_url": "https://api.github.com/users/garymm/events{/privacy}",
            "received_events_url": "https://api.github.com/users/garymm/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-04-28T17:43:15Z",
        "updated_at": "2022-04-28T17:43:15Z",
        "author_association": "CONTRIBUTOR",
        "body": "@BowenBao should we delete onnxmltools.utils.float16_converter?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112490871/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112545793",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11384#issuecomment-1112545793",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11384",
        "id": 1112545793,
        "node_id": "IC_kwDOCVq1mM5CUBoB",
        "user": {
            "login": "BowenBao",
            "id": 9376104,
            "node_id": "MDQ6VXNlcjkzNzYxMDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9376104?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/BowenBao",
            "html_url": "https://github.com/BowenBao",
            "followers_url": "https://api.github.com/users/BowenBao/followers",
            "following_url": "https://api.github.com/users/BowenBao/following{/other_user}",
            "gists_url": "https://api.github.com/users/BowenBao/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/BowenBao/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/BowenBao/subscriptions",
            "organizations_url": "https://api.github.com/users/BowenBao/orgs",
            "repos_url": "https://api.github.com/users/BowenBao/repos",
            "events_url": "https://api.github.com/users/BowenBao/events{/privacy}",
            "received_events_url": "https://api.github.com/users/BowenBao/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-04-28T18:48:07Z",
        "updated_at": "2022-04-28T18:53:35Z",
        "author_association": "MEMBER",
        "body": "> @BowenBao should we delete onnxmltools.utils.float16_converter?\r\n\r\nIndeed it feels more reasonable to replace the lower level `float16` apis with `auto_mixed_precision` api. Or at least add the latter there.\r\n\r\nCreated https://github.com/onnx/onnxmltools/pull/543",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112545793/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112762785",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11384#issuecomment-1112762785",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11384",
        "id": 1112762785,
        "node_id": "IC_kwDOCVq1mM5CU2mh",
        "user": {
            "login": "yetingqiaqia",
            "id": 6299908,
            "node_id": "MDQ6VXNlcjYyOTk5MDg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6299908?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yetingqiaqia",
            "html_url": "https://github.com/yetingqiaqia",
            "followers_url": "https://api.github.com/users/yetingqiaqia/followers",
            "following_url": "https://api.github.com/users/yetingqiaqia/following{/other_user}",
            "gists_url": "https://api.github.com/users/yetingqiaqia/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yetingqiaqia/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yetingqiaqia/subscriptions",
            "organizations_url": "https://api.github.com/users/yetingqiaqia/orgs",
            "repos_url": "https://api.github.com/users/yetingqiaqia/repos",
            "events_url": "https://api.github.com/users/yetingqiaqia/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yetingqiaqia/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-04-29T00:04:31Z",
        "updated_at": "2022-04-29T00:04:31Z",
        "author_association": "MEMBER",
        "body": "Thanks @BowenBao . ```auto_mixed_precision``` api works. \r\nI found two issues:\r\n1. The first one is a tiny one that I have to call ```auto_mixed_precision.auto_convert_mixed_precision()``` instead of ```auto_convert_mixed_precision() ``` in your file comments.\r\n\r\nExample code: \r\n```python\r\ndef convert_float32_to_mixed_precision(fp32_model_path, mixed_precision_model_path):\r\n    from onnxconverter_common import auto_mixed_precision\r\n    import onnx\r\n\r\n    model = onnx.load(fp32_model_path)\r\n\r\n    import numpy as np\r\n    np.random.seed(123)\r\n    test_data = {\"input_image\": 2*np.random.rand(8, 3, 384, 384).astype(np.float32)-1.0}\r\n\r\n    # Could also use rtol/atol attributes directly instead of this\r\n    def validate(res1, res2):\r\n        for r1, r2 in zip(res1, res2):\r\n            if not np.allclose(r1, r2, rtol=0.01, atol=0.001):\r\n                return False\r\n        return True\r\n\r\n    model_fp16 = auto_mixed_precision.auto_convert_mixed_precision(model, test_data, validate, keep_io_types=True)\r\n    onnx.save(model_fp16, mixed_precision_model_path)\r\n\r\nfp32_model_path = './ConvNext-XL/graph.onnx'\r\nmixed_precision_model_path = './ConvNext-XL_mixed_precision/graph_mixed_precision.onnx'\r\n\r\nprint(\"Convert to mixed precision starts...\")\r\nconvert_float32_to_mixed_precision(fp32_model_path, mixed_precision_model_path)\r\nprint(\"Conversion finished.\")\r\n```\r\n\r\n2. The second one, a big concern is, this ```auto_convert_mixed_precision() ``` api is so slow, it seems to scan a range of combinations to find the optimal one. For example, in my case, it attempted 52 times, which took 16mins to finish. \r\nIt is OK for end users as they only need to convert it once. However, it will be an issue for us. We actually maintain a DL platform called [AdsBrain](https://aka.ms/adsbrain) which serves lots of users' models. We will by default run the model with fp16 to shorten the serving time. We prefer the fp16 conversion to be fast. For example, in our platform, we use ```graph_options=tf.GraphOptions(enable_bfloat16_sendrecv=True)``` for Tensorflow models, and for pyTorch, it has ```torch.cuda.amp```; ``convert_float_to_float16_model_path()``` for ONNX. For onnx, if users' models are fp32 models, they will be converted to fp16.  But if the ONNX fp16 conversion is so slow, it will be a huge cost. \r\n\r\nSo, if ```auto_convert_mixed_precision()``` couldn't run faster. We will still prefer to call  ```convert_float_to_float16_model_path()``` for Onnx fp32 models in our scenarios. However, your new api also help a lot. If any users meet this nan issue in the future. We would ask them to call this api to convert to mixed_precision model first and then run on our platform. \r\nThanks.\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112762785/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112766484",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11384#issuecomment-1112766484",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11384",
        "id": 1112766484,
        "node_id": "IC_kwDOCVq1mM5CU3gU",
        "user": {
            "login": "yetingqiaqia",
            "id": 6299908,
            "node_id": "MDQ6VXNlcjYyOTk5MDg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6299908?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/yetingqiaqia",
            "html_url": "https://github.com/yetingqiaqia",
            "followers_url": "https://api.github.com/users/yetingqiaqia/followers",
            "following_url": "https://api.github.com/users/yetingqiaqia/following{/other_user}",
            "gists_url": "https://api.github.com/users/yetingqiaqia/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/yetingqiaqia/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/yetingqiaqia/subscriptions",
            "organizations_url": "https://api.github.com/users/yetingqiaqia/orgs",
            "repos_url": "https://api.github.com/users/yetingqiaqia/repos",
            "events_url": "https://api.github.com/users/yetingqiaqia/events{/privacy}",
            "received_events_url": "https://api.github.com/users/yetingqiaqia/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-04-29T00:12:06Z",
        "updated_at": "2022-04-29T00:12:06Z",
        "author_association": "MEMBER",
        "body": "Thanks @garymm . float32 as input is by purpose, which shouldn't bring in the ```nan``` issue. In the convert APIs both in ```auto_convert_mixed_precision()``` and ```convert_float_to_float16_model_path()```, you can see a parameter called ```keep_io_types=True```. By enabling this parameter, the original IO types will be kept. And this feature was asked by our AdsBrain users.\r\n\r\nFor deleting the ```onnxmltools.utils.float16_converter```, my personal opinion is that I wouldn't want to delete it if the ```auto_convert_mixed_precision()``` couldn't run faster. I have explained my concern in previous comment. \r\nThanks.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112766484/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112796893",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11384#issuecomment-1112796893",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11384",
        "id": 1112796893,
        "node_id": "IC_kwDOCVq1mM5CU-7d",
        "user": {
            "login": "garymm",
            "id": 421339,
            "node_id": "MDQ6VXNlcjQyMTMzOQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/421339?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/garymm",
            "html_url": "https://github.com/garymm",
            "followers_url": "https://api.github.com/users/garymm/followers",
            "following_url": "https://api.github.com/users/garymm/following{/other_user}",
            "gists_url": "https://api.github.com/users/garymm/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/garymm/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/garymm/subscriptions",
            "organizations_url": "https://api.github.com/users/garymm/orgs",
            "repos_url": "https://api.github.com/users/garymm/repos",
            "events_url": "https://api.github.com/users/garymm/events{/privacy}",
            "received_events_url": "https://api.github.com/users/garymm/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-04-29T01:17:43Z",
        "updated_at": "2022-04-29T01:17:43Z",
        "author_association": "CONTRIBUTOR",
        "body": "Let's continue the discussion of what to do about the two APIs in https://github.com/onnx/onnxmltools/pull/543.\r\nClosing this since the issue is resolved.\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112796893/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112797389",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/11384#issuecomment-1112797389",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/11384",
        "id": 1112797389,
        "node_id": "IC_kwDOCVq1mM5CU_DN",
        "user": {
            "login": "hariharans29",
            "id": 9969784,
            "node_id": "MDQ6VXNlcjk5Njk3ODQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9969784?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/hariharans29",
            "html_url": "https://github.com/hariharans29",
            "followers_url": "https://api.github.com/users/hariharans29/followers",
            "following_url": "https://api.github.com/users/hariharans29/following{/other_user}",
            "gists_url": "https://api.github.com/users/hariharans29/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/hariharans29/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/hariharans29/subscriptions",
            "organizations_url": "https://api.github.com/users/hariharans29/orgs",
            "repos_url": "https://api.github.com/users/hariharans29/repos",
            "events_url": "https://api.github.com/users/hariharans29/events{/privacy}",
            "received_events_url": "https://api.github.com/users/hariharans29/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-04-29T01:19:01Z",
        "updated_at": "2022-04-29T01:19:07Z",
        "author_association": "MEMBER",
        "body": "Thanks @BowenBao and @garymm !",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1112797389/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]