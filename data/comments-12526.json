[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1210009739",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/12526#issuecomment-1210009739",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/12526",
        "id": 1210009739,
        "node_id": "IC_kwDOCVq1mM5IH0iL",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-08-10T00:07:53Z",
        "updated_at": "2022-08-10T00:32:50Z",
        "author_association": "MEMBER",
        "body": "I think you will need export a model by adding labels to inputs and loss to the outputs. See corresponding part in python:\r\nhttps://github.com/huggingface/transformers/blob/8cf4a6f0a63ed3aeed68192a9304fed2bd0ce100/src/transformers/models/gpt2/modeling_gpt2.py#L1087-L1094\r\n\r\nYou will need update the interface like\r\n```\r\n def forward(self, labels, input_ids, position_ids, attention_mask, *past):\r\n       result = super().forward(\r\n          input_ids,\r\n          labels=labels,\r\n          position_ids=position_ids,\r\n          attention_mask=attention_mask,\r\n          past_key_values=past,\r\n          return_dict=False,\r\n      )\r\n      // TODO: get loss from result, and other output fields. You can set a break point here in debugger.\r\n      loss = get_loss(result)\r\n      return loss, other_results\r\n```\r\nWhen the logic is exported to ONNX, you shall see some nodes added to the graph to compute loss based on logits and labels.\r\n\r\nYou can also export loss calculation to another ONNX model with logits and labels as inputs, and loss as outputs. Just warp the above python code to a class, then export it to onnx.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1210009739/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1210271383",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/12526#issuecomment-1210271383",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/12526",
        "id": 1210271383,
        "node_id": "IC_kwDOCVq1mM5II0aX",
        "user": {
            "login": "OriAlpha",
            "id": 41699212,
            "node_id": "MDQ6VXNlcjQxNjk5MjEy",
            "avatar_url": "https://avatars.githubusercontent.com/u/41699212?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/OriAlpha",
            "html_url": "https://github.com/OriAlpha",
            "followers_url": "https://api.github.com/users/OriAlpha/followers",
            "following_url": "https://api.github.com/users/OriAlpha/following{/other_user}",
            "gists_url": "https://api.github.com/users/OriAlpha/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/OriAlpha/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/OriAlpha/subscriptions",
            "organizations_url": "https://api.github.com/users/OriAlpha/orgs",
            "repos_url": "https://api.github.com/users/OriAlpha/repos",
            "events_url": "https://api.github.com/users/OriAlpha/events{/privacy}",
            "received_events_url": "https://api.github.com/users/OriAlpha/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-08-10T07:27:24Z",
        "updated_at": "2022-08-11T10:29:46Z",
        "author_association": "NONE",
        "body": "ok, i modified the class as (i.e., onnxruntime/onnxruntime/python/tools/transformers/gpt2_helper.py)\r\n\r\n```\r\nclass MyGPT2LMHeadModel(GPT2LMHeadModel):\r\n    \"\"\"Here we wrap a class for Onnx model conversion for GPT2LMHeadModel with past state.\"\"\"\r\n\r\n    def __init__(self, config):\r\n        super().__init__(config)\r\n\r\n    def forward(self, labels, input_ids, position_ids, attention_mask, *past):\r\n    #def forward(self, labels, input_ids, position_ids, attention_mask, *past):\r\n        result = super().forward(\r\n            input_ids,\r\n            position_ids=position_ids,\r\n            attention_mask=attention_mask,\r\n            past_key_values=past,\r\n            return_dict=False,\r\n        )\r\n        loss = get_loss(result)\r\n\r\n        return MyGPT2Model.post_process(loss, result, self.config.n_layer)\r\n        #return MyGPT2Model.post_process(loss, result, self.config.n_layer)\r\n```\r\nBut still its same issue?? Do i have to import get_loss() function or recreate from transformers??\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1210271383/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1212460178",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/12526#issuecomment-1212460178",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/12526",
        "id": 1212460178,
        "node_id": "IC_kwDOCVq1mM5IRKyS",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-08-11T20:25:55Z",
        "updated_at": "2022-08-11T20:26:57Z",
        "author_association": "MEMBER",
        "body": "@OriAlpha, see the related code:\r\nhttps://github.com/huggingface/transformers/blob/8cf4a6f0a63ed3aeed68192a9304fed2bd0ce100/src/transformers/models/gpt2/modeling_gpt2.py#L1096-L1107\r\nThe first tuple is the loss. So we can `def get_loss(result): return result[0]`\r\n\r\nIf you use return_dict=True, the result contains a field called loss.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1212460178/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1212474281",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/12526#issuecomment-1212474281",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/12526",
        "id": 1212474281,
        "node_id": "IC_kwDOCVq1mM5IROOp",
        "user": {
            "login": "OriAlpha",
            "id": 41699212,
            "node_id": "MDQ6VXNlcjQxNjk5MjEy",
            "avatar_url": "https://avatars.githubusercontent.com/u/41699212?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/OriAlpha",
            "html_url": "https://github.com/OriAlpha",
            "followers_url": "https://api.github.com/users/OriAlpha/followers",
            "following_url": "https://api.github.com/users/OriAlpha/following{/other_user}",
            "gists_url": "https://api.github.com/users/OriAlpha/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/OriAlpha/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/OriAlpha/subscriptions",
            "organizations_url": "https://api.github.com/users/OriAlpha/orgs",
            "repos_url": "https://api.github.com/users/OriAlpha/repos",
            "events_url": "https://api.github.com/users/OriAlpha/events{/privacy}",
            "received_events_url": "https://api.github.com/users/OriAlpha/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-08-11T20:43:30Z",
        "updated_at": "2022-08-11T21:25:02Z",
        "author_association": "NONE",
        "body": "yes, but i need to import into onnxruntime this loss behaviour as i mentioned above?? @tianleiwu \r\ndo i need to edit function in gpt2_beamsearch_helper.py or gpt2_helper.py, i am bit confused now",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1212474281/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1216208007",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/12526#issuecomment-1216208007",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/12526",
        "id": 1216208007,
        "node_id": "IC_kwDOCVq1mM5IfdyH",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-08-16T06:38:26Z",
        "updated_at": "2022-08-16T06:38:26Z",
        "author_association": "MEMBER",
        "body": "@OriAlpha, you will need other changes: For example, create dummy inputs need a real tensor for labels. Need add dynamic axes setting for labels and loss. If you are familiar with torch.onnx.export, it is not hard. You can modify those in gpt2_helper.py (For each place of input_ids, you might need add similar logic for labels input; for each place of logits output, you might need add similar logic for loss output).",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1216208007/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1221579137",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/12526#issuecomment-1221579137",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/12526",
        "id": 1221579137,
        "node_id": "IC_kwDOCVq1mM5Iz9GB",
        "user": {
            "login": "OriAlpha",
            "id": 41699212,
            "node_id": "MDQ6VXNlcjQxNjk5MjEy",
            "avatar_url": "https://avatars.githubusercontent.com/u/41699212?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/OriAlpha",
            "html_url": "https://github.com/OriAlpha",
            "followers_url": "https://api.github.com/users/OriAlpha/followers",
            "following_url": "https://api.github.com/users/OriAlpha/following{/other_user}",
            "gists_url": "https://api.github.com/users/OriAlpha/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/OriAlpha/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/OriAlpha/subscriptions",
            "organizations_url": "https://api.github.com/users/OriAlpha/orgs",
            "repos_url": "https://api.github.com/users/OriAlpha/repos",
            "events_url": "https://api.github.com/users/OriAlpha/events{/privacy}",
            "received_events_url": "https://api.github.com/users/OriAlpha/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-08-21T16:33:31Z",
        "updated_at": "2022-08-21T16:33:31Z",
        "author_association": "NONE",
        "body": "If possible could @tianleiwu provide a code snippet??, regrading computing loss. ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1221579137/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]