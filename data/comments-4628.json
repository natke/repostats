[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/664719672",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4628#issuecomment-664719672",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4628",
        "id": 664719672,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2NDcxOTY3Mg==",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-07-28T01:15:46Z",
        "updated_at": "2020-07-28T01:15:46Z",
        "author_association": "MEMBER",
        "body": "Is the assertion that GRU is incorrect based on the actual predictions or purely the diff? \r\n\r\nGRU involves a lot of matrix multiplications, so with longer sequence lengths the accumulated floating point inaccuracy will result in larger diffs. The order of operations and the instructions used to execute them (e.g. which AVX instructions if any are used) will be different between numpy and ORT, so this is expected. \r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/664719672/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/664759762",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4628#issuecomment-664759762",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4628",
        "id": 664759762,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2NDc1OTc2Mg==",
        "user": {
            "login": "Channingss",
            "id": 12471701,
            "node_id": "MDQ6VXNlcjEyNDcxNzAx",
            "avatar_url": "https://avatars.githubusercontent.com/u/12471701?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Channingss",
            "html_url": "https://github.com/Channingss",
            "followers_url": "https://api.github.com/users/Channingss/followers",
            "following_url": "https://api.github.com/users/Channingss/following{/other_user}",
            "gists_url": "https://api.github.com/users/Channingss/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Channingss/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Channingss/subscriptions",
            "organizations_url": "https://api.github.com/users/Channingss/orgs",
            "repos_url": "https://api.github.com/users/Channingss/repos",
            "events_url": "https://api.github.com/users/Channingss/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Channingss/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-07-28T03:48:59Z",
        "updated_at": "2020-07-28T06:30:54Z",
        "author_association": "NONE",
        "body": "@skottmckay there are no incorrect reported when predicted by ORT.\r\nCan you describe more detail of the different between numpy and ORT，matrix multiplication of np.dot(x, gates_w)？\r\nthanks! \r\n\r\nNotice: When input shape become bigger,  and there are only positive or negative numbers in ’X‘ or 'W',  ORT result close to Numpy, the difference happened  when both positive or negative numbers in ’X‘ or 'W'.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/664759762/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665362640",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4628#issuecomment-665362640",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4628",
        "id": 665362640,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTM2MjY0MA==",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-07-29T00:30:11Z",
        "updated_at": "2020-07-29T00:30:11Z",
        "author_association": "MEMBER",
        "body": "See https://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html\r\n\r\nDepending on the order of the operations different types of inaccuracies may be introduced. A matrix multiplication involves a collection of operations that can be done independently to produce the output matrix. e.g. for each output value there are a collection of multiplications and additions between a row from one matrix and a column from the other. Depending on the order those are done in you will get a slightly different floating point value. Depending on the instructions used some may be done in a single instruction, and some may require multiple. Unless ORT and Numpy did them in exactly the same order using exactly the same instructions you will get differences.\r\n\r\nWhen the input shape becomes larger there are more steps in the GRU calculations, so any diff will grow with each step. How are you defining 'close' to Numpy?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665362640/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665392752",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4628#issuecomment-665392752",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4628",
        "id": 665392752,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTM5Mjc1Mg==",
        "user": {
            "login": "Channingss",
            "id": 12471701,
            "node_id": "MDQ6VXNlcjEyNDcxNzAx",
            "avatar_url": "https://avatars.githubusercontent.com/u/12471701?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Channingss",
            "html_url": "https://github.com/Channingss",
            "followers_url": "https://api.github.com/users/Channingss/followers",
            "following_url": "https://api.github.com/users/Channingss/following{/other_user}",
            "gists_url": "https://api.github.com/users/Channingss/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Channingss/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Channingss/subscriptions",
            "organizations_url": "https://api.github.com/users/Channingss/orgs",
            "repos_url": "https://api.github.com/users/Channingss/repos",
            "events_url": "https://api.github.com/users/Channingss/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Channingss/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-07-29T02:24:30Z",
        "updated_at": "2020-07-29T02:25:04Z",
        "author_association": "NONE",
        "body": "@skottmckay \r\n'close to Numpy' means diff should small than 10e-4 or smaller, I calculate  the diff between numpy and ORT by code mentioned above:\r\n```\r\ndiff = output_numpy - output_onnx\r\nprint('max absolute diff: ', np.max(np.fabs(diff)))\r\n```\r\n\r\nthe input data:\r\n```\r\ninput_size = 512\r\nhidden_size = 128\r\nweight_scale = 0.1\r\nnumber_of_gates = 3\r\nnum_direct = 1\r\nseq_len = 10\r\nbatch_size = 10\r\ninput = np.random.random((seq_len, batch_size , input_size)).astype(np.float32) - 0.5\r\nW = weight_scale * np.random.random((num_direct, number_of_gates * hidden_size, input_size)).astype(np.float32)\r\nR = weight_scale * np.random.random((num_direct, number_of_gates * hidden_size, hidden_size)).astype(np.float32)\r\nB = weight_scale * np.random.random((num_direct, 2*number_of_gates * hidden_size)).astype(np.float32)\r\n```\r\n\r\nMore steps in the GRU calculations, so any diff will grow with each step, but the difference is too large, which is expected? and when i make input shape larger, the diff become more larger.\r\n\r\n![image](https://user-images.githubusercontent.com/12471701/88748226-10bd8c00-d183-11ea-9951-ad9b79ba75c2.png)\r\n\r\nNotice: When input shape become bigger, and there are only positive or negative numbers in ’X‘ or 'W',  the diff  between ORT numpy small than 10e-4. the large difference happened when both positive or negative numbers in ’X‘ or 'W'. \r\n\r\n      ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665392752/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665446191",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4628#issuecomment-665446191",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4628",
        "id": 665446191,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTQ0NjE5MQ==",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-07-29T05:48:25Z",
        "updated_at": "2020-07-29T05:48:25Z",
        "author_association": "MEMBER",
        "body": "For each step of GRU the previous output value is an input (the H_t value in the python GRU_Helper.step function). Due to that the potential growth of the diff is relative to the number of steps. \r\n\r\nSay each step had a potential diff of 10e-5. If you did 10 steps that may add up to a 10e-4.  Also keep in mind there are multiple matrix multiplications per step (I count 6 calls to numpy.dot in the python code). There are a lot of floating point operations going on here. \r\n\r\nI don't believe you can choose an arbitrary value like 10e-4 and deem any diff larger than that to be 'incorrect' due to this. That value should be reasonable for a single step though. \r\n\r\nYou're also assuming the numpy value is the ground truth but there's no 100% accurate value due to floating point numbers not having 100% precision. Just because the value is different to numpy doesn't necessarily make it incorrect. \r\n\r\nIf you want smaller diffs you could change your model to use double instead of float. I wouldn't expect it would change correctness though.\r\n\r\nIf you have only positive or only negative numbers you're always adding positive numbers when calculating each output (as it's (A0 x B0) + (A1 x B1) etc. etc., so whether A or B are both positive or both negative doesn't matter as the product of the two will be positive . If one of A and B is negative than the multiplication yields a negative value and you may now be subtracting when accumulating the products bringing into play things like subtractive cancellation. I would expect doing something like generating random data in a range of 0..1 and arbitrarily shifting it into a range of -0.5..0.5 is just increasing the chance of inaccuracies due to how floating point numbers behave. ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665446191/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665485717",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4628#issuecomment-665485717",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4628",
        "id": 665485717,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTQ4NTcxNw==",
        "user": {
            "login": "Channingss",
            "id": 12471701,
            "node_id": "MDQ6VXNlcjEyNDcxNzAx",
            "avatar_url": "https://avatars.githubusercontent.com/u/12471701?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Channingss",
            "html_url": "https://github.com/Channingss",
            "followers_url": "https://api.github.com/users/Channingss/followers",
            "following_url": "https://api.github.com/users/Channingss/following{/other_user}",
            "gists_url": "https://api.github.com/users/Channingss/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Channingss/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Channingss/subscriptions",
            "organizations_url": "https://api.github.com/users/Channingss/orgs",
            "repos_url": "https://api.github.com/users/Channingss/repos",
            "events_url": "https://api.github.com/users/Channingss/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Channingss/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-07-29T07:26:04Z",
        "updated_at": "2020-07-29T07:26:04Z",
        "author_association": "NONE",
        "body": "@skottmckay thanks for your reply, the numpy calculate process i used to compare, which come from test module(https://github.com/microsoft/onnxruntime/blob/99415f09fe86c4e078147c1130088facd93360b5/onnxruntime/test/providers/cpu/rnn/GRU.py#L144). From your description, can I see that the calculation order of test module(numpy) is inconsistent with onnruntime?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665485717/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665493271",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4628#issuecomment-665493271",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4628",
        "id": 665493271,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTQ5MzI3MQ==",
        "user": {
            "login": "skottmckay",
            "id": 979079,
            "node_id": "MDQ6VXNlcjk3OTA3OQ==",
            "avatar_url": "https://avatars.githubusercontent.com/u/979079?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/skottmckay",
            "html_url": "https://github.com/skottmckay",
            "followers_url": "https://api.github.com/users/skottmckay/followers",
            "following_url": "https://api.github.com/users/skottmckay/following{/other_user}",
            "gists_url": "https://api.github.com/users/skottmckay/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/skottmckay/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/skottmckay/subscriptions",
            "organizations_url": "https://api.github.com/users/skottmckay/orgs",
            "repos_url": "https://api.github.com/users/skottmckay/repos",
            "events_url": "https://api.github.com/users/skottmckay/events{/privacy}",
            "received_events_url": "https://api.github.com/users/skottmckay/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-07-29T07:41:56Z",
        "updated_at": "2020-07-29T07:41:56Z",
        "author_association": "MEMBER",
        "body": "I would expect the difference is primarily within the implementation of the matrix multiplication and not at the level you see in the python code. There are many potential optimizations to improve matrix multiplication performance. e.g. http://en.wikipedia.org/wiki/Loop_tiling. Depending on which options are used including how/when they are parallelized the order that different calculations happen in will differ. The MLAS library in ORT has different optimizations depending on the instructions available on the machine (e.g. if AVX512 is available different instructions will be used than when it is not). Unless all that matched the internal implementation of numpy.dot exactly you will see diffs.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/665493271/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/667021049",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4628#issuecomment-667021049",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4628",
        "id": 667021049,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzAyMTA0OQ==",
        "user": {
            "login": "Channingss",
            "id": 12471701,
            "node_id": "MDQ6VXNlcjEyNDcxNzAx",
            "avatar_url": "https://avatars.githubusercontent.com/u/12471701?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Channingss",
            "html_url": "https://github.com/Channingss",
            "followers_url": "https://api.github.com/users/Channingss/followers",
            "following_url": "https://api.github.com/users/Channingss/following{/other_user}",
            "gists_url": "https://api.github.com/users/Channingss/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Channingss/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Channingss/subscriptions",
            "organizations_url": "https://api.github.com/users/Channingss/orgs",
            "repos_url": "https://api.github.com/users/Channingss/repos",
            "events_url": "https://api.github.com/users/Channingss/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Channingss/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-07-31T09:10:31Z",
        "updated_at": "2020-07-31T09:10:31Z",
        "author_association": "NONE",
        "body": " @skottmckay  thanks for your reply",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/667021049/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]