[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1470357784",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15063#issuecomment-1470357784",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15063",
        "id": 1470357784,
        "node_id": "IC_kwDOCVq1mM5Xo-EY",
        "user": {
            "login": "fxmarty",
            "id": 9808326,
            "node_id": "MDQ6VXNlcjk4MDgzMjY=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9808326?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/fxmarty",
            "html_url": "https://github.com/fxmarty",
            "followers_url": "https://api.github.com/users/fxmarty/followers",
            "following_url": "https://api.github.com/users/fxmarty/following{/other_user}",
            "gists_url": "https://api.github.com/users/fxmarty/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/fxmarty/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/fxmarty/subscriptions",
            "organizations_url": "https://api.github.com/users/fxmarty/orgs",
            "repos_url": "https://api.github.com/users/fxmarty/repos",
            "events_url": "https://api.github.com/users/fxmarty/events{/privacy}",
            "received_events_url": "https://api.github.com/users/fxmarty/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-15T16:28:56Z",
        "updated_at": "2023-03-15T16:28:56Z",
        "author_association": "CONTRIBUTOR",
        "body": "Shouldn't it be here https://github.com/microsoft/onnxruntime/blob/32533dd1c290aa6025c584a705d3fa00fde1cd0a/onnxruntime/python/tools/transformers/onnx_model.py#L621\r\n\r\nrather\r\n\r\n```python\r\nparameters = {\"disable_shape_infer\": not use_symbolic_shape_infer}\r\n```\r\n\r\n?\r\n\r\ncc @tianleiwu @yufenglee\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1470357784/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1470448871",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15063#issuecomment-1470448871",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15063",
        "id": 1470448871,
        "node_id": "IC_kwDOCVq1mM5XpUTn",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-15T17:23:20Z",
        "updated_at": "2023-03-15T21:53:50Z",
        "author_association": "MEMBER",
        "body": "@fxmarty, fp16 conversion need data type information, which can be provided by either onnx shape inference if model is not optimized, or symbolic shape inference after model is optimized. The logic `{\"disable_shape_infer\": use_symbolic_shape_infer}` is good, which means we can disable onnx shape inference if OnnxModel has done symbolic shape inference at that time.\r\n\r\nA walkaround is to use symbolic shape inference.\r\n\r\nPossible changes to handle this:\r\n(1) change https://github.com/microsoft/onnxruntime/blob/32533dd1c290aa6025c584a705d3fa00fde1cd0a/onnxruntime/python/tools/transformers/float16.py to call onnx.shape_inference.infer_shapes_path\r\n(2) add another option to let use provide an example input for type inference: use ORT to run inference then record the data type of intermediate outputs.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1470448871/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1471524399",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15063#issuecomment-1471524399",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15063",
        "id": 1471524399,
        "node_id": "IC_kwDOCVq1mM5Xta4v",
        "user": {
            "login": "fxmarty",
            "id": 9808326,
            "node_id": "MDQ6VXNlcjk4MDgzMjY=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9808326?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/fxmarty",
            "html_url": "https://github.com/fxmarty",
            "followers_url": "https://api.github.com/users/fxmarty/followers",
            "following_url": "https://api.github.com/users/fxmarty/following{/other_user}",
            "gists_url": "https://api.github.com/users/fxmarty/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/fxmarty/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/fxmarty/subscriptions",
            "organizations_url": "https://api.github.com/users/fxmarty/orgs",
            "repos_url": "https://api.github.com/users/fxmarty/repos",
            "events_url": "https://api.github.com/users/fxmarty/events{/privacy}",
            "received_events_url": "https://api.github.com/users/fxmarty/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-16T08:36:51Z",
        "updated_at": "2023-03-16T08:48:17Z",
        "author_association": "CONTRIBUTOR",
        "body": "Thank you @tianleiwu for your quick answer and fix, I got confused and now understand there is shape inference from ONNX, and symbolic shape inference from ORT which probably do the same thing, just that ORT symbolic shape inference supports custom ops from ORT.\r\n\r\nI see you've went for option 1 as in https://github.com/microsoft/onnxruntime/pull/11106.\r\n\r\nFor option 2, what would it look like, or do you have an example? Is ORT symbolic shape inference done automatically during inference by ORT or would you need manual hack (like outputting all intermediate results and recording shapes/dtype?)?\r\n\r\nBy default, I am always passing `use_symbolic_shape_infer=False` as I often run into `Incomplete shape inference` error otherwise. As I understand, this results is the use of `onnx.shape_inference.infer_shapes` in `convert_float_to_float16` instead of `SymbolicShapeInferenceHelper.infer_shapes`. However so far I have not hit the issue described in comments that motivate the use of `SymbolicShapeInferenceHelper.infer_shapes`:\r\n\r\n```\r\n# Use symbolic shape inference since custom operators (like Gelu, SkipLayerNormalization etc)\r\n# are not recognized by onnx shape inference.\r\n```\r\n\r\nSo I am as well a bit confused by why one would want to pass `use_symbolic_shape_infer=True`. For reference, my implementation is https://github.com/huggingface/optimum/blob/87129cba0959acdffca46cc8fe64e0a34ba88857/optimum/onnxruntime/optimization.py#L166-L181",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1471524399/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1472558751",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15063#issuecomment-1472558751",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15063",
        "id": 1472558751,
        "node_id": "IC_kwDOCVq1mM5XxXaf",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-16T18:43:11Z",
        "updated_at": "2023-03-16T18:43:11Z",
        "author_association": "MEMBER",
        "body": "@fxmarty, I recommend optimum using the default symbolic_shape_infer=True in https://github.com/microsoft/onnxruntime/blob/32533dd1c290aa6025c584a705d3fa00fde1cd0a/onnxruntime/python/tools/transformers/onnx_model.py#L586 since it is better to use symbolic shape inference instead of onnx shape inference for optimized model. \r\n\r\nThe pull request of 15067 is intended for non-optimized model (like CNN model where optimizations is optional).\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1472558751/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1473311987",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15063#issuecomment-1473311987",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15063",
        "id": 1473311987,
        "node_id": "IC_kwDOCVq1mM5X0PTz",
        "user": {
            "login": "fxmarty",
            "id": 9808326,
            "node_id": "MDQ6VXNlcjk4MDgzMjY=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9808326?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/fxmarty",
            "html_url": "https://github.com/fxmarty",
            "followers_url": "https://api.github.com/users/fxmarty/followers",
            "following_url": "https://api.github.com/users/fxmarty/following{/other_user}",
            "gists_url": "https://api.github.com/users/fxmarty/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/fxmarty/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/fxmarty/subscriptions",
            "organizations_url": "https://api.github.com/users/fxmarty/orgs",
            "repos_url": "https://api.github.com/users/fxmarty/repos",
            "events_url": "https://api.github.com/users/fxmarty/events{/privacy}",
            "received_events_url": "https://api.github.com/users/fxmarty/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-17T07:50:04Z",
        "updated_at": "2023-03-17T07:52:13Z",
        "author_association": "CONTRIBUTOR",
        "body": "Thank you. Unfortunately with this option I most often run into the Incomplete symbolic shape inference error, so I'm disabling it by default for now.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1473311987/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1476736845",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/15063#issuecomment-1476736845",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/15063",
        "id": 1476736845,
        "node_id": "IC_kwDOCVq1mM5YBTdN",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-20T18:28:47Z",
        "updated_at": "2023-03-20T18:28:47Z",
        "author_association": "MEMBER",
        "body": "I could add an option to use ORT to run inference then record data type later. That could avoid shape inference in fp16 conversion.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1476736845/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]